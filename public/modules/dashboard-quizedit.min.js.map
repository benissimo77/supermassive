{"version":3,"file":"dashboard-quizedit.min.js","sources":["../../src/host/FileDropzone.js","../../src/host/ImageLibrary.js","../../src/ImageSelector.js","../../src/host/dashboard-quizedit.js"],"sourcesContent":["// FileDropzone.js\r\nexport class FileDropzone {\r\n  constructor(options) {\r\n    this.options = {\r\n      element: null,              // DOM element or selector\r\n      accept: '*/*',              // File types to accept\r\n      multiple: false,            // Allow multiple files\r\n      maxSize: 10 * 1024 * 1024,  // Default max size (10MB)\r\n      onDrop: null,               // Callback when files are dropped\r\n      onError: null,              // Callback when an error occurs\r\n      hoverClass: 'dropzone-hover',\r\n      ...options\r\n    };\r\n    \r\n    this.element = typeof this.options.element === 'string' \r\n      ? document.querySelector(this.options.element)\r\n      : this.options.element;\r\n      \r\n    if (!this.element) {\r\n      console.error('Dropzone element not found');\r\n      return;\r\n    }\r\n    \r\n    this.fileInput = this.element.querySelector('input[type=\"file\"]');\r\n    if (!this.fileInput) {\r\n      this.fileInput = document.createElement('input');\r\n      this.fileInput.type = 'file';\r\n      this.fileInput.style.display = 'none';\r\n      this.element.appendChild(this.fileInput);\r\n    }\r\n    \r\n    this.fileInput.accept = this.options.accept;\r\n    this.fileInput.multiple = this.options.multiple;\r\n    \r\n    this.init();\r\n  }\r\n  \r\n  init() {\r\n    // Add click handler to open file picker\r\n    this.element.addEventListener('click', (e) => {\r\n      if (e.target !== this.fileInput) {\r\n        this.fileInput.click();\r\n      }\r\n    });\r\n    \r\n    // Handle file selection via input\r\n    this.fileInput.addEventListener('change', (e) => {\r\n      this.handleFiles(this.fileInput.files);\r\n    });\r\n    \r\n    // Handle drag events\r\n    this.element.addEventListener('dragover', (e) => {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n      this.element.classList.add(this.options.hoverClass);\r\n    });\r\n    \r\n    this.element.addEventListener('dragleave', (e) => {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n      this.element.classList.remove(this.options.hoverClass);\r\n    });\r\n    \r\n    this.element.addEventListener('drop', (e) => {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n      this.element.classList.remove(this.options.hoverClass);\r\n      \r\n      if (e.dataTransfer.files.length > 0) {\r\n        this.handleFiles(e.dataTransfer.files);\r\n      }\r\n    });\r\n  }\r\n  \r\n  handleFiles(files) {\r\n    if (files.length === 0) return;\r\n    \r\n    // Validate files\r\n    const validFiles = Array.from(files).filter(file => {\r\n      // Check file size\r\n      if (file.size > this.options.maxSize) {\r\n        this.triggerError(`File too large: ${file.name}`);\r\n        return false;\r\n      }\r\n      \r\n      // Check file type if accept is specified\r\n      if (this.options.accept !== '*/*') {\r\n        const acceptTypes = this.options.accept.split(',').map(type => type.trim());\r\n        const fileType = file.type;\r\n        const fileExtension = '.' + file.name.split('.').pop();\r\n        \r\n        // Check if file type or extension matches accept types\r\n        const isValid = acceptTypes.some(type => {\r\n          if (type.startsWith('.')) {\r\n            return fileExtension.toLowerCase() === type.toLowerCase();\r\n          } else if (type.endsWith('/*')) {\r\n            const typeGroup = type.split('/')[0];\r\n            return fileType.startsWith(typeGroup + '/');\r\n          } else {\r\n            return fileType === type;\r\n          }\r\n        });\r\n        \r\n        if (!isValid) {\r\n          this.triggerError(`File type not accepted: ${file.name}`);\r\n          return false;\r\n        }\r\n      }\r\n      \r\n      return true;\r\n    });\r\n    \r\n    if (validFiles.length > 0) {\r\n      if (this.options.onDrop) {\r\n        this.options.onDrop(validFiles, this.element);\r\n      }\r\n    }\r\n    \r\n    // Reset file input\r\n    this.fileInput.value = '';\r\n  }\r\n  \r\n  triggerError(message) {\r\n    if (this.options.onError) {\r\n      this.options.onError(message);\r\n    } else {\r\n      console.error(message);\r\n    }\r\n  }\r\n}","import { FileDropzone } from \"./FileDropzone\";\r\n\r\nexport class ImageLibrary {\r\n  constructor(options = {}) {\r\n    this.options = {\r\n      onSelect: null,  // Callback when image is selected\r\n      modalTitle: 'Image Library',\r\n      ...options\r\n    };\r\n\r\n    this.selectedImage = null;\r\n    \r\n    // Create modal element (initially hidden)\r\n    this.createModal();\r\n  }\r\n\r\n  createModal() {\r\n    // Create modal structure\r\n    this.modal = document.createElement('div');\r\n    this.modal.className = 'image-selector-modal';\r\n    this.modal.innerHTML = `\r\n      <div class=\"modal-content\">\r\n        <div class=\"modal-header\">\r\n          <h2>${this.options.modalTitle}</h2>\r\n          <button class=\"close-modal\">&times;</button>\r\n        </div>\r\n        <div class=\"modal-body\">\r\n          <div class=\"image-library-container\">\r\n            <div class=\"images-grid\">\r\n              <!-- Images will be loaded here -->\r\n              <p class=\"loading-message\">Loading images...</p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n        <div class=\"modal-footer\">\r\n            <div class=\"upload-container\">\r\n              <h3>Add a new image</h3>\r\n              <div class=\"dropzone\" id=\"modal-dropzone\">\r\n                <p>Drop image here or click to select</p>\r\n                <input type=\"file\" style=\"display: none;\" accept=\"image/*\">\r\n              </div>\r\n            </div>\r\n        </div>\r\n      </div>\r\n    `;\r\n\r\n    document.body.appendChild(this.modal);\r\n\r\n    // Initialize event listeners\r\n    this.initEventListeners();\r\n\r\n    // Initialize dropzone\r\n    this.initDropzone();\r\n  }\r\n\r\n\r\n  initEventListeners() {\r\n    // Close button\r\n    this.modal.querySelector('.close-modal').addEventListener('click', () => this.close());\r\n\r\n    // Image selection - clicking an image automatically selects and closes\r\n    this.modal.querySelector('.images-grid').addEventListener('click', (e) => {\r\n      const imageItem = e.target.closest('.image-item');\r\n      if (imageItem) {\r\n        // Store selected image data\r\n        this.selectedImage = {\r\n          id: imageItem.dataset.id,\r\n          url: imageItem.dataset.url\r\n        };\r\n\r\n        // Call the onSelect callback with the image data\r\n        if (this.options.onSelect) {\r\n          this.options.onSelect(this.selectedImage);\r\n        }\r\n        \r\n        // Close the modal\r\n        this.close();\r\n      }\r\n    });\r\n  }\r\n\r\n  initDropzone() {\r\n    // Initialize dropzone using your FileDropzone component\r\n    new FileDropzone({\r\n      element: this.modal.querySelector('#modal-dropzone'),\r\n      accept: 'image/*',\r\n      onDrop: (files) => {\r\n        if (files.length > 0) {\r\n          this.uploadImage(files[0]);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  show() {\r\n    // Make modal visible\r\n    this.modal.style.display = 'flex';\r\n\r\n    // Load images\r\n    this.loadImages();\r\n  }\r\n\r\n  close() {\r\n    this.modal.style.display = 'none';\r\n    this.selectedImage = null;\r\n  }\r\n\r\n  async loadImages() {\r\n    try {\r\n      const grid = this.modal.querySelector('.images-grid');\r\n      grid.innerHTML = '<p class=\"loading-message\">Loading images...</p>';\r\n      \r\n      const response = await fetch('/api/image/library');\r\n      const result = await response.json();\r\n\r\n      if (result.success) {\r\n        this.renderImages(result.data);\r\n      } else {\r\n        console.error('Error loading images:', result.message);\r\n        grid.innerHTML = '<p class=\"no-images\">Error loading images</p>';\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading images:', error);\r\n      this.modal.querySelector('.images-grid').innerHTML = \r\n        '<p class=\"no-images\">Error loading images</p>';\r\n    }\r\n  }\r\n\r\n  // Add this to the renderImages method\r\nrenderImages(images) {\r\n  const grid = this.modal.querySelector('.images-grid');\r\n  grid.innerHTML = '';\r\n\r\n  if (images.length === 0) {\r\n    grid.innerHTML = '<p class=\"no-images\">No images found. Add your first image below.</p>';\r\n    return;\r\n  }\r\n\r\n  images.forEach(image => {\r\n    const item = document.createElement('div');\r\n    item.className = 'image-item';\r\n    item.dataset.id = image._id;\r\n    item.dataset.url = image.url;\r\n\r\n    item.innerHTML = `\r\n      <div class=\"image-preview\">\r\n        <img src=\"${image.url}\" alt=\"${image.originalName || 'Image'}\">\r\n        <button class=\"delete-image-btn\" title=\"Delete image\">&times;</button>\r\n      </div>\r\n      <div class=\"image-info\">\r\n        <span class=\"image-name\">${image.originalName || 'Image'}</span>\r\n      </div>\r\n    `;\r\n\r\n    grid.appendChild(item);\r\n  });\r\n\r\n  // Add event listeners for delete buttons\r\n  grid.querySelectorAll('.delete-image-btn').forEach(btn => {\r\n    btn.addEventListener('click', (e) => {\r\n      e.stopPropagation(); // Prevent image selection when clicking delete\r\n      this.handleImageDelete(e.target.closest('.image-item').dataset.id);\r\n    });\r\n  });\r\n}\r\n\r\n// Add this new method to handle image deletion\r\nasync handleImageDelete(imageId) {\r\n  if (!confirm('Delete this image?')) {\r\n    return;\r\n  }\r\n  \r\n  try {\r\n    const response = await fetch(`/api/images/${imageId}`, {\r\n      method: 'DELETE'\r\n    });\r\n    \r\n    const result = await response.json();\r\n    \r\n    if (result.success) {\r\n      // Reload images to update the view\r\n      this.loadImages();\r\n    } else {\r\n      alert('Error deleting image: ' + result.message);\r\n    }\r\n  } catch (error) {\r\n    console.error('Error deleting image:', error);\r\n    alert('Error deleting image. Please try again.');\r\n  }\r\n}\r\n\r\n  async uploadImage(file) {\r\n    const formData = new FormData();\r\n    formData.append('image', file);\r\n    \r\n    try {\r\n      const grid = this.modal.querySelector('.images-grid');\r\n      const currentContent = grid.innerHTML;\r\n      grid.innerHTML = '<p class=\"loading-message\">Uploading image...</p>';\r\n      \r\n      const response = await fetch('/api/image/upload', {\r\n        method: 'POST',\r\n        body: formData\r\n      });\r\n\r\n      const result = await response.json();\r\n\r\n      if (result.success) {\r\n        // Reload images to show the new one\r\n        this.loadImages();\r\n      } else {\r\n        alert('Error uploading image: ' + result.message);\r\n        grid.innerHTML = currentContent; // Restore previous content\r\n      }\r\n    } catch (error) {\r\n      console.error('Error uploading image:', error);\r\n      alert('Error uploading image');\r\n      this.loadImages(); // Reload images to reset the view\r\n    }\r\n  }\r\n}","// ImageSelector.js\r\nexport class ImageSelector extends HTMLElement {\r\n    constructor() {\r\n        super();\r\n        // this.attachShadow({ mode: 'open' });\r\n        this._image = null;\r\n        this._canvas = null;\r\n        this._ctx = null;\r\n        this._isDrawing = false;\r\n        this._isMoving = false; // if panning then we don't want to register a click at the end\r\n        this._startX = 0;\r\n        this._startY = 0;\r\n        this._mode = 'hotspot'; // 'hotspot', 'rectangle' or 'disabled'\r\n        this._answer = null; // holds the normalized coords of an answer if provided\r\n        this._src = false;   // cache the image src ready for when element is connected to DOM\r\n        this._connected = false; // flag to check if element is connected to DOM\r\n        this._resizeObserver = new ResizeObserver(this._handleResize.bind(this));\r\n\r\n        // Add new properties for zoom\r\n        this._scale = 1;\r\n        this._offsetX = 0;\r\n        this._offsetY = 0;\r\n    }\r\n\r\n    static get observedAttributes() {\r\n        return ['src', 'mode', 'answer'];\r\n    }\r\n\r\n    connectedCallback() {\r\n        console.log('image-selector: connected:', this.isConnected);\r\n        this._connected = true;\r\n        this.render();\r\n        this.setupCanvas();\r\n        this._resizeObserver.observe(this);\r\n        this.setupEventListeners();\r\n        // Set a default size if not specified by the parent\r\n        // if (!this.style.width) {\r\n        //     console.log('connectedCallback - no style.width:');\r\n        //     this.style.width = '100%';\r\n        // }\r\n        // if (!this.style.height) this.style.height = '100vh'; // You can adjust this default\r\n    }\r\n\r\n    disconnectedCallback() {\r\n        this._resizeObserver.unobserve(this);\r\n        this._connected = false;\r\n    }\r\n\r\n    attributeChangedCallback(name, oldValue, newValue) {\r\n        if (oldValue === newValue) return;\r\n\r\n        switch (name) {\r\n            case 'src':\r\n                this.setImage(newValue);\r\n                break;\r\n            case 'mode':\r\n                this._mode = newValue;\r\n                break;\r\n            case 'answer':\r\n                // this._answer stores the normalized coords since we might not have the image size \r\n                console.log('attributeChangedCallback:: answer:', JSON.parse(newValue));\r\n                this._answer = JSON.parse(newValue);\r\n                this._redrawCanvas();\r\n                break;\r\n        }\r\n    }\r\n\r\n    render() {\r\n        this.innerHTML = `\r\n            <style>\r\n                .container {\r\n                    position: relative;\r\n                    min-width: 100%;\r\n                    min-height: 100%; /* Full height of the parent container */\r\n                    overflow: hidden;\r\n                }\r\n                #image-selector-image {\r\n                    position: absolute; /* Position the image absolutely */\r\n                    top: 0;\r\n                    left: 0;\r\n                    width: 100%; /* Full width of the parent container */\r\n                    display: block; /* Remove inline spacing */\r\n                }\r\n                canvas {\r\n                    position: absolute;\r\n                    top: 0;\r\n                    left: 0;\r\n                    // border:1px solid yellow;\r\n                    pointer-events: none;\r\n                }\r\n                img.hotspot { cursor: crosshair; }\r\n                img.rectangle { cursor: crosshair; }\r\n                img.disabled { cursor: default; }\r\n\r\n            </style>\r\n            <div class=\"container\">\r\n                <img id=\"image-selector-image\" src=\"${this.getAttribute('src')}\" draggable=\"false\">\r\n                <canvas></canvas>\r\n            </div>\r\n        `;\r\n    }\r\n\r\n    setupCanvas() {\r\n        this._image = this.querySelector('img');\r\n        this._canvas = this.querySelector('canvas');\r\n        this._ctx = this._canvas.getContext('2d');\r\n\r\n        // Redraw the canvas and image when the image loads\r\n        this._image.onload = () => {\r\n            // Calculate the aspect ratio\r\n            const imageAspectRatio = this._image.naturalWidth / this._image.naturalHeight;\r\n            const containerWidth = this._image.parentElement.clientWidth;\r\n            const containerHeight = this._image.parentElement.clientHeight;\r\n\r\n            // Calculate the dimensions of the image based on the container size\r\n            let imageWidth, imageHeight;\r\n\r\n            if (containerWidth / containerHeight > imageAspectRatio) {\r\n                // Container is wider than the image aspect ratio\r\n                imageWidth = containerHeight * imageAspectRatio;\r\n                imageHeight = containerHeight;\r\n            } else {\r\n                // Container is taller than the image aspect ratio\r\n                imageWidth = containerWidth;\r\n                imageHeight = containerWidth / imageAspectRatio;\r\n            }\r\n\r\n            // Set the image size and position\r\n            this._image.width = imageWidth;\r\n            this._image.height = imageHeight;\r\n            this._image.style.left = `${(containerWidth - imageWidth) / 2}px`;\r\n            this._image.style.top = `${(containerHeight - imageHeight) / 2}px`;\r\n\r\n            // Set the canvas size to match the image size\r\n            this._canvas.width = imageWidth;\r\n            this._canvas.height = imageHeight;\r\n            this._adjustCanvasSize();\r\n\r\n            // Center the canvas in the container\r\n            this._canvas.style.left = `${(containerWidth - imageWidth) / 2}px`;\r\n            this._canvas.style.top = `${(containerHeight - imageHeight) / 2}px`;\r\n        };\r\n    }\r\n\r\n    setupEventListeners() {\r\n        if (this._mode === 'disabled') return;\r\n        this._image.addEventListener('pointerdown', this.handlePointerDown.bind(this));\r\n        this._image.addEventListener('pointermove', this.handlePointerMove.bind(this));\r\n        this._image.addEventListener('pointerup', this.handlePointerUp.bind(this));\r\n        this._image.addEventListener('pointerleave', this.handlePointerUp.bind(this));\r\n        this._image.addEventListener('dragstart', (e) => e.preventDefault());\r\n\r\n        this._image.addEventListener('touchstart', this.handleTouchStart.bind(this));\r\n        // this._image.addEventListener('touchmove', this.handleTouchMove.bind(this));\r\n        this._image.addEventListener('touchend', this.handleTouchEnd.bind(this));\r\n\r\n        // Add wheel event listener\r\n        if (this._mode === 'hotspot') {\r\n            this._image.addEventListener('wheel', this.handleWheel.bind(this));    \r\n        }\r\n    }\r\n\r\n    handlePointerDown(event) {\r\n        event.preventDefault();\r\n        this._isDrawing = true;\r\n        this._isMoving = false;\r\n        const { x, y } = this.clientToCanvas(event.clientX, event.clientY);\r\n        // console.log('Pointer down', x, y, this._offsetX, this._offsetY );\r\n        this._startX = x;\r\n        this._startY = y;\r\n    }\r\n    handlePointerMove(event) {\r\n        if (this._touchStart) return;\r\n        if (!this._isDrawing) return;\r\n        this._isMoving = true;\r\n        event.preventDefault();\r\n\r\n        const { x, y } = this.clientToCanvas(event.clientX, event.clientY);\r\n\r\n        // Diff with startX and Y to see how far we've moved\r\n        const diffX = x - this._startX;\r\n        const diffY = y - this._startY;\r\n\r\n        // If question type is hotspot then we pan the image\r\n        // If question type is rectangle then we instead draw a rectangle\r\n        if (this._mode === 'hotspot') {\r\n            this._offsetX += diffX;\r\n            this._offsetY += diffY;\r\n            this.updateTransform();\r\n        } else {\r\n            this.drawRect(this._startX, this._startY, x - this._startX, y - this._startY);\r\n        }\r\n\r\n    }\r\n    handlePointerUp(event) {\r\n        if (!this._isDrawing) return;\r\n        this._isDrawing = false;\r\n        if (this._mode === 'hotspot' && this._isMoving) return;\r\n\r\n        event.preventDefault();\r\n        \r\n        const canvasPos = this.clientToCanvas(event.clientX, event.clientY);\r\n        const imagePos = this.clientToImage(event.clientX, event.clientY);\r\n        const containerPos = this.clientToContainer(event.clientX, event.clientY);\r\n\r\n        console.log('Pointer up:: canvasX, canvasY:', canvasPos.x, canvasPos.y);\r\n        console.log('Pointer up:: imageX, imageY:', imagePos.x, imagePos.y);\r\n        console.log('Pointer up:: containerX, containerY:', containerPos.x, containerPos.y);\r\n        console.log('Pointer up:: canvas width, height:', this._canvas.width, this._canvas.height);\r\n        // Updated code to handle additional scale/offset properties\r\n        // const x = (event.clientX - rect.left - this._offsetX) / this._scale;\r\n        // const y = (event.clientY - rect.top - this._offsetY) / this._scale;\r\n        // const x = (event.clientX - rect.left) - this._offsetX / this._scale;\r\n        // const y = (event.clientY - rect.top) - this._offsetY / this._scale;\r\n\r\n        // Set x and y to the correct values\r\n        const x = canvasPos.x;\r\n        const y = canvasPos.y;\r\n\r\n        if (this._mode === 'hotspot') {\r\n            this.drawCross(x, y);\r\n        }\r\n\r\n        // Dispatch event with the selection\r\n        let selection = this.canvasToNormalized( x, y );\r\n        if (this._mode === 'rectangle') {\r\n            const leftX = Math.min( this._startX, x );\r\n            const rightX = Math.max( this._startX, x );\r\n            const topY = Math.min( this._startY, y );\r\n            const bottomY = Math.max( this._startY, y );\r\n            selection = { start: this.canvasToNormalized( leftX, topY ), end: this.canvasToNormalized( rightX, bottomY ) }\r\n        } \r\n        this.dispatchEvent(new CustomEvent('selection', { detail: selection }));\r\n        console.log('event dispatched: selection:', selection);\r\n    }\r\n\r\n\r\n    handleTouchStart(event) {\r\n        event.preventDefault();\r\n        this._isDrawing = true;\r\n        if (event.touches.length === 2) {\r\n            this._touchStart = true;\r\n            this._lastTouchDistance = this.getTouchDistance(event.touches);\r\n            this._isMoving = false;\r\n            this._isDrawing = false;\r\n            this._isZooming = true;\r\n        } else if (event.touches.length === 1) {\r\n            this._isDrawing = true;\r\n            const touch = event.touches[0];\r\n            const { x, y } = this.clientToCanvas(touch.clientX, touch.clientY);\r\n            this._startX = x;\r\n            this._startY = y;\r\n        }\r\n    }\r\n    \r\n\r\n    handleTouchMove(event) {\r\n        if (!this._isDrawing) return;\r\n        event.preventDefault();\r\n    \r\n        if (event.touches.length === 2) {\r\n            // Zooming in creator mode\r\n            const currentDistance = this.getTouchDistance(event.touches);\r\n            const scaleDiff = currentDistance / this._lastTouchDistance;\r\n\r\n            // Get the midpoint of the two touches\r\n            const midX = (event.touches[0].clientX + event.touches[1].clientX) / 2;\r\n            const midY = (event.touches[0].clientY + event.touches[1].clientY) / 2;\r\n\r\n            // Get mouse position in image coordinates\r\n            const { x: mouseX, y: mouseY } = this.clientToCanvas(midX, midY);\r\n            const { x: containerX, y: containerY } = this.clientToContainer(midX, midY);\r\n    \r\n            // Calculate the new scale\r\n            const newScale = Math.max(1, Math.min(this._scale * scaleDiff, 4));\r\n\r\n            // Update scale\r\n            this._scale = 1;\r\n    \r\n            // Calculate the new offsets\r\n            this._offsetX = containerX - mouseX * newScale;\r\n            this._offsetY = containerY - mouseY * newScale;\r\n    \r\n            this.updateTransform();\r\n    \r\n            this._lastTouchDistance = currentDistance;\r\n\r\n        } else if (event.touches.length === 1) {\r\n\r\n            if (!this._isDrawing) return;\r\n\r\n            // Panning\r\n            const touch = event.touches[0];\r\n            const { x, y } = this.clientToCanvas(touch.clientX, touch.clientY);\r\n\r\n            // Diff with startX and Y to see how far we've moved\r\n            const diffX = x - this._startX;\r\n            const diffY = y - this._startY;\r\n\r\n            // If question type is hotspot then we pan the image\r\n            // If question type is rectangle then we instead draw a rectangle\r\n            if (this._mode === 'hotspot') {\r\n                this._offsetX += diffX;\r\n                this._offsetY += diffY;\r\n                this.updateTransform();\r\n            } else {\r\n                this.drawRect(this._startX, this._startY, x - this._startX, y - this._startY);\r\n            }\r\n        }\r\n    }\r\n    \r\n    handleTouchEnd(event) {\r\n        if (!this._isDrawing) return;\r\n        if (!this._isZooming) return;\r\n        event.preventDefault();\r\n        this._lastTouchDistance = null;\r\n        this._isDrawing = false;\r\n        if (event.touches.length === 1) {\r\n            this.handlePointerUp(event.touches[0]);\r\n        }\r\n    }\r\n\r\n    getTouchDistance(touches) {\r\n        return Math.hypot(\r\n            touches[0].clientX - touches[1].clientX,\r\n            touches[0].clientY - touches[1].clientY\r\n        );\r\n    }\r\n\r\n\r\n    drawRect(x1, y1, x2, y2) {\r\n        this._ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';\r\n        this._ctx.clearRect(0, 0, this._canvas.width, this._canvas.height);\r\n        this._ctx.fillRect(x1, y1, x2, y2);\r\n    }\r\n\r\n    drawCross(x, y) {\r\n        const crossSize = 10;\r\n        const lineWidth = 3;\r\n\r\n        console.log('drawCross:: x,y:', x, y, x-crossSize, y-crossSize, x+crossSize, y+crossSize);\r\n\r\n        this._ctx.clearRect(0, 0, this._canvas.width, this._canvas.height);\r\n        // Draw white background cross\r\n        this._ctx.strokeStyle = 'white';\r\n        this._ctx.lineWidth = lineWidth + 2;\r\n        this._ctx.beginPath();\r\n        this._ctx.moveTo(x - crossSize, y - crossSize);\r\n        this._ctx.lineTo(x + crossSize, y + crossSize);\r\n        this._ctx.moveTo(x - crossSize, y + crossSize);\r\n        this._ctx.lineTo(x + crossSize, y - crossSize);\r\n        this._ctx.stroke();\r\n        // Draw red foreground cross\r\n        this._ctx.strokeStyle = 'red';\r\n        this._ctx.lineWidth = lineWidth;\r\n        this._ctx.beginPath();\r\n        this._ctx.moveTo(x - crossSize, y - crossSize);\r\n        this._ctx.lineTo(x + crossSize, y + crossSize);\r\n        this._ctx.moveTo(x - crossSize, y + crossSize);\r\n        this._ctx.lineTo(x + crossSize, y - crossSize);\r\n        this._ctx.stroke();\r\n    }\r\n\r\n    handleWheel(event) {\r\n        event.preventDefault();\r\n        \r\n        // Get mouse position in image coordinates\r\n        const { x: mouseX, y: mouseY } = this.clientToCanvas(event.clientX, event.clientY);\r\n        const { x:containerX, y:containerY } = this.clientToContainer(event.clientX, event.clientY);\r\n\r\n        // console.log('handleWheel:: mouse x,y:', mouseX, mouseY);\r\n        // console.log('handleWheel:: container x,y:', containerX, containerY);\r\n        const zoomFactor = event.deltaY > 0 ? -0.5 : 0.5;\r\n        const newScale = Math.max(1, Math.min(this._scale + zoomFactor, 4));\r\n\r\n        // Update scale\r\n        this._scale = newScale;\r\n\r\n        // Calculate the new offsets - that took a while... :(\r\n        this._offsetX = containerX - mouseX * newScale;\r\n        this._offsetY = containerY - mouseY * newScale;\r\n\r\n        this.updateTransform();\r\n    }\r\n\r\n    updateTransform() {\r\n        const transform = `translate(${this._offsetX}px, ${this._offsetY}px) scale(${this._scale})`;\r\n        this._image.style.transform = transform;\r\n        this._canvas.style.transform = transform;\r\n    }\r\n\r\n\r\n    setImage(src) {\r\n        console.log('setImage:: src:', src);\r\n        this._src = src;\r\n        if (this._connected) {\r\n            console.log('this._connected - calling renderImage');\r\n            this.renderImage();\r\n        }\r\n    }\r\n    renderImage() {\r\n        this._image.src = this._src;\r\n        this._image.onload = () => {\r\n            this._adjustCanvasSize();\r\n        };\r\n        this.setCursorType();\r\n        this._adjustCanvasSize();\r\n    }\r\n\r\n    // This function is only called after the image has loaded\r\n    setCursorType() {\r\n        console.log('setCursorType:: this._mode:', this._mode);\r\n        this._image.classList.remove('hotspot', 'rectangle', 'disabled');\r\n        this._image.classList.add(this._mode);\r\n    }\r\n\r\n    _handleResize() {\r\n        if (this._image.complete) {\r\n            this._adjustCanvasSize();\r\n        }\r\n    }\r\n\r\n    _adjustCanvasSize() {\r\n        const rect = this._image.getBoundingClientRect();\r\n        const windowScale = 1;\r\n        console.log('_adjustCanvasSize:', rect, window.innerWidth/1920);\r\n        if (rect.width == 0 | rect.height == 0) {\r\n            return;\r\n        }\r\n        this._canvas.width = rect.width / windowScale;\r\n        this._canvas.height = rect.height / windowScale;\r\n        this._canvas.style.width = `${rect.width / windowScale}px`;\r\n        this._canvas.style.height = `${rect.height / windowScale }px`;\r\n        this._redrawCanvas();\r\n    }\r\n\r\n    _redrawCanvas() {\r\n        // Implement redrawing logic here\r\n        console.log('_redrawCanvas: width, height:', this._canvas.width, this._canvas.height, this._answer);\r\n        if (this._answer) {\r\n            if (this._mode === 'hotspot') {\r\n                const canvasPos = this.normalizedToCanvas(this._answer.x, this._answer.y);\r\n                this.drawCross(canvasPos.x, canvasPos.y);\r\n            }\r\n            if (this._mode === 'rectangle') {\r\n                const startCanvasPos = this.normalizedToCanvas(this._answer.start.x, this._answer.start.y);\r\n                const endCanvasPos = this.normalizedToCanvas(this._answer.end.x, this._answer.end.y);\r\n                this.drawRect(startCanvasPos.x, startCanvasPos.y, endCanvasPos.x - startCanvasPos.x, endCanvasPos.y - startCanvasPos.y);\r\n            }\r\n        }\r\n    }\r\n\r\n    // Conversion functions\r\n\r\n    // Verified\r\n    clientToImage(x, y) {\r\n        const rect = this._image.getBoundingClientRect();\r\n        const windowScale = 1;\r\n        return {\r\n            x: (x - rect.left) / windowScale,\r\n            y: (y - rect.top) / windowScale\r\n        };\r\n    }\r\n    clientToCanvas(x, y) {\r\n        const { x: imageX, y: imageY } = this.clientToImage(x, y);\r\n        return this.imageToCanvas(imageX, imageY);\r\n    }\r\n    // Verified\r\n    clientToContainer(clientX, clientY) {\r\n        const image = this.clientToImage(clientX, clientY);\r\n        return this.imageToContainer(image.x, image.y);\r\n    }\r\n    // To convert from image to canvas we just need to consider the scale\r\n    // Offset is already built into the translation of the image/canvas\r\n    imageToCanvas(x, y) {\r\n        return {\r\n            x: (x ) / this._scale,\r\n            y: (y ) / this._scale\r\n        };\r\n    }\r\n   // Verified\r\n   // And to convert from image to container we just need to add the offset\r\n   // Scale is already considered since the image coords are based on displayed size which is scaled\r\n    imageToContainer(x, y) {\r\n        return {\r\n            x: (x + this._offsetX),\r\n            y: (y + this._offsetY)\r\n        };\r\n    }\r\n    // Verified\r\n        \r\n    canvasToNormalized(x, y) {\r\n        const scaleX = 1000 / this._image.width;\r\n        const scaleY = 1000 / this._image.height;\r\n        return {\r\n            x: Math.round( x * scaleX ),\r\n            y: Math.round( y * scaleY )\r\n        };\r\n    }\r\n    normalizedToCanvas(x, y) {\r\n        const scaleX = this._image.width / 1000;\r\n        const scaleY = this._image.height / 1000;\r\n        return {\r\n            x: x * scaleX,\r\n            y: y * scaleY\r\n        };\r\n    }\r\n\r\n\r\n\r\n}\r\n\r\ncustomElements.define('image-selector', ImageSelector);\r\n","import { FileDropzone } from './FileDropzone.js';\r\nimport { ImageLibrary } from './ImageLibrary.js';\r\nimport '../ImageSelector.js';\r\n\r\nexport function initDashboardQuizEdit() {\r\n\r\n\t// Initialisation steps on page load...\r\n\tconst roundsContainer = document.getElementById('rounds-container');\r\n\tconst hostQuizButton = document.getElementById('host-quiz');\r\n\tconst addRoundButton = document.getElementById('add-round');\r\n\tconst quizTitle = document.getElementById('quiz-title');\r\n\tconst saveQuizButtons = document.querySelectorAll('.save-quiz-btn');\r\n\tconst backToQuizListButton = document.getElementById('back-to-list-btn');\r\n\r\n\thostQuizButton && hostQuizButton.addEventListener('click', hostQuiz);\r\n\taddRoundButton && addRoundButton.addEventListener('click', addRoundToDOM);\r\n\tquizTitle && quizTitle.addEventListener('blur', updateHeaderWithTitle);\r\n\tsaveQuizButtons.forEach(btn => btn.addEventListener('click', saveQuiz));\r\n\tbackToQuizListButton && backToQuizListButton.addEventListener('click', backToQuizList);\r\n\r\n\tdocument.addEventListener('click', async (event) => {\r\n\t\tif (event.target.matches('.select-image-btn')) {\r\n\t\t\tconst questionElement = event.target.closest('.question');\r\n\t\t\tconst imageSelector = new ImageLibrary({\r\n\t\t\t\tonSelect: (image) => {\r\n\t\t\t\t\tconst imagePreview = questionElement.querySelector('[data-field=\"question-image\"]');\r\n\t\t\t\t\tconst imageUrlField = questionElement.querySelector('[data-field=\"question-image-url\"]');\r\n\t\t\t\t\tconst previewContainer = questionElement.querySelector('.image-preview-container');\r\n\t\t\t\t\t\r\n\t\t\t\t\tif (imagePreview) {\r\n\t\t\t\t\t\timagePreview.src = image.url;\r\n\t\t\t\t\t\tif (previewContainer) previewContainer.style.display = 'block';\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (imageUrlField) imageUrlField.value = image.url;\r\n\t\t\t\t\t\r\n\t\t\t\t\tconst clearBtn = questionElement.querySelector('.clear-image-btn');\r\n\t\t\t\t\tif (clearBtn) clearBtn.style.display = 'inline-block';\r\n\t\t\t\t\t\r\n\t\t\t\t\tsetImageSelectorSrc(questionElement, image.url);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\timageSelector.show();\r\n\t\t}\r\n\t\tif (event.target.matches('.clear-image-btn')) {\r\n\t\t\tconst questionElement = event.target.closest('.question');\r\n\t\t\tconst imagePreview = questionElement.querySelector('[data-field=\"question-image\"]');\r\n\t\t\tconst imageUrlField = questionElement.querySelector('[data-field=\"question-image-url\"]');\r\n\t\t\tconst previewContainer = questionElement.querySelector('.image-preview-container');\r\n\t\t\t\r\n\t\t\tif (imagePreview) {\r\n\t\t\t\timagePreview.src = '';\r\n\t\t\t\tif (previewContainer) previewContainer.style.display = 'none';\r\n\t\t\t}\r\n\t\t\tif (imageUrlField) imageUrlField.value = '';\r\n\t\t\tevent.target.style.display = 'none';\r\n\t\t}\r\n\t\tif (event.target.classList.contains('delete-btn')) {\r\n\t\t\tconst elementToRemove = event.target.closest('.round, .question');\r\n\t\t\tif (elementToRemove.classList.contains('round')) {\r\n\t\t\t\tconst roundId = elementToRemove.querySelector('.round-id').value;\r\n\t\t\t\tconst quizId = document.getElementById('quiz-id').value;\r\n\t\t\t\tif (quizId && roundId) {\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tawait fetch(`/api/quiz/${quizId}/${roundId}`, { method: 'DELETE', headers: { 'Content-Type': 'application/json' } });\r\n\t\t\t\t\t} catch (error) { console.error('Error deleting round:', error); }\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telementToRemove.remove();\r\n\t\t\taddRoundQuestionNumbers();\r\n\t\t}\r\n\t});\r\n\r\n\tloadQuizOnEntry();\r\n\tinitErrorIndicatorHandlers();\r\n\r\n\tnew Sortable(roundsContainer, {\r\n\t\tanimation: 150,\r\n\t\thandle: '.card-header',\r\n\t\tonSort: (evt) => {\r\n\t\t\taddRoundQuestionNumbers();\r\n\t\t\tmarkAsChanged();\r\n\t\t},\r\n\t});\r\n\r\n\r\n\t// On page load, fetch quiz data if editing, or start a new quiz\r\n\tasync function loadQuizOnEntry() {\r\n\t\tconst urlParams = new URLSearchParams(window.location.search);\r\n\t\tconst quizId = urlParams.get('id');\r\n\t\tif (quizId) {\r\n\t\t\t// Fetch quiz data from server\r\n\t\t\ttry {\r\n\t\t\t\tconst response = await fetch(`/api/quiz/${quizId}`);\r\n\t\t\t\tconst result = await response.json();\r\n\t\t\t\tconsole.log('Loaded quiz data:', result);\r\n\t\t\t\tif (result.success && result.data) {\r\n\t\t\t\t\tcreateQuizFromJSON(result.data);\r\n\t\t\t\t} else {\r\n\t\t\t\t\talert('Failed to load quiz data.');\r\n\t\t\t\t}\r\n\t\t\t} catch (err) {\r\n\t\t\t\talert('Error loading quiz data.');\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\t// New quiz\r\n\t\t\tcreateQuizFromJSON({ title: 'New Quiz', description: '', rounds: [] });\r\n\t\t}\r\n\t}\r\n\r\n\tlet hasUnsavedChanges = false;\r\n\r\n\t// Warn user of unsaved changes - note this is still the only way to do this currently...\r\n\twindow.addEventListener('beforeunload', (e) => {\r\n\t\tif (hasUnsavedChanges) {\r\n\t\t\te.returnValue = 'XXX';\r\n\t\t}\r\n\t});\r\n\r\n\tfunction hostQuiz() {\r\n\t\tconst quizID = document.getElementById('quiz-id').value;\r\n\t\tif (quizID) {\r\n\t\t\twindow.location.href = `/host/lobby?host=1&q=${quizID}`;\r\n\t\t} else {\r\n\t\t\talert('Please save the quiz before hosting it');\r\n\t\t}\r\n\t}\r\n\r\n\t// saveQuiz\r\n\t// First validates the quiz and, if valid, sends to server to save\r\n\tasync function saveQuiz(event) {\r\n\t\tevent.preventDefault(); // Prevent the default form submission\r\n\r\n\t\t// Collect quiz data from the form\r\n\t\tconst quizJSON = createJSONfromQuiz();\r\n\r\n\t\t// Update the full JSON object into the HTML page for debugging\r\n\t\tdocument.getElementById('quiz-json').textContent = JSON.stringify(quizJSON, null, 2);\r\n\t\t\r\n\t\t// Re-validate the quiz before saving\r\n\t\tconst validation = await validateQuizSchema(quizJSON);\r\n\t\tif (!validation.valid) {\r\n\t\t\tconsole.log('Quiz validation failed:', validation);\r\n\t\t\talert('Errors found: please correct before saving)');\r\n\t\t\t// Update the error indicators\r\n\t\t\tdisplayValidationErrors(validation.errors);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Get the button id to replace with saving/saved message\r\n\t\tconst saveQuizButtons = document.querySelectorAll('.save-quiz-btn');\r\n\t\tsaveQuizButtons.forEach(btn => btn.textContent = 'Saving...');\r\n\r\n\r\n\t\ttry {\r\n\t\t\tconst response = await fetch('/api/quiz/save', {\r\n\t\t\t\tmethod: 'POST',\r\n\t\t\t\theaders: {\r\n\t\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t\t\t// Include any necessary authentication headers here\r\n\t\t\t\t},\r\n\t\t\t\tbody: JSON.stringify(quizJSON) // Convert the quiz data to JSON\r\n\t\t\t});\r\n\t\t\tconst result = await response.json();\r\n\r\n\t\t\tif (!result.success) {\r\n\t\t\t\tconsole.log('Error saving quiz: please correct any errors and try again');\r\n\t\t\t\tsaveQuizButtons.forEach(btn => btn.textContent = 'Save Quiz');\r\n\t\t\t\talert('Error saving quiz: ' + (result.message || 'Unknown error'));\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\t// Parse the response as JSON - note it could have validation errors\r\n\t\t\tconsole.log('Quiz saved successfully:', result);\r\n\t\t\tsaveQuizButtons.forEach(btn => btn.textContent = 'Saved');\r\n\t\t\tconst saveQuizTimeout = setTimeout(() => {\r\n\t\t\t\tsaveQuizButtons.forEach(btn => btn.textContent = 'Save Quiz');\r\n\t\t\t\tclearTimeout(saveQuizTimeout);\r\n\t\t\t}, 3000);\r\n\r\n\t\t\tcreateQuizFromJSON(result.data);\r\n\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error('Error saving quiz:', error);\r\n\t\t\t// Optionally, display an error message to the user\r\n\t\t}\r\n\t}\r\n\r\n\tfunction addCollapseAll(summaryElement) {\r\n\t\tsummaryElement.addEventListener('click', (event) => {\r\n\t\t\t// If clicking a button inside the summary, don't toggle collapse\r\n\t\t\tif (event.target.closest('button')) {\r\n\t\t\t\tevent.preventDefault();\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// The click event is fired BEFORE the details element is opened/closed\r\n\t\t\tconst details = summaryElement.parentNode;\r\n\t\t\tif (details.hasAttribute('open')) {\r\n\t\t\t\tconst allDetails = details.querySelectorAll('details');\r\n\t\t\t\tallDetails.forEach(detail => {\r\n\t\t\t\t\tdetail.removeAttribute('open');\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tfunction addRoundToDOM() {\r\n\t\tconsole.log('addRoundToDOM');\r\n\t\tconst roundTemplate = document.getElementById('round-template');\r\n\t\tconst roundElement = roundTemplate.content.cloneNode(true);\r\n\t\tconst questionsContainer = roundElement.querySelector('.questions-container');\r\n\t\tconst addQuestionButton = roundElement.querySelector('.question-btn');\r\n\r\n\t\t// Add event handlers for round elements\r\n\t\taddQuestionButton.addEventListener('click', () => addQuestionToDOM(questionsContainer));\r\n\t\troundElement.querySelector('.round-title').addEventListener('blur', updateHeaderWithTitle);\r\n\r\n\t\t// Add collapse all functionality\r\n\t\tconst summary = roundElement.querySelector('.card-header');\r\n\t\tif (summary) addCollapseAll(summary);\r\n\r\n\t\troundsContainer.appendChild(roundElement);\r\n\r\n\t\tconst roundSorttable = new Sortable(questionsContainer, {\r\n\t\t\tanimation: 150,\r\n\t\t\thandle: '.card-header',\r\n\t\t\tgroup: 'questions',\r\n\t\t\tscroll: true, // enables auto-scrolling while dragging\r\n\t\t\tscrollSensitivity: 60,\r\n\t\t\tonSort: (evt) => {\r\n\t\t\t\tconsole.log('roundSorttable onSort:', evt);\r\n\t\t\t\taddRoundQuestionNumbers();\r\n\t\t\t\tmarkAsChanged();\r\n\t\t\t},\r\n\t\t});\r\n\r\n\t\taddRoundQuestionNumbers();\r\n\r\n\t}\r\n\r\n\tfunction addQuestionToDOM(container) {\r\n\t\tconst questionTemplate = document.getElementById('question-template');\r\n\t\tconst questionElement = questionTemplate.content.cloneNode(true);\r\n\r\n\t\tconst questionNumber = container.children.length + 1;\r\n\t\tquestionElement.querySelector('.header-question-number').textContent = questionNumber;\r\n\r\n\t\t// Add event listener for question text changes (update header)\r\n\t\tconst questionText = questionElement.querySelector('[data-field=\"question-text\"]');\r\n\t\tquestionText.addEventListener('blur', updateHeaderWithTitle);\r\n\r\n\t\t// Add collapse all functionality\r\n\t\tconst summary = questionElement.querySelector('.card-header');\r\n\t\tif (summary) addCollapseAll(summary);\r\n\r\n\t\t// Add event listener for question type changes\r\n\t\tconst typeSelector = questionElement.querySelector('.question-type');\r\n\t\ttypeSelector.addEventListener('change', questionTypeChangeListener);\r\n\t\t// ...and call the question type change handler immediately to initialise with the default question type (text)\r\n\t\thandleQuestionTypeChange(questionElement);\r\n\r\n\t\t// Add event listener for question-image-url changes\r\n\t\tconst questionImage = questionElement.querySelector('[data-field=\"question-image-url\"]');\r\n\t\tquestionImage.addEventListener('blur', handleExternalImageURL);\r\n\r\n\t\t// Add the question to the DOM (container)\r\n\t\tcontainer.appendChild(questionElement);\r\n\r\n\t\taddRoundQuestionNumbers();\r\n\t}\r\n\r\n\tfunction questionTypeChangeListener(event) {\r\n\t\tconst questionElement = event.target.closest('.question');\r\n\t\thandleQuestionTypeChange(questionElement);\r\n\t}\r\n\tfunction handleQuestionTypeChange(questionElement) {\r\n\r\n\t\t// Set up some constants for use in the switch statement\r\n\t\tconst contentContainer = questionElement.querySelector('.question-specific-content');\r\n\t\tconst questionType = questionElement.querySelector('.question-type').value;\r\n\t\tconst questionHint = questionElement.querySelector('.question-type-hint');\r\n\t\tconst questionImage = questionElement.querySelector('[data-field=\"question-image\"]');\r\n\t\tconsole.log('handleQuestionTypeChange:', questionType);\r\n\r\n\t\t// Clear existing content\r\n\t\tcontentContainer.innerHTML = '';\r\n\r\n\t\tswitch (questionType) {\r\n\t\t\tcase 'text':\r\n\t\t\t\tcontentContainer.innerHTML = `\r\n                    <label>Answer:</label><input type=\"text\" data-field=\"answer\" placeholder=\"Enter answer\">\r\n                `;\r\n\t\t\t\tquestionHint.textContent = 'Basic question - players type the answer via an on-screen keyboard';\r\n\t\t\t\tbreak;\r\n\t\t\tcase 'number-exact':\r\n\t\t\t\tquestionHint.textContent = 'Answer is numeric - players must get the answer exactly right to score the points';\r\n\t\t\t\tcontentContainer.innerHTML = `\r\n                    <label>Answer:</label><input type=\"number\" data-field=\"answer\" placeholder=\"Enter answer\">\r\n                `;\r\n\t\t\t\tbreak\r\n\r\n\t\t\tcase 'number-closest':\r\n\t\t\t\tquestionHint.textContent = 'Answer is numeric - players who get closest to the answer score the points';\r\n\t\t\t\tcontentContainer.innerHTML = `\r\n                    <label>Answer:</label><input type=\"number\" data-field=\"answer\" placeholder=\"Enter answer\">\r\n                `;\r\n\t\t\t\tbreak\r\n\r\n\t\t\tcase 'number-average':\r\n\t\t\t\tquestionHint.textContent = 'Answer is numeric - players who get closest to the average of all player guesses score the points. Question may have an answer, or could be totally subjective.';\r\n\t\t\t\tcontentContainer.innerHTML = `\r\n                    <label>Answer:</label><input type=\"number\" data-field=\"answer\" placeholder=\"Optional answer - if there is one\">\r\n                `;\r\n\t\t\t\tbreak\r\n\r\n\t\t\t\tcase 'multiple-choice':\r\n\t\t\t\tquestionHint.textContent = 'Players select an answer from the provided options';\r\n\t\t\t\tcontentContainer.innerHTML = `\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"option-1\" placeholder=\"This is the correct answer\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"option-2\" placeholder=\"Enter option\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"option-3\" placeholder=\"Enter option\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"option-4\" placeholder=\"Enter option\">\r\n                        <p>Optionally add up to 4 more answers</p>\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"option-5\" placeholder=\"...\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"option-6\" placeholder=\"...\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"option-7\" placeholder=\"...\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"option-8\" placeholder=\"...\">\r\n                    </div>\r\n                `;\r\n\t\t\t\tbreak;\r\n\t\t\tcase 'true-false':\r\n\t\t\t\tquestionHint.textContent = 'Only two possible answers here...';\r\n\t\t\t\tcontentContainer.innerHTML = `\r\n                    <label>Answer:</label><select data-field=\"answer\">\r\n                        <option value=\"true\">True</option>\r\n                        <option value=\"false\">False</option>\r\n                    </select></p>\r\n                `;\r\n\t\t\t\tbreak;\r\n\t\t\tcase 'matching':\r\n\t\t\t\tquestionHint.textContent = 'Players drag items from the left to the matching option on the right (max 5 pairs, can be less just leave empty if not needed)';\r\n\t\t\t\tcontentContainer.innerHTML = `\r\n                    <div class=\"question-row\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"left-1\" placeholder=\"Left item 1\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"right-1\" placeholder=\"Right item 1\">\r\n                    </div>\r\n                    <div class=\"question-row\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"left-2\" placeholder=\"Left item 2\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"right-2\" placeholder=\"Right item 2\">\r\n                    </div>\r\n                    <div class=\"question-row\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"left-3\" placeholder=\"Left item 3\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"right-3\" placeholder=\"Right item 3\">\r\n                    </div>\r\n                    <div class=\"question-row\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"left-4\" placeholder=\"Left item 4\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"right-4\" placeholder=\"Right item 4\">\r\n                    </div>\r\n                    <div class=\"question-row\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"left-5\" placeholder=\"Left item 5\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"right-5\" placeholder=\"Right item 5\">\r\n                    </div>\r\n                `;\r\n\t\t\t\tbreak;\r\n\t\t\tcase 'ordering':\r\n\t\t\t\tquestionHint.textContent = 'Players drag items into the correct order';\r\n\t\t\t\tcontentContainer.innerHTML = `\r\n                        <label>Start label:</label><input type=\"text\" data-field=\"order-start\" placeholder=\"eg Earliest\">\r\n                        <label>End label:</label><input type=\"text\" data-field=\"order-end\" placeholder=\"eg Latest\">\r\n                        <label>Items to Order (enter in correct order):</label>\r\n                        <div class=\"ordering-items\">\r\n                            <input type=\"text\" data-field=\"order-item\" placeholder=\"Item 1\">\r\n                            <input type=\"text\" data-field=\"order-item\" placeholder=\"Item 2\">\r\n                            <input type=\"text\" data-field=\"order-item\" placeholder=\"Item 3\">\r\n                            <input type=\"text\" data-field=\"order-item\" placeholder=\"Item 4\">\r\n                            <input type=\"text\" data-field=\"order-item\" placeholder=\"Item 5\">\r\n                            <input type=\"text\" data-field=\"order-item\" placeholder=\"Item 6\">\r\n                        </div>\r\n                `;\r\n\t\t\t\tbreak;\r\n\t\t\tcase 'hotspot':\r\n\t\t\t\tquestionHint.textContent = 'Players select a point on the picture - closest players score the points (select picture on the left column then mark a X at the correct point)';\r\n\t\t\t\tcontentContainer.innerHTML = `\r\n                    <image-selector data-field=\"image-selector-preview\" class=\"image-selector-preview\" mode=\"hotspot\"></image-selector>\r\n                    <input type=\"hidden\" data-field=\"hotspot-x\">\r\n                    <input type=\"hidden\" data-field=\"hotspot-y\">\r\n                `;\r\n\t\t\t\tconst hotspotPreview = contentContainer.querySelector('.image-selector-preview');\r\n\t\t\t\thotspotPreview.addEventListener('selection', (event) => imageSelectorSelection(questionElement, event.detail, 'hotspot'));\r\n\t\t\t\tif (questionImage.getAttribute('src')) {\r\n\t\t\t\t\tsetImageSelectorSrc(questionElement, questionImage.getAttribute('src'));\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase 'point-it-out':\r\n\t\t\t\tquestionHint.textContent = 'Similar to hotspot, except players score if they are within the selected rectangular area (select picture on the left column then drag a rectangle on the picture)';\r\n\t\t\t\tcontentContainer.innerHTML = `\r\n                    <image-selector data-field=\"image-selector-preview\" class=\"image-selector-preview\" mode=\"rectangle\"></image-selector>\r\n                    <input type=\"hidden\" data-field=\"point-it-out-startx\">\r\n                    <input type=\"hidden\" data-field=\"point-it-out-starty\">\r\n                    <input type=\"hidden\" data-field=\"point-it-out-endx\">\r\n                    <input type=\"hidden\" data-field=\"point-it-out-endy\">\r\n                `;\r\n\t\t\t\tconst pointItOutPreview = contentContainer.querySelector('[data-field=\"image-selector-preview\"]');\r\n\t\t\t\tpointItOutPreview.addEventListener('selection', (event) => imageSelectorSelection(questionElement, event.detail, 'point-it-out'));\r\n\t\t\t\tif (questionImage.getAttribute('src')) {\r\n\t\t\t\t\tsetImageSelectorSrc(questionElement, questionImage.getAttribute('src'));\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase 'draw':\r\n\t\t\t\tquestionHint.textContent = 'Players draw or write the answer on their screen - teams mark each others answers';\r\n\t\t\t\tcontentContainer.innerHTML = `\r\n                    <label>Answer</label><input type=\"text\" data-field=\"answer\" placeholder=\"Enter answer\">\r\n                `;\r\n\t\t\t\tbreak;\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\tfunction addRoundQuestionNumbers() {\r\n\t\tconst roundElements = document.querySelectorAll('.round');\r\n\t\troundElements.forEach((roundElement, index) => {\r\n\t\t\troundElement.querySelector('.header-round-number').textContent = index + 1;\r\n\t\t\tconst questionElements = roundElement.querySelectorAll('.question');\r\n\t\t\tquestionElements.forEach((questionElement, questionIndex) => {\r\n\t\t\t\tquestionElement.querySelector('.header-question-number').textContent = questionIndex + 1;\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\tfunction updateHeaderWithTitle(event) {\r\n\t\tconsole.log('updateHeaderWithTitle:', event.target.value);\r\n\t\tconst headerToUpdate = event.target.closest('.quiz-container, .round, .question');\r\n\t\tif (headerToUpdate) {\r\n\t\t\tconst titleEl = headerToUpdate.querySelector('.header-title');\r\n\t\t\tif (titleEl) titleEl.textContent = event.target.value;\r\n\t\t}\r\n\t}\r\n\r\n\t// Image Upload functions\r\n\t// There are three entry point for image uploads:\r\n\t// 1. handleDropFiles - called when files are dropped into the dropzone\r\n\t// 2. handleFilesUpload - called when (multiple) files are selected from the file input\r\n\t// 3. readImageDataFromFiles - the actual file reader\r\n\t// 1 and 2 call 3 to carry out the file reading\r\n\tfunction handleDropFiles(event) {\r\n\t\tconsole.log('handleDropFiles:', event.target.closest('.question'));\r\n\t\tconst dt = event.dataTransfer;\r\n\t\tconst files = dt.files;\r\n\t\tif (files.length > 0) {\r\n\t\t\treadImageDataFromFiles(files[0], event.target.closest('.question'));\r\n\t\t}\r\n\t}\r\n\tfunction handleQuestionImageUpload(file, questionElement) {\r\n\t\tconst reader = new FileReader();\r\n\t\treader.onload = (e) => {\r\n\t\t\tconst imagePreview = questionElement.querySelector('[data-field=\"question-image\"]');\r\n\t\t\timagePreview.src = e.target.result;\r\n\t\t\timagePreview.style.display = 'block';\r\n\r\n\t\t\t// Store the data URL in the URL field or in a hidden field\r\n\t\t\tconst imageUrlField = questionElement.querySelector('[data-field=\"question-image-url\"]');\r\n\t\t\timageUrlField.value = ''; // Clear URL field since we're using a local file\r\n\r\n\t\t\t// Store the image data for later use (when saving)\r\n\t\t\tquestionElement.dataset.imageData = e.target.result;\r\n\t\t};\r\n\t\treader.readAsDataURL(file);\r\n\t}\r\n\tfunction handleImageUpload(event) {\r\n\t\tconsole.log('handleImageUpload:', event.target.closest('.question'));\r\n\t\tconst files = event.target.files;\r\n\t\tif (files.length > 0) {\r\n\t\t\treadImageDataFromFiles(files[0], event.target.closest('.question'));\r\n\t\t}\r\n\t}\r\n\tfunction readImageDataFromFiles(file, questionElement) {\r\n\t\tconsole.log('readImageDataFromFiles:', file, questionElement.querySelector('[data-field=\"question-image\"]'));\r\n\t\tconst reader = new FileReader();\r\n\t\treader.onload = function (e) {\r\n\t\t\tconsole.log('readImageDataFromFiles onload:', e.target.result);\r\n\t\t\t// questionElement.dataset.imageData = e.target.result;\r\n\t\t\t// const previewDiv = questionElement.querySelector('.image-preview');\r\n\t\t\t// previewDiv.innerHTML = `<img src=\"${e.target.result}\" style=\"max-width:200px; max-height:200px;\">`;\r\n\t\t\tconst imageSelectorPreviews = questionElement.querySelectorAll('[data-field=\"question-image\"]');\r\n\t\t\tif (imageSelectorPreviews) {\r\n\t\t\t\tconsole.log('setImageSelectorSrc:');\r\n\t\t\t\timageSelectorPreviews.forEach(imageSelectorPreview => {\r\n\t\t\t\t\tsetImageSelectorSrc(questionElement, e.target.result);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t\treader.readAsDataURL(file);\r\n\t}\r\n\t// Handle external image url - no need to load the file simply access from the URL\r\n\t// Called when question-image element loses focus - update the src attribute of selectors\r\n\tfunction handleExternalImageURL(event) {\r\n\t\tconsole.log('handleExternalImageURL:', event.target.value);\r\n\t\t// Just in case user focuses and then blurs without entering a URL\r\n\t\tif (event.target.value) {\r\n\t\t\tconst questionElement = event.target.closest('.question');\r\n\t\t\tsetImageSelectorSrc(questionElement, event.target.value);\r\n\r\n\t\t\t// Similar to if selecting image from library - we show the remove button and hide the add button\r\n\t\t\tquestionElement.querySelector('.clear-image-btn').style.display = 'inline-block';\r\n\t\t\tquestionElement.querySelector('.add-from-library').style.display = 'none';\r\n\r\n\t\t}\r\n\t}\r\n\r\n\t// setImageSelectorSrc\r\n\t// When a new image is selected we update the image-selector-preview elements\r\n\t// There can be 2 of these: the first is the question image, the second is the answer image (in the case of hotspot/point-it-out)\r\n\tfunction setImageSelectorSrc(questionElement, src) {\r\n\t\tconsole.log('setImageSelectorSrc:', src);\r\n\t\tconst questionImage = questionElement.querySelector('[data-field=\"question-image-url\"]');\r\n\t\tif (questionImage) {\r\n\t\t\tquestionImage.value = src;\r\n\t\t}\r\n\t\t\r\n\t\tconst imagePreview = questionElement.querySelector('[data-field=\"question-image\"]');\r\n\t\tconst previewContainer = questionElement.querySelector('.image-preview-container');\r\n\t\tconst clearBtn = questionElement.querySelector('.clear-image-btn');\r\n\r\n\t\tif (imagePreview) {\r\n\t\t\timagePreview.src = src;\r\n\t\t\tif (previewContainer) previewContainer.style.display = src ? 'block' : 'none';\r\n\t\t\tif (clearBtn) clearBtn.style.display = src ? 'inline-block' : 'none';\r\n\t\t}\r\n\r\n\t\t// Also check for any other previews (like in hotspot)\r\n\t\tconst otherPreviews = questionElement.querySelectorAll('.image-selector-preview');\r\n\t\totherPreviews.forEach(preview => {\r\n\t\t\tpreview.setAttribute('src', src);\r\n\t\t\tpreview.style.display = src ? 'block' : 'none';\r\n\t\t});\r\n\t}\r\n\tfunction imageSelectorSelection(questionElement, details, type) {\r\n\t\tconsole.log('imageSelectorSelection:', questionElement, details, type);\r\n\t\tif (type === 'hotspot') {\r\n\t\t\tquestionElement.querySelector('[data-field=\"hotspot-x\"]').value = details.x;\r\n\t\t\tquestionElement.querySelector('[data-field=\"hotspot-y\"]').value = details.y;\r\n\t\t} else if (type === 'point-it-out') {\r\n\t\t\tconsole.log('update point-it-out:', details);\r\n\t\t\tquestionElement.querySelector('[data-field=\"point-it-out-startx\"]').value = details.start.x;\r\n\t\t\tquestionElement.querySelector('[data-field=\"point-it-out-starty\"]').value = details.start.y;\r\n\t\t\tquestionElement.querySelector('[data-field=\"point-it-out-endx\"]').value = details.end.x;\r\n\t\t\tquestionElement.querySelector('[data-field=\"point-it-out-endy\"]').value = details.end.y;\r\n\t\t}\r\n\t\tmarkAsChanged();\r\n\t}\r\n\r\n\tfunction createJSONfromQuiz() {\r\n\r\n\t\tconst quizJSON = {\r\n\t\t\t_id: document.getElementById('quiz-id').value,\r\n\t\t\tschemaVersion: document.getElementById('quiz-schema-version').value,\r\n\t\t\townerID: document.getElementById('quiz-owner').value,\r\n\t\t\ttitle: document.getElementById('quiz-title').value,\r\n\t\t\tdescription: document.getElementById('quiz-description').value,\r\n\t\t\t// description: document.querySelector('#quiz-description .ql-editor').innerHTML,\r\n\t\t\t// description: quill.root.innerHTML,\r\n\t\t\trounds: Array.from(roundsContainer.querySelectorAll('.round')).map(roundElement => ({\r\n\t\t\t\t_id: roundElement.querySelector('.round-id').value,\r\n\t\t\t\townerID: roundElement.querySelector('.round-owner').value,\r\n\t\t\t\ttitle: roundElement.querySelector('.round-title').value,\r\n\t\t\t\tdescription: roundElement.querySelector('.round-description').value,\r\n\t\t\t\troundTimer: roundElement.querySelector('[data-field=\"round-timer\"]').value,\r\n\t\t\t\tshowAnswer: roundElement.querySelector('[data-field=\"show-answer\"]').value,\r\n\t\t\t\tupdateScores: roundElement.querySelector('[data-field=\"update-scores\"]').value,\r\n\t\t\t\tquestions: Array.from(roundElement.querySelectorAll('.question')).map(questionElement => gatherQuestionData(questionElement))\r\n\t\t\t}))\r\n\t\t}\r\n\t\tconsole.log('createJSONfromQuiz:', quizJSON);\r\n\t\treturn quizJSON;\r\n\t}\r\n\r\n\t// Add this function to improve validation error messages\r\n\tfunction improveValidationErrorMessage(error) {\r\n\t\t// The original error message\r\n\t\tconst originalMessage = error.message;\r\n\t\t// The path where the error occurred\r\n\t\tconst path = error.instancePath;\r\n\r\n\t\t// Common error translations\r\n\t\tif (originalMessage === 'must match \"then\" schema') {\r\n\t\t\t// Extract the question type from the data\r\n\t\t\tconst pathParts = path.split('/');\r\n\r\n\t\t\t// For questions, check what type it is\r\n\t\t\tif (path.includes('questions')) {\r\n\t\t\t\t// Find the round and question index\r\n\t\t\t\tconst roundIndex = parseInt(pathParts[pathParts.indexOf('rounds') + 1]);\r\n\t\t\t\tconst questionIndex = parseInt(pathParts[pathParts.indexOf('questions') + 1]);\r\n\r\n\t\t\t\t// Get the question data\r\n\t\t\t\tconst questionData = document.querySelectorAll('.round')[roundIndex]\r\n\t\t\t\t\t?.querySelectorAll('.question')[questionIndex]\r\n\t\t\t\t\t?.dataset.questionData;\r\n\r\n\t\t\t\tif (questionData) {\r\n\t\t\t\t\tconst question = JSON.parse(questionData);\r\n\r\n\t\t\t\t\t// Provide specific messages based on question type\r\n\t\t\t\t\tswitch (question.type) {\r\n\r\n\t\t\t\t\t\tcase 'multiple-choice':\r\n\t\t\t\t\t\t\treturn \"This question requires at least 2 options and a correct answer\";\r\n\r\n\t\t\t\t\t\tcase 'true-false':\r\n\t\t\t\t\t\t\treturn \"This question requires a True or False answer\";\r\n\r\n\t\t\t\t\t\tcase 'text':\r\n\t\t\t\t\t\tcase 'number-exact':\r\n\t\t\t\t\t\tcase 'number-closest':\r\n\t\t\t\t\t\t\treturn \"This question requires an answer\";\r\n\r\n\t\t\t\t\t\tcase 'number-average':\r\n\t\t\t\t\t\t\treturn \"This question does not require an answer\";\r\n\r\n\t\t\t\t\t\tcase 'hotspot':\r\n\t\t\t\t\t\t\treturn \"This question requires hotspot coordinates\";\r\n\r\n\t\t\t\t\t\tcase 'point-it-out':\r\n\t\t\t\t\t\t\treturn \"This question requires coordinates of two opposite corners of the rectangle\";\r\n\r\n\t\t\t\t\t\tcase 'ordering':\r\n\t\t\t\t\t\t\treturn \"This question requires 2-6 items to order plus optional start/end labels\";\r\n\r\n\t\t\t\t\t\tcase 'matching':\r\n\t\t\t\t\t\t\treturn \"This question requires at least 2 matching pairs\";\r\n\r\n\t\t\t\t\t\tcase 'draw':\r\n\t\t\t\t\t\t\treturn \"This drawing question is missing required settings\";\r\n\r\n\t\t\t\t\t\tdefault:\r\n\t\t\t\t\t\t\treturn `This ${question.type} question is missing required fields`;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// Generic fallback message\r\n\t\t\treturn \"This item is missing required fields based on its type\";\r\n\t\t}\r\n\r\n\t\t// Other common error messages\r\n\t\tif (originalMessage.includes(\"required property\")) {\r\n\t\t\tconst property = originalMessage.match(/'([^']+)'/)?.[1];\r\n\r\n\t\t\t// Map property names to user-friendly terms\r\n\t\t\tconst propertyMap = {\r\n\t\t\t\t'title': 'Title',\r\n\t\t\t\t'text': 'Question text',\r\n\t\t\t\t'answer': 'Answer',\r\n\t\t\t\t'options': 'Answer options',\r\n\t\t\t\t'correctOption': 'Correct option',\r\n\t\t\t\t'items': 'Items to order',\r\n\t\t\t\t'pairs': 'Matching pairs',\r\n\t\t\t\t'startLabel': 'Start label',\r\n\t\t\t\t'endLabel': 'End label'\r\n\t\t\t};\r\n\r\n\t\t\treturn `Missing required field: ${propertyMap[property] || property}`;\r\n\t\t}\r\n\r\n\t\t// Return the original message if we don't have a specific improvement\r\n\t\treturn originalMessage;\r\n\t}\r\n\r\n\r\n\t// Display validation errors and add warning icons\r\n\tfunction displayValidationErrors(validationResults) {\r\n\r\n\t\t// First, clear any existing error indicators\r\n\t\tclearValidationErrors();\r\n\r\n\t\tif (!validationResults || validationResults.length === 0) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Create error tracking objects\r\n\t\tconst roundErrors = {};  // Store errors by round index\r\n\t\tconst questionErrors = {}; // Store errors by round and question indices\r\n\r\n\t\t// Display summary of errors at the top\r\n\t\tconst errorCount = validationResults.length;\r\n\t\tconst errorSummary = document.getElementById('validation-summary');\r\n\t\terrorSummary.textContent = `Found ${errorCount} error${errorCount > 1 ? 's' : ''}. Please fix before saving.`;\r\n\t\terrorSummary.style.display = 'block';\r\n\r\n\t\t// Process each error\r\n\t\tvalidationResults.forEach(error => {\r\n\t\t\t// Parse the error path to determine where to display the error\r\n\t\t\tconst path = error.instancePath.split('/');\r\n\r\n\t\t\t// Skip the first empty element from the split\r\n\t\t\tpath.shift();\r\n\r\n\t\t\tif (path.length === 0) {\r\n\t\t\t\t// Quiz-level error\r\n\t\t\t\tdisplayQuizError(error);\r\n\t\t\t} else if (path[0] === 'rounds') {\r\n\t\t\t\tconst roundIndex = parseInt(path[1]);\r\n\r\n\t\t\t\t// Track round errors\r\n\t\t\t\tif (!roundErrors[roundIndex]) {\r\n\t\t\t\t\troundErrors[roundIndex] = [];\r\n\t\t\t\t}\r\n\t\t\t\troundErrors[roundIndex].push(error.message);\r\n\r\n\t\t\t\tif (path.length === 2 || path.length === 3) {\r\n\t\t\t\t\t// Error on the round itself\r\n\t\t\t\t\tconst field = path.length > 2 ? path[2] : null;\r\n\t\t\t\t\tdisplayRoundError(roundIndex, field, error);\r\n\t\t\t\t} else if (path[2] === 'questions') {\r\n\t\t\t\t\tconst questionIndex = parseInt(path[3]);\r\n\r\n\t\t\t\t\t// Track question errors\r\n\t\t\t\t\tif (!questionErrors[roundIndex]) {\r\n\t\t\t\t\t\tquestionErrors[roundIndex] = {};\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (!questionErrors[roundIndex][questionIndex]) {\r\n\t\t\t\t\t\tquestionErrors[roundIndex][questionIndex] = [];\r\n\t\t\t\t\t}\r\n\t\t\t\t\tquestionErrors[roundIndex][questionIndex].push(error.message);\r\n\r\n\t\t\t\t\t// Display error in the question\r\n\t\t\t\t\tconst field = path.length > 4 ? path[4] : null;\r\n\t\t\t\t\tdisplayQuestionError(roundIndex, questionIndex, field, error);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t// Add warning icons to rounds with errors\r\n\t\tObject.keys(roundErrors).forEach(roundIndex => {\r\n\t\t\taddRoundErrorIndicator(parseInt(roundIndex), roundErrors[roundIndex].length);\r\n\t\t});\r\n\r\n\t\t// Add warning icons to questions with errors\r\n\t\tObject.keys(questionErrors).forEach(roundIndex => {\r\n\t\t\tObject.keys(questionErrors[roundIndex]).forEach(questionIndex => {\r\n\t\t\t\taddQuestionErrorIndicator(\r\n\t\t\t\t\tparseInt(roundIndex),\r\n\t\t\t\t\tparseInt(questionIndex),\r\n\t\t\t\t\tquestionErrors[roundIndex][questionIndex].length\r\n\t\t\t\t);\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\t// Update clearValidationErrors to hide indicators instead of removing them\r\n\tfunction clearValidationErrors() {\r\n\t\t// Clear summary\r\n\t\tconst errorSummary = document.getElementById('validation-summary');\r\n\t\tif (errorSummary) {\r\n\t\t\terrorSummary.textContent = '';\r\n\t\t\terrorSummary.style.display = 'none';\r\n\t\t}\r\n\r\n\t\t// Clear quiz errors\r\n\t\tdocument.querySelectorAll('.error-message').forEach(el => el.remove());\r\n\r\n\t\t// Clear field errors\r\n\t\tdocument.querySelectorAll('.error-field').forEach(el => {\r\n\t\t\tel.classList.remove('error-field');\r\n\t\t\tel.title = '';\r\n\t\t});\r\n\r\n\t\t// Hide error indicators instead of removing them\r\n\t\tdocument.querySelectorAll('.error-indicator').forEach(el => {\r\n\t\t\tel.style.display = 'none';\r\n\t\t\tel.classList.remove('animate');\r\n\t\t\tdelete el.dataset.count;\r\n\t\t});\r\n\t}\r\n\r\n\t// Modify the addRoundErrorIndicator function to toggle visibility\r\n\tfunction addRoundErrorIndicator(roundIndex, errorCount) {\r\n\t\tconst rounds = document.querySelectorAll('.round');\r\n\t\tif (roundIndex >= 0 && roundIndex < rounds.length) {\r\n\t\t\tconst roundElement = rounds[roundIndex];\r\n\t\t\tconst indicator = roundElement.querySelector('.error-indicator');\r\n\r\n\t\t\tif (indicator) {\r\n\t\t\t\t// Make it visible\r\n\t\t\t\tindicator.style.display = 'inline-flex';\r\n\t\t\t\tindicator.title = `This round has ${errorCount} error${errorCount > 1 ? 's' : ''}`;\r\n\r\n\t\t\t\t// Add error count if more than 1\r\n\t\t\t\tif (errorCount > 1) {\r\n\t\t\t\t\tindicator.dataset.count = errorCount;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tdelete indicator.dataset.count;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Add animation to draw attention\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tindicator.classList.add('animate');\r\n\t\t\t\t}, 100);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t// Modify the addQuestionErrorIndicator function to toggle visibility\r\n\tfunction addQuestionErrorIndicator(roundIndex, questionIndex, errorCount) {\r\n\t\tconst rounds = document.querySelectorAll('.round');\r\n\t\tif (roundIndex >= 0 && roundIndex < rounds.length) {\r\n\t\t\tconst roundElement = rounds[roundIndex];\r\n\t\t\tconst questions = roundElement.querySelectorAll('.question');\r\n\r\n\t\t\tif (questionIndex >= 0 && questionIndex < questions.length) {\r\n\t\t\t\tconst questionElement = questions[questionIndex];\r\n\t\t\t\tconst indicator = questionElement.querySelector('.error-indicator');\r\n\r\n\t\t\t\tif (indicator) {\r\n\t\t\t\t\t// Make it visible\r\n\t\t\t\t\tindicator.style.display = 'inline-flex';\r\n\t\t\t\t\tindicator.title = `This question has ${errorCount} error${errorCount > 1 ? 's' : ''}`;\r\n\r\n\t\t\t\t\t// Add error count if more than 1\r\n\t\t\t\t\tif (errorCount > 1) {\r\n\t\t\t\t\t\tindicator.dataset.count = errorCount;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tdelete indicator.dataset.count;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// Add animation to draw attention\r\n\t\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\t\tindicator.classList.add('animate');\r\n\t\t\t\t\t}, 100);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t// Initialize event listeners for error indicators\r\n\tfunction initErrorIndicatorHandlers() {\r\n\t\tdocument.addEventListener('click', (event) => {\r\n\t\t\tif (event.target.closest('.error-indicator')) {\r\n\t\t\t\tconst indicator = event.target.closest('.error-indicator');\r\n\r\n\t\t\t\t// Find the closest round or question\r\n\t\t\t\tconst container = indicator.closest('.round, .question');\r\n\r\n\t\t\t\t// Ensure it's expanded to show the errors\r\n\t\t\t\tif (container && !container.hasAttribute('open')) {\r\n\t\t\t\t\tcontainer.setAttribute('open', 'true');\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Animate the error messages to draw attention\r\n\t\t\t\tconst errorMessages = container.querySelectorAll('.error-message');\r\n\t\t\t\terrorMessages.forEach(msg => {\r\n\t\t\t\t\tmsg.style.transition = 'background-color 0.5s';\r\n\t\t\t\t\tmsg.style.backgroundColor = 'rgba(240, 173, 78, 0.3)';\r\n\t\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\t\tmsg.style.backgroundColor = 'rgba(217, 83, 79, 0.1)';\r\n\t\t\t\t\t}, 500);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\r\n\t// Display quiz-level error\r\n\tfunction displayQuizError(error) {\r\n\t\tconst quizElement = document.querySelector('.quiz');\r\n\t\tconst errorElement = document.createElement('div');\r\n\t\terrorElement.className = 'error-message';\r\n\t\terrorElement.textContent = improveValidationErrorMessage(error);\r\n\r\n\t\t// Insert after the header\r\n\t\tconst header = quizElement.querySelector('header');\r\n\t\theader.parentNode.insertBefore(errorElement, header.nextSibling);\r\n\r\n\t\t// Also highlight the quiz title if it's empty\r\n\t\tif (error.message.includes('title')) {\r\n\t\t\tconst titleInput = document.getElementById('quiz-title');\r\n\t\t\ttitleInput.classList.add('error-field');\r\n\t\t\ttitleInput.title = error.message;\r\n\t\t}\r\n\t}\r\n\r\n\t// Display round-level error\r\n\tfunction displayRoundError(roundIndex, field, error) {\r\n\t\tconst rounds = document.querySelectorAll('.round');\r\n\t\tif (roundIndex >= 0 && roundIndex < rounds.length) {\r\n\t\t\tconst roundElement = rounds[roundIndex];\r\n\r\n\t\t\t// Open the round to show the error\r\n\t\t\troundElement.open = true;\r\n\r\n\t\t\t// Create error message\r\n\t\t\tconst errorElement = document.createElement('div');\r\n\t\t\terrorElement.className = 'error-message';\r\n\t\t\terrorElement.textContent = improveValidationErrorMessage(error);\r\n\r\n\t\t\t// Insert after the header\r\n\t\t\tconst header = roundElement.querySelector('.card-header');\r\n\t\t\tif (header) {\r\n\t\t\t\theader.parentNode.insertBefore(errorElement, header.nextSibling);\r\n\t\t\t}\r\n\r\n\t\t\t// Highlight specific fields based on the error message\r\n\t\t\tlet titleInput = null;\r\n\t\t\tif (error.message.includes('title')) {\r\n\t\t\t\ttitleInput = roundElement.querySelector('.round-title');\r\n\t\t\t}\r\n\t\t\tif (error.instancePath.includes('roundTimer')) {\r\n\t\t\t\ttitleInput = roundElement.querySelector('[data-field=\"round-timer\"]');\r\n\t\t\t}\r\n\t\t\tif (error.instancePath.includes('updateScores')) {\r\n\t\t\t\ttitleInput = roundElement.querySelector('[data-field=\"update-scores\"]');\r\n\t\t\t}\r\n\t\t\tif (error.instancePath.includes('showAnswer')) {\r\n\t\t\t\ttitleInput = roundElement.querySelector('[data-field=\"show-answer\"]');\r\n\t\t\t}\r\n\t\t\tif (titleInput) {\r\n\t\t\t\ttitleInput.classList.add('error-field');\r\n\t\t\t\ttitleInput.title = error.message;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t// Display question-level error\r\n\tfunction displayQuestionError(roundIndex, questionIndex, field, error) {\r\n\t\tconst rounds = document.querySelectorAll('.round');\r\n\t\tif (roundIndex >= 0 && roundIndex < rounds.length) {\r\n\t\t\tconst roundElement = rounds[roundIndex];\r\n\t\t\tconst questions = roundElement.querySelectorAll('.question');\r\n\r\n\t\t\tif (questionIndex >= 0 && questionIndex < questions.length) {\r\n\t\t\t\tconst questionElement = questions[questionIndex];\r\n\r\n\t\t\t\t// Open the round and question to show the error\r\n\t\t\t\troundElement.open = true;\r\n\t\t\t\tquestionElement.open = true;\r\n\r\n\t\t\t\t// Create error message\r\n\t\t\t\tconst errorElement = document.createElement('div');\r\n\t\t\t\terrorElement.className = 'error-message';\r\n\t\t\t\terrorElement.textContent = improveValidationErrorMessage(error);\r\n\r\n\t\t\t\t// Insert after the header\r\n\t\t\t\tconst header = questionElement.querySelector('.card-header');\r\n\t\t\t\tif (header) {\r\n\t\t\t\t\theader.parentNode.insertBefore(errorElement, header.nextSibling);\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Highlight specific field based on the error\r\n\t\t\t\tif (field) {\r\n\t\t\t\t\tconst fieldElement = questionElement.querySelector(`[data-field=\"${field}\"]`);\r\n\t\t\t\t\tif (fieldElement) {\r\n\t\t\t\t\t\tfieldElement.classList.add('error-field');\r\n\t\t\t\t\t\tfieldElement.title = error.message;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (error.message.includes('text')) {\r\n\t\t\t\t\tconst textInput = questionElement.querySelector('[data-field=\"question-text\"]');\r\n\t\t\t\t\ttextInput.classList.add('error-field');\r\n\t\t\t\t\ttextInput.title = error.message;\r\n\t\t\t\t} else if (error.message.includes('answer')) {\r\n\t\t\t\t\tconst answerInput = questionElement.querySelector('[data-field=\"answer\"]');\r\n\t\t\t\t\tif (answerInput) {\r\n\t\t\t\t\t\tanswerInput.classList.add('error-field');\r\n\t\t\t\t\t\tanswerInput.title = error.message;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfunction gatherQuestionData(questionElement) {\r\n\t\tconst type = questionElement.querySelector('.question-type').value;\r\n\t\tconst baseData = {\r\n\t\t\ttype: type,\r\n\t\t\t_id: questionElement.querySelector('.question-id').value,\r\n\t\t\townerID: questionElement.querySelector('.question-owner').value,\r\n\t\t\ttext: questionElement.querySelector('[data-field=\"question-text\"]').value,\r\n\t\t\timage: questionElement.querySelector('[data-field=\"question-image\"]').getAttribute('src'),\r\n\t\t\taudio: questionElement.querySelector('[data-field=\"question-audio\"]').value,\r\n\t\t\tanswer: null,\r\n\t\t\toptions: [],\r\n\t\t\tpairs: [],\r\n\t\t\titems: [],\r\n\t\t\textra: {}\r\n\t\t};\r\n\r\n\t\tconsole.log('gatherQuestionData:', type, baseData);\r\n\r\n\t\tswitch (type) {\r\n\r\n\t\t\tcase 'multiple-choice':\r\n\t\t\t\tlet options = [\r\n\t\t\t\t\tquestionElement.querySelector('[data-field=\"option-1\"]').value,\r\n\t\t\t\t\tquestionElement.querySelector('[data-field=\"option-2\"]').value,\r\n\t\t\t\t\tquestionElement.querySelector('[data-field=\"option-3\"]').value,\r\n\t\t\t\t\tquestionElement.querySelector('[data-field=\"option-4\"]').value,\r\n\t\t\t\t\tquestionElement.querySelector('[data-field=\"option-5\"]').value,\r\n\t\t\t\t\tquestionElement.querySelector('[data-field=\"option-6\"]').value,\r\n\t\t\t\t\tquestionElement.querySelector('[data-field=\"option-7\"]').value,\r\n\t\t\t\t\tquestionElement.querySelector('[data-field=\"option-8\"]').value\r\n\t\t\t\t];\r\n\t\t\t\tbaseData.options = options.filter((option) => { return option != \"\"; });\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase 'true-false':\r\n\t\t\t\tbaseData.answer = questionElement.querySelector('[data-field=\"answer\"]').value;\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase 'text':\r\n\t\t\t\tbaseData.answer = questionElement.querySelector('[data-field=\"answer\"]').value;\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase 'number-exact':\r\n\t\t\tcase 'number-closest':\r\n\t\t\tcase 'number-average':\r\n\t\t\t\tconst numValue = questionElement.querySelector('[data-field=\"answer\"]').value;\r\n\t\t\t\tbaseData.answer = numValue !== '' ? Number(numValue) : null;\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase 'matching':\r\n\t\t\t\tconst pairs = Array.from([1, 2, 3, 4, 5]).map(index => ({\r\n\t\t\t\t\tleft: questionElement.querySelector(`[data-field=\"left-${index}\"]`).value,\r\n\t\t\t\t\tright: questionElement.querySelector(`[data-field=\"right-${index}\"]`).value\r\n\t\t\t\t}));\r\n\t\t\t\tbaseData.pairs = pairs.filter((pair) => { return pair.left != \"\"; });\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase 'ordering':\r\n\t\t\t\tbaseData.extra = {};\r\n\t\t\t\tbaseData.extra.startLabel = questionElement.querySelector('[data-field=\"order-start\"]').value;\r\n\t\t\t\tbaseData.extra.endLabel = questionElement.querySelector('[data-field=\"order-end\"]').value;\r\n\t\t\t\tconst items = Array.from(questionElement.querySelectorAll('[data-field=\"order-item\"]')).map(input => input.value);\r\n\t\t\t\tbaseData.items = items.filter((item) => { return item != \"\"; });\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase 'hotspot':\r\n\t\t\t\t// Convert the values to numbers using '+' - send null if x not set\r\n\t\t\t\tconsole.log('gatherQuestionData: hotspot:', questionElement.querySelector('[data-field=\"hotspot-x\"]').value);\r\n\t\t\t\tbaseData.answer = questionElement.querySelector('[data-field=\"hotspot-x\"]').value ? {\r\n\t\t\t\t\tx: +questionElement.querySelector('[data-field=\"hotspot-x\"]').value,\r\n\t\t\t\t\ty: +questionElement.querySelector('[data-field=\"hotspot-y\"]').value\r\n\t\t\t\t} : null;\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase 'point-it-out':\r\n\t\t\t\tbaseData.answer = {\r\n\t\t\t\t\tstart: {\r\n\t\t\t\t\t\tx: +questionElement.querySelector('[data-field=\"point-it-out-startx\"]').value,\r\n\t\t\t\t\t\ty: +questionElement.querySelector('[data-field=\"point-it-out-starty\"]').value\r\n\t\t\t\t\t},\r\n\t\t\t\t\tend: {\r\n\t\t\t\t\t\tx: +questionElement.querySelector('[data-field=\"point-it-out-endx\"]').value,\r\n\t\t\t\t\t\ty: +questionElement.querySelector('[data-field=\"point-it-out-endy\"]').value\r\n\t\t\t\t\t}\r\n\t\t\t\t};\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase 'draw':\r\n\t\t\t\tbaseData.answer = questionElement.querySelector('[data-field=\"answer\"]').value;\r\n\t\t\t\tbreak;\r\n\r\n\t\t}\r\n\r\n\t\treturn baseData;\r\n\t}\r\n\r\n\t// Function to validate quiz against schema via API\r\n\tasync function validateQuizSchema(quizJSON) {\r\n\t\ttry {\r\n\t\t\tconst response = await fetch('/api/quiz/validate', {\r\n\t\t\t\tmethod: 'POST',\r\n\t\t\t\theaders: {\r\n\t\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t\t\t// Add any authentication headers needed\r\n\t\t\t\t},\r\n\t\t\t\tbody: JSON.stringify(quizJSON)\r\n\t\t\t});\r\n\r\n\t\t\tif (!response.ok) {\r\n\t\t\t\tthrow new Error(`Server returned ${response.status}: ${response.statusText}`);\r\n\t\t\t}\r\n\r\n\t\t\tconst result = await response.json();\r\n\t\t\treturn result.data; // Access the data property of your apiResponse\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(\"Validation request failed:\", error);\r\n\t\t\tthrow error;\r\n\t\t}\r\n\t}\r\n\r\n\t// Function to display schema validation errors in a user-friendly way\r\n\tfunction displaySchemaErrors(errors, quizJSON) {\r\n\t\t// Create modal or popup for errors\r\n\t\tconst errorDiv = document.createElement('div');\r\n\t\terrorDiv.className = 'validation-errors';\r\n\r\n\t\t// Create header\r\n\t\tconst header = document.createElement('h3');\r\n\t\theader.textContent = 'Quiz Validation Errors';\r\n\t\terrorDiv.appendChild(header);\r\n\r\n\t\t// Create error list\r\n\t\tconst errorList = document.createElement('ul');\r\n\r\n\t\t// Process and group errors\r\n\t\terrors.forEach(error => {\r\n\t\t\tconst errorItem = document.createElement('li');\r\n\t\t\terrorItem.className = 'error-item';\r\n\r\n\t\t\t// Format the error message based on error type\r\n\t\t\tlet message = '';\r\n\t\t\tlet path = error.instancePath || '';\r\n\r\n\t\t\t// Remove leading slash from path\r\n\t\t\tif (path.startsWith('/')) {\r\n\t\t\t\tpath = path.substring(1);\r\n\t\t\t}\r\n\r\n\t\t\t// Convert JSON path to readable location\r\n\t\t\tconst pathParts = path.split('/');\r\n\t\t\tlet humanPath = '';\r\n\r\n\t\t\tif (pathParts.length > 0 && pathParts[0] !== '') {\r\n\t\t\t\tif (pathParts[0] === 'rounds') {\r\n\t\t\t\t\t// For round errors, show round title if available\r\n\t\t\t\t\tconst roundIndex = parseInt(pathParts[1], 10);\r\n\t\t\t\t\tconst roundTitle = quizJSON.rounds?.[roundIndex]?.title || `Round ${roundIndex + 1}`;\r\n\t\t\t\t\thumanPath = `Round: \"${roundTitle}\"`;\r\n\r\n\t\t\t\t\t// For question errors, add question info\r\n\t\t\t\t\tif (pathParts[2] === 'questions') {\r\n\t\t\t\t\t\tconst questionIndex = parseInt(pathParts[3], 10);\r\n\t\t\t\t\t\tconst questionText = quizJSON.rounds?.[roundIndex]?.questions?.[questionIndex]?.text ||\r\n\t\t\t\t\t\t\t`Question ${questionIndex + 1}`;\r\n\t\t\t\t\t\thumanPath += `  Question: \"${questionText.substring(0, 30)}${questionText.length > 30 ? '...' : ''}\"`;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\thumanPath = pathParts.join('  ');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// Format by error keyword\r\n\t\t\tswitch (error.keyword) {\r\n\t\t\t\tcase 'required':\r\n\t\t\t\t\tmessage = `Missing required field: ${error.params.missingProperty}`;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 'enum':\r\n\t\t\t\t\tmessage = `Invalid value. Must be one of: ${error.params.allowedValues.join(', ')}`;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 'type':\r\n\t\t\t\t\tmessage = `Expected type ${error.params.type} but got ${typeof error.data}`;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tmessage = error.message;\r\n\t\t\t}\r\n\r\n\t\t\t// Construct the full error message\r\n\t\t\terrorItem.innerHTML = humanPath ?\r\n\t\t\t\t`<strong>${humanPath}:</strong> ${message}` : message;\r\n\r\n\t\t\terrorList.appendChild(errorItem);\r\n\t\t});\r\n\r\n\t\terrorDiv.appendChild(errorList);\r\n\r\n\t\t// Add to page as modal or replace any existing error display\r\n\t\tconst existingErrors = document.querySelector('.validation-errors');\r\n\t\tif (existingErrors) {\r\n\t\t\texistingErrors.remove();\r\n\t\t}\r\n\r\n\t\t// Create a simple modal wrapper\r\n\t\tconst modalWrapper = document.createElement('div');\r\n\t\tmodalWrapper.className = 'error-modal-wrapper';\r\n\t\tmodalWrapper.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; display:flex; justify-content:center; align-items:center;';\r\n\r\n\t\t// Style the error div as a modal\r\n\t\terrorDiv.style.cssText = 'background:white; border-radius:8px; padding:20px; max-width:80%; max-height:80%; overflow-y:auto; box-shadow:0 4px 8px rgba(0,0,0,0.2);';\r\n\r\n\t\t// Add close button\r\n\t\tconst closeBtn = document.createElement('button');\r\n\t\tcloseBtn.textContent = 'Close';\r\n\t\tcloseBtn.style.cssText = 'padding:8px 16px; background:#f44336; color:white; border:none; border-radius:4px; margin-top:15px; cursor:pointer;';\r\n\t\tcloseBtn.onclick = () => modalWrapper.remove();\r\n\t\terrorDiv.appendChild(closeBtn);\r\n\r\n\t\t// Add modal to page\r\n\t\tmodalWrapper.appendChild(errorDiv);\r\n\t\tdocument.body.appendChild(modalWrapper);\r\n\t}\r\n\r\n\tasync function createQuizFromJSON(quizJSON) {\r\n\t\tconsole.log('createQuizFromJSON:', quizJSON);\r\n\r\n\t\ttry {\r\n\t\t\t// Several steps here when parsing and building a quiz from JSON data\r\n\t\t\tquizJSON = normalizeQuizData(quizJSON);\r\n\r\n\t\t\t// Validate the basic structure of the quiz - this ensures it will still render in the editor\r\n\t\t\tquizJSON = validateQuizStructure(quizJSON);\r\n\r\n\t\t\tconsole.table(quizJSON);\r\n\r\n\t\t\t// Validate the quiz JSON against the schema via API\r\n\t\t\tconst validation = await validateQuizSchema(quizJSON);\r\n\t\t\tconsole.log('Validation result:', validation);\r\n\t\t\tquizJSON.validation = validation.errors || [];\r\n\r\n\t\t\t// if (!validation.valid) {\r\n\t\t\t// \t// Display validation errors in a user-friendly way\r\n\t\t\t// \tdisplaySchemaErrors(validation.errors, quizJSON);\r\n\t\t\t// }\r\n\r\n\t\t\t// Ragardless of the validation result we still want to show the quiz in the editor\r\n\t\t\t// The user can then fix any issues highlighted by the validation\r\n\t\t\tpopulateQuizWithData(quizJSON);\r\n\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error('Error during validation:', error);\r\n\t\t\talert('An error occurred during quiz validation. Please check the console for details.');\r\n\t\t\t// Still show the HTML quiz even though validation failed\r\n\t\t\tpopulateQuizWithData(quizJSON);\r\n\t\t}\r\n\t}\r\n\r\n\t// Normalize data types in the quiz JSON to ensure consistency\r\n\t// This is like another layer of validation\r\n\tfunction normalizeQuizData(quizJSON) {\r\n\t\tif (quizJSON.rounds && Array.isArray(quizJSON.rounds)) {\r\n\t\t\tquizJSON.rounds.forEach(round => {\r\n\t\t\t\tif (round.questions && Array.isArray(round.questions)) {\r\n\t\t\t\t\tround.questions.forEach(question => {\r\n\t\t\t\t\t\tconsole.log('Normalizing question:', question);\r\n\t\t\t\t\t\t// Convert true-false from boolean to string if needed\r\n\t\t\t\t\t\tif (question.type === 'true-false' && typeof question.answer === 'boolean') {\r\n\t\t\t\t\t\t\tquestion.answer = question.answer ? 'true' : 'false';\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t// Add this debug code\r\n\t\t\t\t\t\tif (question.type === 'true-false') {\r\n\t\t\t\t\t\t\tconsole.log('True-false question answer:',\r\n\t\t\t\t\t\t\t\tquestion.answer,\r\n\t\t\t\t\t\t\t\t'Type:', typeof question.answer);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t// Convert number types from string to number if needed\r\n\t\t\t\t\t\tif ((question.type === 'number-exact' || question.type === 'number-closest' || question.type === 'number-average') &&\r\n\t\t\t\t\t\t\ttypeof question.answer === 'string' && question.answer !== '') {\r\n\t\t\t\t\t\t\tquestion.answer = Number(question.answer);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\treturn quizJSON;\r\n\t}\r\n\r\n\tfunction validateQuizStructure(quizJSON) {\r\n\r\n\t\t// Ensure top-level arrays exist (but don't add content)\r\n\t\tquizJSON.rounds = quizJSON.rounds || [];\r\n\r\n\t\t// Process each round to ensure structure\r\n\t\tquizJSON.rounds.forEach(round => {\r\n\t\t\t// Ensure questions array exists\r\n\t\t\tround.questions = round.questions || [];\r\n\r\n\t\t\t// Ensure each question has the basic structure needed to render\r\n\t\t\tround.questions.forEach(question => {\r\n\t\t\t\t// Only ensure properties needed for UI rendering\r\n\t\t\t\t// Don't add default values that would hide validation issues\r\n\r\n\t\t\t\t// For example, ensure multiple-choice has options array\r\n\t\t\t\t// but don't populate it with defaults\r\n\t\t\t\tif (question.type === 'multiple-choice') {\r\n\t\t\t\t\tquestion.options = question.options || [];\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Ensure matching has pairs array\r\n\t\t\t\tif (question.type === 'matching') {\r\n\t\t\t\t\tquestion.pairs = question.pairs || [];\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Ensure ordering has items array and extra object\r\n\t\t\t\tif (question.type === 'ordering') {\r\n\t\t\t\t\tquestion.items = question.items || [];\r\n\t\t\t\t\tquestion.extra = question.extra || {};\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Ensure point-it-out has answer structure\r\n\t\t\t\tif (question.type === 'point-it-out' && question.answer) {\r\n\t\t\t\t\tquestion.answer.start = question.answer.start || {};\r\n\t\t\t\t\tquestion.answer.end = question.answer.end || {};\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\treturn quizJSON;\r\n\t}\r\n\r\n\tfunction populateQuizWithData(quizJSON) {\r\n\t\tconsole.log('populateQuizWithData:', quizJSON);\r\n\r\n\t\tdocument.getElementById('quiz-json').value = JSON.stringify(quizJSON, null, 2);\r\n\t\tdocument.getElementById('quiz-id').value = quizJSON._id || \"\";\r\n\t\tdocument.getElementById('quiz-owner').value = quizJSON.ownerID || \"\";\r\n\t\tdocument.getElementById('quiz-schema-version').value = quizJSON.schemaVersion || \"\";\r\n\t\t\r\n\t\tconst quizHeaderTitle = document.getElementById('quiz-edit').querySelector('.header-title');\r\n\t\tif (quizHeaderTitle) quizHeaderTitle.textContent = quizJSON.title;\r\n\t\t\r\n\t\tdocument.getElementById('quiz-title').value = quizJSON.title;\r\n\t\tdocument.getElementById('quiz-description').value = quizJSON.description || \"\";\r\n\r\n\t\troundsContainer.innerHTML = '';\r\n\t\tquizJSON.rounds.forEach(roundJSON => {\r\n\t\t\taddRoundToDOM();\r\n\t\t\tconst roundElement = roundsContainer.lastElementChild;\r\n\t\t\troundElement.querySelector('.header-title').textContent = roundJSON.title || \"\";\r\n\t\t\troundElement.querySelector('.round-title').value = roundJSON.title || \"\";\r\n\t\t\troundElement.querySelector('.round-description').value = roundJSON.description || \"\";\r\n\t\t\troundElement.querySelector('.round-id').value = roundJSON._id || \"\";\r\n\t\t\troundElement.querySelector('.round-owner').value = roundJSON.ownerID || \"\";\r\n\t\t\tconst rt = roundElement.querySelector('[data-field=\"round-timer\"]');\r\n\t\t\troundElement.querySelector('[data-field=\"round-timer\"]').value = roundJSON.roundTimer;\r\n\t\t\troundElement.querySelector('[data-field=\"show-answer\"]').value = roundJSON.showAnswer;\r\n\t\t\troundElement.querySelector('[data-field=\"update-scores\"]').value = roundJSON.updateScores;\r\n\r\n\t\t\tconst questionsContainer = roundElement.querySelector('.questions-container');\r\n\t\t\troundJSON.questions.forEach(questionJSON => {\r\n\r\n\t\t\t\t// Add a basic question template to the DOM, which we will then populate with the question data\r\n\t\t\t\taddQuestionToDOM(questionsContainer);\r\n\t\t\t\tconst questionElement = questionsContainer.lastElementChild;\r\n\r\n\t\t\t\t// We always have a question text field, this is not question-specific\r\n\t\t\t\tquestionElement.querySelector('[data-field=\"question-text\"]').value = questionJSON.text;\r\n\t\t\t\tquestionElement.querySelector('.header-title').textContent = questionJSON.text;\r\n\r\n\t\t\t\t// We also always have an _id and owner (unless its a new question)\r\n\t\t\t\tquestionElement.querySelector('.question-id').value = questionJSON._id || \"\";\r\n\t\t\t\tquestionElement.querySelector('.question-owner').value = questionJSON.ownerID || \"\";\r\n\r\n\t\t\t\t// If we have imageData then we need to set the image selector src\r\n\t\t\t\tif (questionJSON.image) {\r\n\t\t\t\t\tsetImageSelectorSrc(questionElement, questionJSON.image);\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// What about audio?\r\n\t\t\t\tif (questionJSON.audio) {\r\n\t\t\t\t\tconst audioInput = questionElement.querySelector('[data-field=\"question-audio\"]');\r\n\t\t\t\t\taudioInput.value = questionJSON.audio;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Trigger the select chnage event which will insert the correct question type into the questionElement\r\n\t\t\t\tconst typeSelect = questionElement.querySelector('.question-type');\r\n\t\t\t\ttypeSelect.value = questionJSON.type;\r\n\t\t\t\ttypeSelect.dispatchEvent(new Event('change'));  // This will insert the correct question type into the questionElement\r\n\r\n\t\t\t\tconst contentContainer = questionElement.querySelector('.question-specific-content');\r\n\t\t\t\t// contentContainer.querySelector('[data-field=\"question-text\"]').value = question.text || '';\r\n\r\n\t\t\t\tswitch (questionJSON.type) {\r\n\r\n\t\t\t\t\tcase 'multiple-choice':\r\n\t\t\t\t\t\tquestionJSON.options.forEach((option, index) => {\r\n\t\t\t\t\t\t\tcontentContainer.querySelector(`[data-field=\"option-${index + 1}\"]`).value = option || '';\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\tcase 'true-false':\r\n\t\t\t\t\tcase 'text':\r\n\t\t\t\t\tcase 'number-exact':\r\n\t\t\t\t\tcase 'number-closest':\r\n\t\t\t\t\tcase 'number-average':\r\n\t\t\t\t\t\tcontentContainer.querySelector('[data-field=\"answer\"]').value = String(questionJSON.answer) || '';\r\n\t\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\tcase 'matching':\r\n\t\t\t\t\t\tquestionJSON.pairs.forEach((pair, index) => {\r\n\t\t\t\t\t\t\tcontentContainer.querySelector(`[data-field=\"left-${index + 1}\"]`).value = pair.left || '';\r\n\t\t\t\t\t\t\tcontentContainer.querySelector(`[data-field=\"right-${index + 1}\"]`).value = pair.right || '';\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\tcase 'ordering':\r\n\t\t\t\t\t\tconsole.log('Ordering:', questionJSON);\r\n\t\t\t\t\t\tcontentContainer.querySelector('[data-field=\"order-start\"]').value = questionJSON.extra.startLabel || '';\r\n\t\t\t\t\t\tcontentContainer.querySelector('[data-field=\"order-end\"]').value = questionJSON.extra.endLabel || '';\r\n\t\t\t\t\t\tquestionJSON.items.forEach((item, index) => {\r\n\t\t\t\t\t\t\tcontentContainer.querySelectorAll('[data-field=\"order-item\"]')[index].value = item || '';\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\tcase 'hotspot':\r\n\t\t\t\t\t\tif (questionJSON.image) {\r\n\t\t\t\t\t\t\tconst imageSelectorPreview = contentContainer.querySelector(\".image-selector-preview\");\r\n\t\t\t\t\t\t\tif (imageSelectorPreview) {\r\n\t\t\t\t\t\t\t\timageSelectorPreview.setAttribute('src', questionJSON.image || '');\r\n\t\t\t\t\t\t\t\tconsole.log('createQuizFromJSON.setAttribute:answer:', questionJSON.answer);\r\n\t\t\t\t\t\t\t\timageSelectorPreview.setAttribute('answer', JSON.stringify(questionJSON.answer));\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (questionJSON.answer) {\r\n\t\t\t\t\t\t\tcontentContainer.querySelector('[data-field=\"hotspot-x\"]').value = questionJSON.answer.x || '';\r\n\t\t\t\t\t\t\tcontentContainer.querySelector('[data-field=\"hotspot-y\"]').value = questionJSON.answer.y || '';\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\tcase 'point-it-out':\r\n\t\t\t\t\t\tif (questionJSON.image) {\r\n\t\t\t\t\t\t\tconst imageSelectorPreview = contentContainer.querySelector(\".image-selector-preview\");\r\n\t\t\t\t\t\t\tif (imageSelectorPreview) {\r\n\t\t\t\t\t\t\t\timageSelectorPreview.setAttribute('src', questionJSON.image || '');\r\n\t\t\t\t\t\t\t\timageSelectorPreview.setAttribute('answer', JSON.stringify(questionJSON.answer));\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (questionJSON.answer) {\r\n\t\t\t\t\t\t\tcontentContainer.querySelector('[data-field=\"point-it-out-startx\"]').value = questionJSON.answer.start?.x || '';\r\n\t\t\t\t\t\t\tcontentContainer.querySelector('[data-field=\"point-it-out-starty\"]').value = questionJSON.answer.start?.y || '';\r\n\t\t\t\t\t\t\tcontentContainer.querySelector('[data-field=\"point-it-out-endx\"]').value = questionJSON.answer.end?.x || '';\r\n\t\t\t\t\t\t\tcontentContainer.querySelector('[data-field=\"point-it-out-endy\"]').value = questionJSON.answer.end?.y || '';\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcontentContainer.querySelector('[data-field=\"hotspot-x\"]').value = questionJSON.answer.x || '';\r\n\t\t\t\t\t\tcontentContainer.querySelector('[data-field=\"hotspot-y\"]').value = questionJSON.answer.y || '';\r\n\t\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\tcase 'point-it-out':\r\n\t\t\t\t\t\tif (questionJSON.image) {\r\n\t\t\t\t\t\t\tconst imageSelectorPreview = contentContainer.querySelector(\".image-selector-preview\");\r\n\t\t\t\t\t\t\tif (imageSelectorPreview) {\r\n\t\t\t\t\t\t\t\timageSelectorPreview.setAttribute('src', questionJSON.image || '');\r\n\t\t\t\t\t\t\t\timageSelectorPreview.setAttribute('answer', JSON.stringify(questionJSON.answer));\r\n\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tcontentContainer.querySelector('[data-field=\"point-it-out-startx\"]').value = questionJSON.answer.start.x || '';\r\n\t\t\t\t\t\tcontentContainer.querySelector('[data-field=\"point-it-out-starty\"]').value = questionJSON.answer.start.y || '';\r\n\t\t\t\t\t\tcontentContainer.querySelector('[data-field=\"point-it-out-endx\"]').value = questionJSON.answer.end.x || '';\r\n\t\t\t\t\t\tcontentContainer.querySelector('[data-field=\"point-it-out-endy\"]').value = questionJSON.answer.end.y || '';\r\n\t\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\tcase 'draw':\r\n\t\t\t\t\t\tcontentContainer.querySelector('[data-field=\"answer\"]').value = questionJSON.answer || '';\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\t// Start with all rounds and questions collapsed (all details children of main quiz summary element)\r\n\t\t// const allDetails = summaryElement.querySelectorAll('details');\r\n\t\t// allDetails.forEach(detail => {\r\n\t\t// \tdetail.removeAttribute('open');\r\n\t\t// });\r\n\t\t// Ensure all rounds and questions are collapsed when loading from JSON\r\n\t\tdocument.querySelectorAll('.round, .question').forEach(element => {\r\n\t\t\telement.removeAttribute('open');\r\n\t\t});\r\n\t\taddRoundQuestionNumbers();\r\n\r\n\t\t// Hide the quiz list and show the quiz\r\n\t\tdocument.getElementById('quiz-edit').style.display = 'block';\r\n\r\n\t\t// Display any validation errors - including the summary at the top of the quiz\r\n\t\tdisplayValidationErrors(quizJSON.validation);\r\n\r\n\t\t// Set up change tracking after quiz is loaded\r\n\t\tsetupChangeTracking();\r\n\t\tresetSaveChanges();\r\n\t}\r\n\r\n\r\n\tfunction setupChangeTracking() {\r\n\r\n\t\t// Remove any existing listeners from the document\r\n\t\tdocument.removeEventListener('change', handleFormChanges);\r\n\t\tdocument.removeEventListener('input', handleFormChanges);\r\n\t\tdocument.removeEventListener('click', handleButtonClicks);\r\n\r\n\t\t// Add single listeners using event delegation\r\n\t\tdocument.addEventListener('change', handleFormChanges);\r\n\t\tdocument.addEventListener('input', handleFormChanges);\r\n\t\tdocument.addEventListener('click', handleButtonClicks);\r\n\t}\r\n\r\n\tfunction handleFormChanges(event) {\r\n\t\t// Check if the event came from a form element we care about\r\n\t\tif (event.target.matches('input, textarea, select')) {\r\n\t\t\tmarkAsChanged();\r\n\t\t}\r\n\t}\r\n\r\n\tfunction handleButtonClicks(event) {\r\n\t\t// Use closest to handle clicks on icons/SVG inside buttons\r\n\t\tconst btn = event.target.closest('button');\r\n\t\tif (!btn) return;\r\n\r\n\t\t// Check if the event came from a button we care about\r\n\t\tconst buttonClasses = ['question-btn', 'delete-btn', 'select-image-btn', 'clear-image-btn'];\r\n\t\tconst isActionBtn = btn.id === 'add-round' || \r\n\t\t\t\t\t\t   buttonClasses.some(cls => btn.classList.contains(cls));\r\n\r\n\t\tif (isActionBtn) {\r\n\t\t\tmarkAsChanged();\r\n\t\t}\r\n\t}\r\n\r\n\r\n\t// Reset change tracking after save\r\n\tfunction resetSaveChanges() {\r\n\t\thasUnsavedChanges = false;\r\n\t\tupdateSaveButton();\r\n\t}\r\n\r\n\r\n\t// Mark quiz as changed\r\n\tfunction markAsChanged() {\r\n\t\tconsole.log('markAsChanged called...');\r\n\t\thasUnsavedChanges = true;\r\n\t\tupdateSaveButton();\r\n\t}\r\n\r\n\t// Update save button to indicate unsaved changes\r\n\tfunction updateSaveButton() {\r\n\t\tconst saveButtons = document.querySelectorAll('.save-quiz-btn');\r\n\t\tif (hasUnsavedChanges) {\r\n\t\t\tsaveButtons.forEach(btn => btn.classList.add('unsaved-changes'));\r\n\t\t} else {\r\n\t\t\tsaveButtons.forEach(btn => btn.classList.remove('unsaved-changes'));\r\n\t\t}\r\n\t}\r\n\r\n\r\n\tfunction backToQuizList() {\r\n\t\t// Always redirect to the quiz list page (modular navigation)\r\n\t\twindow.location.href = '/host/dashboard/quiz.html';\r\n\t}\r\n}\r\n"],"names":["FileDropzone","constructor","options","this","element","accept","multiple","maxSize","onDrop","onError","hoverClass","document","querySelector","fileInput","createElement","type","style","display","appendChild","init","console","error","addEventListener","e","target","click","handleFiles","files","preventDefault","stopPropagation","classList","add","remove","dataTransfer","length","validFiles","Array","from","filter","file","size","triggerError","name","acceptTypes","split","map","trim","fileType","fileExtension","pop","some","startsWith","toLowerCase","endsWith","typeGroup","value","message","ImageLibrary","onSelect","modalTitle","selectedImage","createModal","modal","className","innerHTML","body","initEventListeners","initDropzone","close","imageItem","closest","id","dataset","url","uploadImage","show","loadImages","grid","response","fetch","result","json","success","renderImages","data","images","forEach","image","item","_id","originalName","querySelectorAll","btn","handleImageDelete","imageId","confirm","method","alert","formData","FormData","append","currentContent","ImageSelector","HTMLElement","super","_image","_canvas","_ctx","_isDrawing","_isMoving","_startX","_startY","_mode","_answer","_src","_connected","_resizeObserver","ResizeObserver","_handleResize","bind","_scale","_offsetX","_offsetY","observedAttributes","connectedCallback","log","isConnected","render","setupCanvas","observe","setupEventListeners","disconnectedCallback","unobserve","attributeChangedCallback","oldValue","newValue","setImage","JSON","parse","_redrawCanvas","getAttribute","getContext","onload","imageAspectRatio","naturalWidth","naturalHeight","containerWidth","parentElement","clientWidth","containerHeight","clientHeight","imageWidth","imageHeight","width","height","left","top","_adjustCanvasSize","handlePointerDown","handlePointerMove","handlePointerUp","handleTouchStart","handleTouchEnd","handleWheel","event","x","y","clientToCanvas","clientX","clientY","_touchStart","diffX","diffY","updateTransform","drawRect","canvasPos","imagePos","clientToImage","containerPos","clientToContainer","drawCross","selection","canvasToNormalized","leftX","Math","min","rightX","max","topY","bottomY","start","end","dispatchEvent","CustomEvent","detail","touches","_lastTouchDistance","getTouchDistance","_isZooming","touch","handleTouchMove","currentDistance","scaleDiff","midX","midY","mouseX","mouseY","containerX","containerY","newScale","hypot","x1","y1","x2","y2","fillStyle","clearRect","fillRect","crossSize","strokeStyle","lineWidth","beginPath","moveTo","lineTo","stroke","zoomFactor","deltaY","transform","src","renderImage","setCursorType","complete","rect","getBoundingClientRect","window","innerWidth","normalizedToCanvas","startCanvasPos","endCanvasPos","imageX","imageY","imageToCanvas","imageToContainer","scaleX","scaleY","round","initDashboardQuizEdit","roundsContainer","getElementById","hostQuizButton","addRoundButton","quizTitle","saveQuizButtons","backToQuizListButton","quizID","location","href","addRoundToDOM","updateHeaderWithTitle","saveQuiz","async","matches","questionElement","imagePreview","imageUrlField","previewContainer","clearBtn","setImageSelectorSrc","contains","elementToRemove","roundId","quizId","headers","addRoundQuestionNumbers","URLSearchParams","search","get","createQuizFromJSON","err","title","description","rounds","loadQuizOnEntry","container","hasAttribute","setAttribute","msg","transition","backgroundColor","setTimeout","Sortable","animation","handle","onSort","evt","markAsChanged","hasUnsavedChanges","quizJSON","schemaVersion","ownerID","roundElement","roundTimer","showAnswer","updateScores","questions","baseData","text","audio","answer","pairs","items","extra","option","numValue","Number","index","right","pair","startLabel","endLabel","input","gatherQuestionData","createJSONfromQuiz","textContent","stringify","validation","validateQuizSchema","valid","displayValidationErrors","errors","saveQuizTimeout","clearTimeout","addCollapseAll","summaryElement","details","parentNode","removeAttribute","content","cloneNode","questionsContainer","addQuestionToDOM","summary","group","scroll","scrollSensitivity","questionNumber","children","questionTypeChangeListener","handleQuestionTypeChange","handleExternalImageURL","contentContainer","questionType","questionHint","questionImage","imageSelectorSelection","questionIndex","headerToUpdate","titleEl","preview","improveValidationErrorMessage","originalMessage","path","instancePath","pathParts","includes","roundIndex","parseInt","indexOf","questionData","question","property","match","correctOption","validationResults","errorSummary","el","count","clearValidationErrors","roundErrors","questionErrors","errorCount","shift","quizElement","errorElement","header","insertBefore","nextSibling","titleInput","displayQuizError","push","field","open","displayRoundError","fieldElement","textInput","answerInput","displayQuestionError","Object","keys","indicator","addRoundErrorIndicator","addQuestionErrorIndicator","ok","Error","status","statusText","validateQuizStructure","isArray","normalizeQuizData","table","populateQuizWithData","quizHeaderTitle","roundJSON","lastElementChild","questionJSON","typeSelect","Event","String","imageSelectorPreview","removeEventListener","handleFormChanges","handleButtonClicks","updateSaveButton","cls","saveButtons","returnValue","customElements","define"],"mappings":"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"}