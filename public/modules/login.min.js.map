{"version":3,"file":"login.min.js","sources":["../../src/scripts/login.js"],"sourcesContent":["let isSignupMode = false;\r\nlet forgotPasswordMode = false;\r\n\r\n// Utility function to handle responses\r\n// This function relies on the fetch API returning a JSON object containing a response.ok property\r\n// status is the code sent by the server (usually 200, 400, 401)\r\nconst handleResponse = (response) => {\r\n    return {\r\n        success: response.ok,\r\n        status: response.status\r\n    };\r\n};\r\n\r\n// Utility function to display messages\r\nconst displayMessage = (message, isError = false) => {\r\n    const messageElement = document.getElementById('message');\r\n    if (messageElement) {\r\n        messageElement.innerHTML = message;\r\n        messageElement.className = isError ? 'error' : 'success';\r\n        messageElement.style.display = 'block';\r\n    } else {\r\n        alert(message); // Fallback if message element doesn't exist\r\n    }\r\n};\r\n\r\n// Function to toggle between login and signup\r\n// If we are already in forgotpassword mode then we always go back to sign in\r\nconst toggleAuthMode = () => {\r\n    if (forgotPasswordMode) {\r\n        forgotPasswordMode = !forgotPasswordMode;\r\n        isSignupMode = false;\r\n    } else {\r\n        isSignupMode = !isSignupMode;\r\n    }\r\n    layoutMode();\r\n};\r\n// Function to set the forgot password mode\r\nconst setForgotPasswordMode = () => {\r\n    forgotPasswordMode = true;\r\n    layoutMode();\r\n};\r\n\r\n// Function to layout the form based on the mode\r\nconst layoutMode = () => {\r\n    const formTitle = document.getElementById('formTitle');\r\n    const submitButton = document.getElementById('submitButton');\r\n    const switchMessage = document.getElementById('switchMessage');\r\n    const switchButton = document.getElementById('switchButton') || document.getElementById('switchLink');\r\n    const socialButtons = document.getElementById('socialButtons');\r\n    const passwordInput = document.getElementById('password');\r\n    const forgotPasswordLink = document.getElementById('forgotPassword');\r\n\r\n    if (forgotPasswordMode) {\r\n        if (formTitle) formTitle.textContent = 'Forgotten password?';\r\n        if (submitButton) submitButton.textContent = 'Send reset email';\r\n        if (switchButton) switchButton.textContent = 'Back to Sign In';\r\n        if (switchMessage) switchMessage.textContent = '';\r\n        if (socialButtons) socialButtons.style.display = 'none';\r\n        if (passwordInput) {\r\n            passwordInput.style.display = 'none';\r\n            passwordInput.required = false;\r\n        }\r\n        if (forgotPasswordLink) forgotPasswordLink.style.display = 'none';\r\n    } else if (isSignupMode) {\r\n        if (formTitle) formTitle.textContent = 'Create an account';\r\n        if (submitButton) submitButton.textContent = 'Sign Up';\r\n        if (switchButton) switchButton.textContent = 'Sign In';\r\n        if (switchMessage) switchMessage.textContent = 'Already have an account?';\r\n        if (socialButtons) socialButtons.style.display = 'none';\r\n        if (passwordInput) {\r\n            passwordInput.style.display = 'block';\r\n            passwordInput.required = true;\r\n        }\r\n        if (forgotPasswordLink) forgotPasswordLink.style.display = 'none';\r\n    } else {\r\n        if (formTitle) formTitle.textContent = 'Sign in to your account';\r\n        if (submitButton) submitButton.textContent = 'Sign In';\r\n        if (switchButton) switchButton.textContent = 'Sign Up';\r\n        if (switchMessage) switchMessage.textContent = 'Don\\'t have an account?';\r\n        if (socialButtons) socialButtons.style.display = 'block';\r\n        if (passwordInput) {\r\n            passwordInput.style.display = 'block';\r\n            passwordInput.required = true;\r\n        }\r\n        if (forgotPasswordLink) forgotPasswordLink.style.display = 'block';\r\n    }\r\n\r\n    // Clear the message element no matter which mode we are in\r\n    const messageElement = document.getElementById('message');\r\n    if (messageElement) {\r\n        messageElement.textContent = '';\r\n        messageElement.style.display = 'none';\r\n    }\r\n};\r\n\r\n\r\n// Function to handle form submission (works regardless of loginMode)\r\nconst handleSubmit = async (event) => {\r\n    event.preventDefault();\r\n    const form = event.target;\r\n    const formData = new FormData(form);\r\n\r\n    const email = formData.get('email');\r\n    const password = formData.get('password');\r\n\r\n    // Logic depends on the mode\r\n    if (!email) {\r\n        displayMessage('Please enter your email', true);\r\n        return;\r\n    }\r\n\r\n    if (!forgotPasswordMode && !password) {\r\n        displayMessage('Please enter your password', true);\r\n        return;\r\n    }\r\n\r\n    // Determine the endpoint based on the mode (forgot password, signup or login)\r\n    const endpoint = forgotPasswordMode ? '/auth/forgot-password' : (isSignupMode ? '/auth/signup' : '/auth/login');\r\n    console.log('Submitting to:', endpoint, email, password);\r\n\r\n    try {\r\n        // OK - this is the fetch API, it's a promise so we need to await it\r\n        const response = await fetch(endpoint, {\r\n            method: \"post\",\r\n            headers: {\r\n                'Content-Type': 'application/json',\r\n            },\r\n            body: JSON.stringify({ email, password }),\r\n        });\r\n\r\n        const { success, status } = handleResponse(response);\r\n        console.log('handleSubmit response:', success, status, response);\r\n\r\n        if (success) {\r\n\r\n            // If forgot-password flow then we need to terminate the flow here...\r\n            if (forgotPasswordMode) {\r\n                terminateForgotPasswordFlow();\r\n            } else {\r\n                // Check for redirect parameter\r\n                const urlParams = new URLSearchParams(window.location.search);\r\n                const redirect = urlParams.get('redirect');\r\n                \r\n                if (redirect) {\r\n                    window.location.href = decodeURIComponent(redirect);\r\n                } else {\r\n                    // If it's a successful login or registration, redirect to dashboard\r\n                    window.location.href = '/host/dashboard';\r\n                }\r\n                console.log('Redirecting after login/signup');\r\n            }\r\n        } else {\r\n            // Handle different types of errors based on status codes\r\n            switch (status) {\r\n                case 401:\r\n                    displayMessage('Unknown email/password combination', true);\r\n                    break;\r\n                case 409:\r\n                    displayMessage(\"Email already in our system :(<br>Have you forgotten your password? Try the link below...\", true);\r\n                    break;\r\n                case 422:\r\n                    displayMessage('Invalid input. Please check your email and password.', true);\r\n                    break;\r\n                default:\r\n                    displayMessage(data.message || 'An error occurred. Please try again.', true);\r\n            }\r\n        }\r\n    } catch (error) {\r\n        // This catch block will now only handle network errors or JSON parsing errors\r\n        displayMessage('A network error occurred. Please check your connection and try again.', true);\r\n        console.error('Network Error:', error);\r\n    }\r\n};\r\n\r\n// And similar for handling of password reset form\r\nconst handleReset = async (event) => {\r\n    event.preventDefault();\r\n    const form = event.target;\r\n    const formData = new FormData(form);\r\n\r\n    const password = formData.get('password');\r\n    const confirmPassword = formData.get('password-confirm');\r\n\r\n    if (!password-confirm || !password) {\r\n        displayMessage('Please enter both password and confirm password', true);\r\n        return;\r\n    }\r\n    if (password !== confirmPassword) {\r\n        displayMessage('Passwords do not match', true);\r\n        return;\r\n    }\r\n\r\n    // We need to include the token in the form data\r\n    const token = new URLSearchParams(window.location.search).get('token');\r\n    if (!token) {\r\n        displayMessage('Error - please click the link in the set password email', true);\r\n        return;\r\n    }\r\n\r\n    // Determine the endpoint based on the mode (forgot password, signup or login)\r\n    const endpoint = '/auth/reset-password';\r\n    console.log('Submitting to:', endpoint, token, password);\r\n\r\n    try {\r\n        // OK - this is the fetch API, it's a promise so we need to await it\r\n        const response = await fetch(endpoint, {\r\n            method: \"post\",\r\n            headers: {\r\n                'Content-Type': 'application/json',\r\n            },\r\n            body: JSON.stringify({ token, password }),\r\n        });\r\n\r\n        const { success, status } = handleResponse(response);\r\n        console.log('handleSubmit response:', success, status, response);\r\n\r\n        if (success) {\r\n            displayMessage('Password reset successfully. Redirecting to login...', true);\r\n        } else {\r\n            // Handle different types of errors based on status codes\r\n            switch (status) {\r\n                case 400:\r\n                    displayMessage(\"Hmmm... seems the email link has expired. Hang on, we'll redirect you\", true);\r\n                    break;\r\n                case 401:\r\n                    displayMessage(\"Hmmm... that didn't work :(\", true);\r\n                    break;\r\n                case 409:\r\n                    displayMessage(\"Email already in our system :(<br>Have you forgotten your password? Try the link below...\", true);\r\n                    break;\r\n                case 422:\r\n                    displayMessage('Invalid input. Please check your email and password.', true);\r\n                    break;\r\n                default:\r\n                    displayMessage('An error occurred. Please try again.', true);\r\n            }\r\n        }\r\n        setTimeout(() => {\r\n            window.location.href = '/login';\r\n        }, 6000);\r\n    \r\n    } catch (error) {\r\n        // This catch block will now only handle network errors or JSON parsing errors\r\n        displayMessage('A network error occurred. Please check your connection and try again.', true);\r\n        console.error('Network Error:', error);\r\n    }\r\n}\r\n\r\nconst terminateForgotPasswordFlow = () => {\r\n    // TODO: Implement this\r\n    console.log('terminateForgotPasswordFlow');\r\n    displayMessage('Password reset initiated. Check your email for further instructions.', true);\r\n    // Redirect to login page after 6 seconds\r\n    setTimeout(() => {\r\n        window.location.href = '/login';\r\n    }, 6000);\r\n};\r\n\r\n// Function to handle social logins\r\nconst handleSocialLogin = (provider) => {\r\n    const urlParams = new URLSearchParams(window.location.search);\r\n    const redirect = urlParams.get('redirect');\r\n    let url = `/auth/${provider}`;\r\n    if (redirect) {\r\n        url += `?redirect=${encodeURIComponent(redirect)}`;\r\n    }\r\n    window.location.href = url;\r\n};\r\n\r\n// Add event listeners when the DOM is loaded\r\ndocument.addEventListener('DOMContentLoaded', () => {\r\n    const form = document.getElementById('auth-form') || document.getElementById('authForm');\r\n    const switchButton = document.getElementById('switchButton') || document.getElementById('switchLink');\r\n    const forgotPasswordLink = document.getElementById('forgotPassword');\r\n    const googleBtn = document.getElementById('googleLogin');\r\n    const facebookBtn = document.getElementById('facebookLogin');\r\n\r\n    // Check for mode=signup in URL\r\n    const urlParams = new URLSearchParams(window.location.search);\r\n    if (urlParams.get('mode') === 'signup') {\r\n        isSignupMode = true;\r\n        layoutMode();\r\n    }\r\n\r\n    if (form) form.addEventListener('submit', handleSubmit);\r\n    if (switchButton) switchButton.addEventListener('click', toggleAuthMode);\r\n    if (forgotPasswordLink) forgotPasswordLink.addEventListener('click', setForgotPasswordMode);\r\n\r\n    // Social login buttons\r\n    if (googleBtn) googleBtn.addEventListener('click', () => handleSocialLogin('google'));\r\n    if (facebookBtn) facebookBtn.addEventListener('click', () => handleSocialLogin('facebook'));\r\n\r\n    // Password reset\r\n    const resetForm = document.getElementById('resetPasswordForm');\r\n    if (resetForm) {\r\n        resetForm.addEventListener('submit', handleReset);\r\n    }\r\n\r\n    // We might have a message to display immediately if we arrived here from a redirect\r\n    const messageElement = document.getElementById('message');\r\n    const error = urlParams.get('error');\r\n    if (error) {\r\n        switch (error) {\r\n            case 'auth_error':\r\n                displayMessage('An error occurred during authentication. Please try again.', true);\r\n                break;\r\n            case 'auth_failed':\r\n                displayMessage('Authentication failed. Please try again.', true);\r\n                break;\r\n            case 'login_error':\r\n                displayMessage('An error occurred during login. Please try again.', true);\r\n                break;\r\n            case 'profile_error':\r\n                displayMessage('An error occurred processing your profile. Please try again.', true);\r\n                break;\r\n            case 'verification_failed':\r\n                displayMessage(\"Verification failed - we suggest you follow the 'Forgot Password' link below\", true);\r\n                break;\r\n            default:\r\n                displayMessage('An error occurred. Please try again.', true);\r\n        }\r\n    }\r\n});\r\n\r\n"],"names":["isSignupMode","forgotPasswordMode","handleResponse","response","success","ok","status","displayMessage","message","isError","messageElement","document","getElementById","innerHTML","className","style","display","alert","toggleAuthMode","layoutMode","setForgotPasswordMode","formTitle","submitButton","switchMessage","switchButton","socialButtons","passwordInput","forgotPasswordLink","textContent","required","handleSubmit","async","event","preventDefault","form","target","formData","FormData","email","get","password","endpoint","console","log","fetch","method","headers","body","JSON","stringify","terminateForgotPasswordFlow","redirect","URLSearchParams","window","location","search","href","decodeURIComponent","data","error","handleReset","confirmPassword","confirm","token","setTimeout","handleSocialLogin","provider","url","encodeURIComponent","addEventListener","googleBtn","facebookBtn","urlParams","resetForm"],"mappings":"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"}