!function(){"use strict";class e extends HTMLElement{constructor(){super(),this._image=null,this._canvas=null,this._ctx=null,this._isDrawing=!1,this._isMoving=!1,this._startX=0,this._startY=0,this._mode="hotspot",this._answer=null,this._src=!1,this._connected=!1,this._resizeObserver=new ResizeObserver(this._handleResize.bind(this)),this._scale=1,this._offsetX=0,this._offsetY=0}static get observedAttributes(){return["src","mode","answer"]}connectedCallback(){console.log("image-selector: connected:",this.isConnected),this._connected=!0,this.render(),this.setupCanvas(),this._resizeObserver.observe(this),this.setupEventListeners()}disconnectedCallback(){this._resizeObserver.unobserve(this),this._connected=!1}attributeChangedCallback(e,t,i){if(t!==i)switch(e){case"src":this.setImage(i);break;case"mode":this._mode=i;break;case"answer":console.log("attributeChangedCallback:: answer:",JSON.parse(i)),this._answer=JSON.parse(i),this._redrawCanvas()}}render(){this.innerHTML=`\n            <style>\n                .container {\n                    position: relative;\n                    min-width: 100%;\n                    min-height: 100%; /* Full height of the parent container */\n                    overflow: hidden;\n                }\n                #image-selector-image {\n                    position: absolute; /* Position the image absolutely */\n                    top: 0;\n                    left: 0;\n                    width: 100%; /* Full width of the parent container */\n                    display: block; /* Remove inline spacing */\n                }\n                canvas {\n                    position: absolute;\n                    top: 0;\n                    left: 0;\n                    // border:1px solid yellow;\n                    pointer-events: none;\n                }\n                img.hotspot { cursor: crosshair; }\n                img.rectangle { cursor: crosshair; }\n                img.disabled { cursor: default; }\n\n            </style>\n            <div class="container">\n                <img id="image-selector-image" src="${this.getAttribute("src")}" draggable="false">\n                <canvas></canvas>\n            </div>\n        `}setupCanvas(){this._image=this.querySelector("img"),this._canvas=this.querySelector("canvas"),this._ctx=this._canvas.getContext("2d"),this._image.onload=()=>{const e=this._image.naturalWidth/this._image.naturalHeight,t=this._image.parentElement.clientWidth,i=this._image.parentElement.clientHeight;let n,s;t/i>e?(n=i*e,s=i):(n=t,s=t/e),this._image.width=n,this._image.height=s,this._image.style.left=(t-n)/2+"px",this._image.style.top=(i-s)/2+"px",this._canvas.width=n,this._canvas.height=s,this._adjustCanvasSize(),this._canvas.style.left=(t-n)/2+"px",this._canvas.style.top=(i-s)/2+"px"}}setupEventListeners(){"disabled"!==this._mode&&(this._image.addEventListener("pointerdown",this.handlePointerDown.bind(this)),this._image.addEventListener("pointermove",this.handlePointerMove.bind(this)),this._image.addEventListener("pointerup",this.handlePointerUp.bind(this)),this._image.addEventListener("pointerleave",this.handlePointerUp.bind(this)),this._image.addEventListener("dragstart",(e=>e.preventDefault())),this._image.addEventListener("touchstart",this.handleTouchStart.bind(this)),this._image.addEventListener("touchend",this.handleTouchEnd.bind(this)),"hotspot"===this._mode&&this._image.addEventListener("wheel",this.handleWheel.bind(this)))}handlePointerDown(e){e.preventDefault(),this._isDrawing=!0,this._isMoving=!1;const{x:t,y:i}=this.clientToCanvas(e.clientX,e.clientY);this._startX=t,this._startY=i}handlePointerMove(e){if(this._touchStart)return;if(!this._isDrawing)return;this._isMoving=!0,e.preventDefault();const{x:t,y:i}=this.clientToCanvas(e.clientX,e.clientY),n=t-this._startX,s=i-this._startY;"hotspot"===this._mode?(this._offsetX+=n,this._offsetY+=s,this.updateTransform()):this.drawRect(this._startX,this._startY,t-this._startX,i-this._startY)}handlePointerUp(e){if(!this._isDrawing)return;if(this._isDrawing=!1,"hotspot"===this._mode&&this._isMoving)return;e.preventDefault();const t=this.clientToCanvas(e.clientX,e.clientY),i=this.clientToImage(e.clientX,e.clientY),n=this.clientToContainer(e.clientX,e.clientY);console.log("Pointer up:: canvasX, canvasY:",t.x,t.y),console.log("Pointer up:: imageX, imageY:",i.x,i.y),console.log("Pointer up:: containerX, containerY:",n.x,n.y),console.log("Pointer up:: canvas width, height:",this._canvas.width,this._canvas.height);const s=t.x,a=t.y;"hotspot"===this._mode&&this.drawCross(s,a);let o=this.canvasToNormalized(s,a);if("rectangle"===this._mode){const e=Math.min(this._startX,s),t=Math.max(this._startX,s),i=Math.min(this._startY,a),n=Math.max(this._startY,a);o={start:this.canvasToNormalized(e,i),end:this.canvasToNormalized(t,n)}}this.dispatchEvent(new CustomEvent("selection",{detail:o})),console.log("event dispatched: selection:",o)}handleTouchStart(e){if(e.preventDefault(),this._isDrawing=!0,2===e.touches.length)this._touchStart=!0,this._lastTouchDistance=this.getTouchDistance(e.touches),this._isMoving=!1,this._isDrawing=!1,this._isZooming=!0;else if(1===e.touches.length){this._isDrawing=!0;const t=e.touches[0],{x:i,y:n}=this.clientToCanvas(t.clientX,t.clientY);this._startX=i,this._startY=n}}handleTouchMove(e){if(this._isDrawing)if(e.preventDefault(),2===e.touches.length){const t=this.getTouchDistance(e.touches),i=t/this._lastTouchDistance,n=(e.touches[0].clientX+e.touches[1].clientX)/2,s=(e.touches[0].clientY+e.touches[1].clientY)/2,{x:a,y:o}=this.clientToCanvas(n,s),{x:r,y:l}=this.clientToContainer(n,s),c=Math.max(1,Math.min(this._scale*i,4));this._scale=1,this._offsetX=r-a*c,this._offsetY=l-o*c,this.updateTransform(),this._lastTouchDistance=t}else if(1===e.touches.length){if(!this._isDrawing)return;const t=e.touches[0],{x:i,y:n}=this.clientToCanvas(t.clientX,t.clientY),s=i-this._startX,a=n-this._startY;"hotspot"===this._mode?(this._offsetX+=s,this._offsetY+=a,this.updateTransform()):this.drawRect(this._startX,this._startY,i-this._startX,n-this._startY)}}handleTouchEnd(e){this._isDrawing&&this._isZooming&&(e.preventDefault(),this._lastTouchDistance=null,this._isDrawing=!1,1===e.touches.length&&this.handlePointerUp(e.touches[0]))}getTouchDistance(e){return Math.hypot(e[0].clientX-e[1].clientX,e[0].clientY-e[1].clientY)}drawRect(e,t,i,n){this._ctx.fillStyle="rgba(255, 0, 0, 0.5)",this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height),this._ctx.fillRect(e,t,i,n)}drawCross(e,t){const i=10;console.log("drawCross:: x,y:",e,t,e-i,t-i,e+i,t+i),this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height),this._ctx.strokeStyle="white",this._ctx.lineWidth=5,this._ctx.beginPath(),this._ctx.moveTo(e-i,t-i),this._ctx.lineTo(e+i,t+i),this._ctx.moveTo(e-i,t+i),this._ctx.lineTo(e+i,t-i),this._ctx.stroke(),this._ctx.strokeStyle="red",this._ctx.lineWidth=3,this._ctx.beginPath(),this._ctx.moveTo(e-i,t-i),this._ctx.lineTo(e+i,t+i),this._ctx.moveTo(e-i,t+i),this._ctx.lineTo(e+i,t-i),this._ctx.stroke()}handleWheel(e){e.preventDefault();const{x:t,y:i}=this.clientToCanvas(e.clientX,e.clientY),{x:n,y:s}=this.clientToContainer(e.clientX,e.clientY),a=e.deltaY>0?-.5:.5,o=Math.max(1,Math.min(this._scale+a,4));this._scale=o,this._offsetX=n-t*o,this._offsetY=s-i*o,this.updateTransform()}updateTransform(){const e=`translate(${this._offsetX}px, ${this._offsetY}px) scale(${this._scale})`;this._image.style.transform=e,this._canvas.style.transform=e}setImage(e){console.log("setImage:: src:",e),this._src=e,this._connected&&(console.log("this._connected - calling renderImage"),this.renderImage())}renderImage(){this._image.src=this._src,this._image.onload=()=>{this._adjustCanvasSize()},this.setCursorType(),this._adjustCanvasSize()}setCursorType(){console.log("setCursorType:: this._mode:",this._mode),this._image.classList.remove("hotspot","rectangle","disabled"),this._image.classList.add(this._mode)}_handleResize(){this._image.complete&&this._adjustCanvasSize()}_adjustCanvasSize(){const e=this._image.getBoundingClientRect();console.log("_adjustCanvasSize:",e,window.innerWidth/1920),0==e.width|0==e.height||(this._canvas.width=e.width/1,this._canvas.height=e.height/1,this._canvas.style.width=e.width/1+"px",this._canvas.style.height=e.height/1+"px",this._redrawCanvas())}_redrawCanvas(){if(console.log("_redrawCanvas: width, height:",this._canvas.width,this._canvas.height,this._answer),this._answer){if("hotspot"===this._mode){const e=this.normalizedToCanvas(this._answer.x,this._answer.y);this.drawCross(e.x,e.y)}if("rectangle"===this._mode){const e=this.normalizedToCanvas(this._answer.start.x,this._answer.start.y),t=this.normalizedToCanvas(this._answer.end.x,this._answer.end.y);this.drawRect(e.x,e.y,t.x-e.x,t.y-e.y)}}}clientToImage(e,t){const i=this._image.getBoundingClientRect();return{x:(e-i.left)/1,y:(t-i.top)/1}}clientToCanvas(e,t){const{x:i,y:n}=this.clientToImage(e,t);return this.imageToCanvas(i,n)}clientToContainer(e,t){const i=this.clientToImage(e,t);return this.imageToContainer(i.x,i.y)}imageToCanvas(e,t){return{x:e/this._scale,y:t/this._scale}}imageToContainer(e,t){return{x:e+this._offsetX,y:t+this._offsetY}}canvasToNormalized(e,t){const i=1e3/this._image.width,n=1e3/this._image.height;return{x:Math.round(e*i),y:Math.round(t*n)}}normalizedToCanvas(e,t){return{x:e*(this._image.width/1e3),y:t*(this._image.height/1e3)}}}customElements.define("image-selector",e);class t{constructor(e){this.options={element:null,accept:"*/*",multiple:!1,maxSize:10485760,onDrop:null,onError:null,hoverClass:"dropzone-hover",...e},this.element="string"==typeof this.options.element?document.querySelector(this.options.element):this.options.element,this.element?(this.fileInput=this.element.querySelector('input[type="file"]'),this.fileInput||(this.fileInput=document.createElement("input"),this.fileInput.type="file",this.fileInput.style.display="none",this.element.appendChild(this.fileInput)),this.fileInput.accept=this.options.accept,this.fileInput.multiple=this.options.multiple,this.init()):console.error("Dropzone element not found")}init(){this.element.addEventListener("click",(e=>{e.target!==this.fileInput&&this.fileInput.click()})),this.fileInput.addEventListener("change",(e=>{this.handleFiles(this.fileInput.files)})),this.element.addEventListener("dragover",(e=>{e.preventDefault(),e.stopPropagation(),this.element.classList.add(this.options.hoverClass)})),this.element.addEventListener("dragleave",(e=>{e.preventDefault(),e.stopPropagation(),this.element.classList.remove(this.options.hoverClass)})),this.element.addEventListener("drop",(e=>{e.preventDefault(),e.stopPropagation(),this.element.classList.remove(this.options.hoverClass),e.dataTransfer.files.length>0&&this.handleFiles(e.dataTransfer.files)}))}handleFiles(e){if(0===e.length)return;const t=Array.from(e).filter((e=>{if(e.size>this.options.maxSize)return this.triggerError(`File too large: ${e.name}`),!1;if("*/*"!==this.options.accept){const t=this.options.accept.split(",").map((e=>e.trim())),i=e.type,n="."+e.name.split(".").pop();if(!t.some((e=>{if(e.startsWith("."))return n.toLowerCase()===e.toLowerCase();if(e.endsWith("/*")){const t=e.split("/")[0];return i.startsWith(t+"/")}return i===e})))return this.triggerError(`File type not accepted: ${e.name}`),!1}return!0}));t.length>0&&this.options.onDrop&&this.options.onDrop(t,this.element),this.fileInput.value=""}triggerError(e){this.options.onError?this.options.onError(e):console.error(e)}}class i{constructor(e={}){this.options={onSelect:null,modalTitle:"Image Library",...e},this.selectedImage=null,this.createModal()}createModal(){this.modal=document.createElement("div"),this.modal.className="image-selector-modal",this.modal.innerHTML=`\n      <div class="modal-content">\n        <div class="modal-header">\n          <h2>${this.options.modalTitle}</h2>\n          <button class="close-modal">&times;</button>\n        </div>\n        <div class="modal-body">\n          <div class="image-library-container">\n            <div class="images-grid">\n              \x3c!-- Images will be loaded here --\x3e\n              <p class="loading-message">Loading images...</p>\n            </div>\n          </div>\n        </div>\n        <div class="modal-footer">\n            <div class="upload-container">\n              <h3>Add a new image</h3>\n              <div class="dropzone" id="modal-dropzone">\n                <p>Drop image here or click to select</p>\n                <input type="file" style="display: none;" accept="image/*">\n              </div>\n            </div>\n        </div>\n      </div>\n    `,document.body.appendChild(this.modal),this.initEventListeners(),this.initDropzone()}initEventListeners(){this.modal.querySelector(".close-modal").addEventListener("click",(()=>this.close())),this.modal.querySelector(".images-grid").addEventListener("click",(e=>{const t=e.target.closest(".image-item");t&&(this.selectedImage={id:t.dataset.id,url:t.dataset.url},this.options.onSelect&&this.options.onSelect(this.selectedImage),this.close())}))}initDropzone(){new t({element:this.modal.querySelector("#modal-dropzone"),accept:"image/*",onDrop:e=>{e.length>0&&this.uploadImage(e[0])}})}show(){this.modal.style.display="flex",this.loadImages()}close(){this.modal.style.display="none",this.selectedImage=null}async loadImages(){try{const e=this.modal.querySelector(".images-grid");e.innerHTML='<p class="loading-message">Loading images...</p>';const t=await fetch("/api/image/library"),i=await t.json();i.success?this.renderImages(i.data):(console.error("Error loading images:",i.message),e.innerHTML='<p class="no-images">Error loading images</p>')}catch(e){console.error("Error loading images:",e),this.modal.querySelector(".images-grid").innerHTML='<p class="no-images">Error loading images</p>'}}renderImages(e){const t=this.modal.querySelector(".images-grid");t.innerHTML="",0!==e.length?(e.forEach((e=>{const i=document.createElement("div");i.className="image-item",i.dataset.id=e._id,i.dataset.url=e.url,i.innerHTML=`\n      <div class="image-preview">\n        <img src="${e.url}" alt="${e.originalName||"Image"}">\n        <button class="delete-image-btn" title="Delete image">&times;</button>\n      </div>\n      <div class="image-info">\n        <span class="image-name">${e.originalName||"Image"}</span>\n      </div>\n    `,t.appendChild(i)})),t.querySelectorAll(".delete-image-btn").forEach((e=>{e.addEventListener("click",(e=>{e.stopPropagation(),this.handleImageDelete(e.target.closest(".image-item").dataset.id)}))}))):t.innerHTML='<p class="no-images">No images found. Add your first image below.</p>'}async handleImageDelete(e){if(confirm("Delete this image?"))try{const t=await fetch(`/api/images/${e}`,{method:"DELETE"}),i=await t.json();i.success?this.loadImages():alert("Error deleting image: "+i.message)}catch(e){console.error("Error deleting image:",e),alert("Error deleting image. Please try again.")}}async uploadImage(e){const t=new FormData;t.append("image",e);try{const e=this.modal.querySelector(".images-grid"),i=e.innerHTML;e.innerHTML='<p class="loading-message">Uploading image...</p>';const n=await fetch("/api/image/upload",{method:"POST",body:t}),s=await n.json();s.success?this.loadImages():(alert("Error uploading image: "+s.message),e.innerHTML=i)}catch(e){console.error("Error uploading image:",e),alert("Error uploading image"),this.loadImages()}}}let n=!1;document.addEventListener("DOMContentLoaded",(()=>{window.addEventListener("beforeunload",(e=>{if(n){const t="You have unsaved changes. Are you sure you want to leave?";return e.returnValue=t,t}}));const e=document.getElementById("rounds-container");document.getElementById("create-quiz").addEventListener("click",(function(){v({title:"New Quiz",description:"Add additional info here - prizes, rounds...",rounds:[]})}));document.getElementById("host-quiz").addEventListener("click",(function(){const e=document.getElementById("quiz-id").value;e?window.location.href=`/host/lobby?host=1&q=${e}`:alert("Please save the quiz before hosting it")}));document.getElementById("add-round").addEventListener("click",o);document.getElementById("quiz-title").addEventListener("blur",u),document.getElementById("export-quiz"),new t({element:"#import-quiz-dropzone",accept:".json,application/json",onDrop:e=>{e.length>0&&async function(e){if(!e.name.endsWith(".json")&&"application/json"!==e.type)return void alert("Please select a JSON file.");let t,i;try{t=await e.text(),console.log(`Successfully loaded file: ${e.name}`)}catch(e){return console.error("Error loading quiz file:",e),void alert(`Failed to load quiz file: ${e.message}`)}try{i=JSON.parse(t)}catch(e){return console.error("Error parsing quiz JSON:",e),void alert(`Failed to parse quiz JSON: ${e.message}`)}try{v(i),alert(`Quiz "${i.title||"Untitled"}" imported - please correct any errors and then save`)}catch(e){return console.error("Error creating quiz from JSON:",e),void alert(`Failed to create quiz: ${e.message}`)}}(e[0])},onError:e=>{alert(e)}});document.getElementById("save-quiz").addEventListener("click",(async function(t){t.preventDefault();const i=function(){const t={_id:document.getElementById("quiz-id").value,schemaVersion:document.getElementById("quiz-schema-version").value,owner:document.getElementById("quiz-owner").value,title:document.getElementById("quiz-title").value,description:document.getElementById("quiz-description").value,rounds:Array.from(e.querySelectorAll("details.round")).map((e=>({_id:e.querySelector(".round-id").value,owner:e.querySelector(".round-owner").value,title:e.querySelector(".round-title").value,description:e.querySelector(".round-description").value,roundTimer:e.querySelector('[data-field="round-timer"]').value,showAnswer:e.querySelector('[data-field="show-answer"]').value,updateScores:e.querySelector('[data-field="update-scores"]').value,questions:Array.from(e.querySelectorAll("details.question")).map((e=>function(e){const t=e.querySelector(".question-type").value,i={type:t,_id:e.querySelector(".question-id").value,owner:e.querySelector(".question-owner").value,text:e.querySelector('[data-field="question-text"]').value,image:e.querySelector('[data-field="question-image"]').getAttribute("src"),audio:e.querySelector('[data-field="question-audio"]').value,answer:null,options:[],pairs:[],items:[],extra:{}};switch(console.log("gatherQuestionData:",t,i),t){case"multiple-choice":let t=[e.querySelector('[data-field="option-1"]').value,e.querySelector('[data-field="option-2"]').value,e.querySelector('[data-field="option-3"]').value,e.querySelector('[data-field="option-4"]').value,e.querySelector('[data-field="option-5"]').value,e.querySelector('[data-field="option-6"]').value,e.querySelector('[data-field="option-7"]').value,e.querySelector('[data-field="option-8"]').value];i.options=t.filter((e=>""!=e));break;case"true-false":case"text":case"draw":i.answer=e.querySelector('[data-field="answer"]').value;break;case"number-exact":case"number-closest":case"number-average":const n=e.querySelector('[data-field="answer"]').value;i.answer=""!==n?Number(n):null;break;case"matching":const s=Array.from([1,2,3,4,5]).map((t=>({left:e.querySelector(`[data-field="left-${t}"]`).value,right:e.querySelector(`[data-field="right-${t}"]`).value})));i.pairs=s.filter((e=>""!=e.left));break;case"ordering":i.extra={},i.extra.startLabel=e.querySelector('[data-field="order-start"]').value,i.extra.endLabel=e.querySelector('[data-field="order-end"]').value;const a=Array.from(e.querySelectorAll('[data-field="order-item"]')).map((e=>e.value));i.items=a.filter((e=>""!=e));break;case"hotspot":console.log("gatherQuestionData: hotspot:",e.querySelector('[data-field="hotspot-x"]').value),i.answer=e.querySelector('[data-field="hotspot-x"]').value?{x:+e.querySelector('[data-field="hotspot-x"]').value,y:+e.querySelector('[data-field="hotspot-y"]').value}:null;break;case"point-it-out":i.answer={start:{x:+e.querySelector('[data-field="point-it-out-startx"]').value,y:+e.querySelector('[data-field="point-it-out-starty"]').value},end:{x:+e.querySelector('[data-field="point-it-out-endx"]').value,y:+e.querySelector('[data-field="point-it-out-endy"]').value}}}return i}(e)))})))};return console.log("createJSONfromQuiz:",t),t}();document.getElementById("quiz-json").textContent=JSON.stringify(i,null,2);const n=await f(i);if(!n.valid)return console.log("Quiz validation failed:",n),alert("Errors found: please correct before saving)"),void y(n.errors);const s=document.getElementById("save-quiz");s.textContent="Saving...";try{const e=await fetch("/api/quiz/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}),t=await e.json();if(!t.success)return console.log("Error saving quiz: please correct any errors and try again"),s.textContent="Save Quiz",void alert("Error saving quiz: "+(t.message||"Unknown error"));console.log("Quiz saved successfully:",t),s.textContent="Saved";const n=setTimeout((()=>{s.textContent="Save Quiz",clearTimeout(n)}),3e3);v(t.data)}catch(e){console.error("Error saving quiz:",e)}}));async function s(){try{const e=await fetch("/api/quiz",{method:"GET",headers:{"Content-Type":"application/json"}}),t=await e.json();if(!t.success)throw new Error(t);document.getElementById("quiz-list").style.display="block",document.getElementById("button-panel").style.display="flex",document.getElementById("quiz-edit").style.display="none",function(e){const t=document.getElementById("quiz-item-template"),i=document.getElementById("quiz-items");i.innerHTML="",e.forEach((e=>{const n=t.content.cloneNode(!0);n.querySelector(".quiz-item-title").textContent=e.title,n.querySelector(".delete-quiz-item").addEventListener("click",(()=>{const t=confirm("Confirm Delete");console.log(t),t&&async function(e){const t=await fetch(`/api/quiz/${e}`,{method:"DELETE",headers:{"Content-Type":"application/json"}}),i=await t.json();if(!i.success)throw new Error(i);s()}(e._id)})),n.querySelector(".edit-quiz-item").addEventListener("click",(()=>v(e))),n.querySelector(".error-indicator").style.display=e.validation&&e.validation.length>0?"inline-flex":"none",i.appendChild(n)}))}(t.data)}catch(e){console.error("Error fetching quizzes:",e)}}function a(e){e.addEventListener("click",(t=>{const i=e.parentNode;if(console.log("summaryElement:",t.target,i.hasAttribute("open")),i.hasAttribute("open")){i.querySelectorAll("details").forEach((e=>{e.removeAttribute("open")}))}}))}function o(){console.log("addRoundToDOM");const t=document.getElementById("round-template").content.cloneNode(!0),i=t.querySelector(".questions-container"),n=t.querySelector(".question-btn"),s=t.querySelector(".header-round");n.addEventListener("click",(()=>r(i))),t.querySelector(".round-title").addEventListener("blur",u),s&&a(s),e.appendChild(t),new Sortable(i,{animation:150,handle:"summary",group:"questions",scroll:!0,scrollSensitivity:60,onSort:e=>{console.log("roundSorttable onSort:",e),d()}}),d()}function r(e){const t=document.getElementById("question-template").content.cloneNode(!0),i=e.children.length+1;t.querySelector(".header-question-number").textContent=i;t.querySelector('[data-field="question-text"]').addEventListener("blur",u);t.querySelector(".question-type").addEventListener("change",l),c(t);t.querySelector('[data-field="question-image-url"]').addEventListener("blur",h),e.appendChild(t),d()}function l(e){c(e.target.closest(".question"))}function c(e){const t=e.querySelector(".question-specific-content"),i=e.querySelector(".question-type").value,n=e.querySelector(".question-type-hint"),s=e.querySelector('[data-field="question-image"]');switch(console.log("handleQuestionTypeChange:",i),t.innerHTML="",i){case"text":t.innerHTML='\n                    <label>Answer:</label><input type="text" data-field="answer" placeholder="Enter answer">\n                ',n.textContent="Basic question - players type the answer via an on-screen keyboard";break;case"number-exact":n.textContent="Answer is numeric - players must get the answer exactly right to score the points",t.innerHTML='\n                    <label>Answer:</label><input type="number" data-field="answer" placeholder="Enter answer">\n                ';break;case"number-closest":n.textContent="Answer is numeric - players who get closest to the answer score the points",t.innerHTML='\n                    <label>Answer:</label><input type="number" data-field="answer" placeholder="Enter answer">\n                ';break;case"number-average":n.textContent="Answer is numeric - players who get closest to the average of all player guesses score the points. Question may have an answer, or could be totally subjective.",t.innerHTML='\n                    <label>Answer:</label><input type="number" data-field="answer" placeholder="Optional answer - if there is one">\n                ';break;case"multiple-choice":n.textContent="Players select an answer from the provided options",t.innerHTML='\n                        <input class="question-field" type="text" data-field="option-1" placeholder="This is the correct answer">\n                        <input class="question-field" type="text" data-field="option-2" placeholder="Enter option">\n                        <input class="question-field" type="text" data-field="option-3" placeholder="Enter option">\n                        <input class="question-field" type="text" data-field="option-4" placeholder="Enter option">\n                        <p>Optionally add up to 4 more answers</p>\n                        <input class="question-field" type="text" data-field="option-5" placeholder="...">\n                        <input class="question-field" type="text" data-field="option-6" placeholder="...">\n                        <input class="question-field" type="text" data-field="option-7" placeholder="...">\n                        <input class="question-field" type="text" data-field="option-8" placeholder="...">\n                    </div>\n                ';break;case"true-false":n.textContent="Only two possible answers here...",t.innerHTML='\n                    <label>Answer:</label><select data-field="answer">\n                        <option value="true">True</option>\n                        <option value="false">False</option>\n                    </select></p>\n                ';break;case"matching":n.textContent="Players drag items from the left to the matching option on the right (max 5 pairs, can be less just leave empty if not needed)",t.innerHTML='\n                    <div class="question-row">\n                        <input class="question-field" type="text" data-field="left-1" placeholder="Left item 1">\n                        <input class="question-field" type="text" data-field="right-1" placeholder="Right item 1">\n                    </div>\n                    <div class="question-row">\n                        <input class="question-field" type="text" data-field="left-2" placeholder="Left item 2">\n                        <input class="question-field" type="text" data-field="right-2" placeholder="Right item 2">\n                    </div>\n                    <div class="question-row">\n                        <input class="question-field" type="text" data-field="left-3" placeholder="Left item 3">\n                        <input class="question-field" type="text" data-field="right-3" placeholder="Right item 3">\n                    </div>\n                    <div class="question-row">\n                        <input class="question-field" type="text" data-field="left-4" placeholder="Left item 4">\n                        <input class="question-field" type="text" data-field="right-4" placeholder="Right item 4">\n                    </div>\n                    <div class="question-row">\n                        <input class="question-field" type="text" data-field="left-5" placeholder="Left item 5">\n                        <input class="question-field" type="text" data-field="right-5" placeholder="Right item 5">\n                    </div>\n                ';break;case"ordering":n.textContent="Players drag items into the correct order",t.innerHTML='\n                        <label>Start label:</label><input type="text" data-field="order-start" placeholder="eg Earliest">\n                        <label>End label:</label><input type="text" data-field="order-end" placeholder="eg Latest">\n                        <label>Items to Order (enter in correct order):</label>\n                        <div class="ordering-items">\n                            <input type="text" data-field="order-item" placeholder="Item 1">\n                            <input type="text" data-field="order-item" placeholder="Item 2">\n                            <input type="text" data-field="order-item" placeholder="Item 3">\n                            <input type="text" data-field="order-item" placeholder="Item 4">\n                            <input type="text" data-field="order-item" placeholder="Item 5">\n                            <input type="text" data-field="order-item" placeholder="Item 6">\n                        </div>\n                ';break;case"hotspot":n.textContent="Players select a point on the picture - closest players score the points (select picture on the left column then mark a X at the correct point)",t.innerHTML='\n                    <image-selector data-field="image-selector-preview" class="image-selector-preview" mode="hotspot"></image-selector>\n                    <input type="hidden" data-field="hotspot-x">\n                    <input type="hidden" data-field="hotspot-y">\n                ';t.querySelector(".image-selector-preview").addEventListener("selection",(t=>p(e,t.detail,"hotspot"))),s.getAttribute("src")&&m(e,s.getAttribute("src"));break;case"point-it-out":n.textContent="Similar to hotspot, except players score if they are within the selected rectangular area (select picture on the left column then drag a rectangle on the picture)",t.innerHTML='\n                    <image-selector data-field="image-selector-preview" class="image-selector-preview" mode="rectangle"></image-selector>\n                    <input type="hidden" data-field="point-it-out-startx">\n                    <input type="hidden" data-field="point-it-out-starty">\n                    <input type="hidden" data-field="point-it-out-endx">\n                    <input type="hidden" data-field="point-it-out-endy">\n                ';t.querySelector('[data-field="image-selector-preview"]').addEventListener("selection",(t=>p(e,t.detail,"point-it-out"))),s.getAttribute("src")&&m(e,s.getAttribute("src"));break;case"draw":n.textContent="Players draw or write the answer on their screen - teams mark each others answers",t.innerHTML='\n                    <label>Answer</label><input type="text" data-field="answer" placeholder="Enter answer">\n                '}}function d(){document.querySelectorAll(".round").forEach(((e,t)=>{e.querySelector(".header-round-number").textContent=t+1;e.querySelectorAll(".question").forEach(((e,t)=>{e.querySelector(".header-question-number").textContent=t+1}))}))}function u(e){console.log("updateHeaderWithTitle:",e.target.value);e.target.closest(".quiz, .round, .question").querySelector(".header-title").textContent=e.target.value}function h(e){if(console.log("handleExternalImageURL:",e.target.value),e.target.value){const t=e.target.closest(".question");m(t,e.target.value),t.querySelector(".clear-image-btn").style.display="inline-block",t.querySelector(".add-from-library").style.display="none"}}function m(e,t){console.log("setImageSelectorSrc:",t);const i=e.querySelector('[data-field="question-image-url"]');i&&(i.value=t);const n=e.querySelectorAll(".image-selector-preview");n&&(console.log("setImageSelectorSrc: imageSelectorPreview:",n),n.forEach((e=>{e.setAttribute("src",t),e.style.display="block"})))}function p(e,t,i){console.log("imageSelectorSelection:",e,t,i),"hotspot"===i?(e.querySelector('[data-field="hotspot-x"]').value=t.x,e.querySelector('[data-field="hotspot-y"]').value=t.y):"point-it-out"===i&&(console.log("update point-it-out:",t),e.querySelector('[data-field="point-it-out-startx"]').value=t.start.x,e.querySelector('[data-field="point-it-out-starty"]').value=t.start.y,e.querySelector('[data-field="point-it-out-endx"]').value=t.end.x,e.querySelector('[data-field="point-it-out-endy"]').value=t.end.y)}function g(e){const t=e.message,i=e.instancePath;if('must match "then" schema'===t){const e=i.split("/");if(i.includes("questions")){const t=parseInt(e[e.indexOf("rounds")+1]),i=parseInt(e[e.indexOf("questions")+1]),n=document.querySelectorAll(".round")[t]?.querySelectorAll(".question")[i]?.dataset.questionData;if(n){const e=JSON.parse(n);switch(e.type){case"multiple-choice":return"This question requires at least 2 options and a correct answer";case"true-false":return"This question requires a True or False answer";case"text":case"number-exact":case"number-closest":return"This question requires an answer";case"number-average":return"This question does not require an answer";case"hotspot":return"This question requires hotspot coordinates";case"point-it-out":return"This question requires coordinates of two opposite corners of the rectangle";case"ordering":return"This question requires 2-6 items to order plus optional start/end labels";case"matching":return"This question requires at least 2 matching pairs";case"draw":return"This drawing question is missing required settings";default:return`This ${e.type} question is missing required fields`}}}return"This item is missing required fields based on its type"}if(t.includes("required property")){const e=t.match(/'([^']+)'/)?.[1];return`Missing required field: ${{title:"Title",text:"Question text",answer:"Answer",options:"Answer options",correctOption:"Correct option",items:"Items to order",pairs:"Matching pairs",startLabel:"Start label",endLabel:"End label"}[e]||e}`}return t}function y(e){if(function(){const e=document.getElementById("validation-summary");e&&(e.textContent="",e.style.display="none");document.querySelectorAll(".error-message").forEach((e=>e.remove())),document.querySelectorAll(".error-field").forEach((e=>{e.classList.remove("error-field"),e.title=""})),document.querySelectorAll(".error-indicator").forEach((e=>{e.style.display="none",e.classList.remove("animate"),delete e.dataset.count}))}(),!e||0===e.length)return;const t={},i={},n=e.length,s=document.getElementById("validation-summary");s.textContent=`Found ${n} error${n>1?"s":""}. Please fix before saving.`,s.style.display="block",e.forEach((e=>{const n=e.instancePath.split("/");if(n.shift(),0===n.length)!function(e){const t=document.querySelector(".quiz"),i=document.createElement("div");i.className="error-message",i.textContent=g(e);const n=t.querySelector("header");if(n.parentNode.insertBefore(i,n.nextSibling),message.includes("title")){const t=document.getElementById("quiz-title");t.classList.add("error-field"),t.title=e.message}}(e);else if("rounds"===n[0]){const s=parseInt(n[1]);if(t[s]||(t[s]=[]),t[s].push(e.message),2===n.length||3===n.length)!function(e,t){const i=document.querySelectorAll(".round");if(e>=0&&e<i.length){const n=i[e],s=document.createElement("div");s.className="error-message",s.textContent=g(t);const a=n.querySelector("summary");a.parentNode.insertBefore(s,a.nextSibling);let o=null;t.message.includes("title")&&(o=n.querySelector(".round-title")),t.instancePath.includes("updateScores")&&(o=n.querySelector('[data-field="update-scores"]')),t.instancePath.includes("showAnswer")&&(o=n.querySelector('[data-field="show-answer"]')),o&&(o.classList.add("error-field"),o.title=t.message),n.setAttribute("open","true")}}(s,e);else if("questions"===n[2]){const t=parseInt(n[3]);i[s]||(i[s]={}),i[s][t]||(i[s][t]=[]),i[s][t].push(e.message);!function(e,t,i,n){const s=document.querySelectorAll(".round");if(e>=0&&e<s.length){const a=s[e].querySelectorAll(".question");if(t>=0&&t<a.length){const e=a[t],s=document.createElement("div");s.className="error-message",s.textContent=g(n);const o=e.querySelector("summary");if(o.parentNode.insertBefore(s,o.nextSibling),i){const t=e.querySelector(`[data-field="${i}"]`);t&&(t.classList.add("error-field"),t.title=n.message)}else if(n.message.includes("text")){const t=e.querySelector('[data-field="question-text"]');t.classList.add("error-field"),t.title=n.message}else if(n.message.includes("answer")){const t=e.querySelector('[data-field="answer"]');t&&(t.classList.add("error-field"),t.title=n.message)}}}}(s,t,n.length>4?n[4]:null,e)}}})),Object.keys(t).forEach((e=>{!function(e,t){const i=document.querySelectorAll(".round");if(e>=0&&e<i.length){const n=i[e].querySelector(".error-indicator");n&&(n.style.display="inline-flex",n.title=`This round has ${t} error${t>1?"s":""}`,t>1?n.dataset.count=t:delete n.dataset.count,setTimeout((()=>{n.classList.add("animate")}),100))}}(parseInt(e),t[e].length)})),Object.keys(i).forEach((e=>{Object.keys(i[e]).forEach((t=>{!function(e,t,i){const n=document.querySelectorAll(".round");if(e>=0&&e<n.length){const s=n[e].querySelectorAll(".question");if(t>=0&&t<s.length){const e=s[t].querySelector(".error-indicator");e&&(e.style.display="inline-flex",e.title=`This question has ${i} error${i>1?"s":""}`,i>1?e.dataset.count=i:delete e.dataset.count,setTimeout((()=>{e.classList.add("animate")}),100))}}}(parseInt(e),parseInt(t),i[e][t].length)}))}))}async function f(e){try{const t=await fetch("/api/quiz/validate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error(`Server returned ${t.status}: ${t.statusText}`);return(await t.json()).data}catch(e){throw console.error("Validation request failed:",e),e}}async function v(e){console.log("createQuizFromJSON:",e);try{e=function(e){return e.rounds=e.rounds||[],e.rounds.forEach((e=>{e.questions=e.questions||[],e.questions.forEach((e=>{"multiple-choice"===e.type&&(e.options=e.options||[]),"matching"===e.type&&(e.pairs=e.pairs||[]),"ordering"===e.type&&(e.items=e.items||[],e.extra=e.extra||{}),"point-it-out"===e.type&&e.answer&&(e.answer.start=e.answer.start||{},e.answer.end=e.answer.end||{})}))})),e}(e=function(e){e.rounds&&Array.isArray(e.rounds)&&e.rounds.forEach((e=>{e.questions&&Array.isArray(e.questions)&&e.questions.forEach((e=>{console.log("Normalizing question:",e),"true-false"===e.type&&"boolean"==typeof e.answer&&(e.answer=e.answer?"true":"false"),"true-false"===e.type&&console.log("True-false question answer:",e.answer,"Type:",typeof e.answer),"number-exact"!==e.type&&"number-closest"!==e.type&&"number-average"!==e.type||"string"!=typeof e.answer||""===e.answer||(e.answer=Number(e.answer))}))}));return e}(e)),console.table(e);const t=await f(e);console.log("Validation result:",t),e.validation=t.errors||[],q(e)}catch(t){console.error("Error during validation:",t),alert("An error occurred during quiz validation. Please check the console for details."),q(e)}}function q(t){console.log("populateQuizWithData:",t),document.getElementById("quiz-json").value=JSON.stringify(t,null,2),document.getElementById("quiz-id").value=t._id||"",document.getElementById("quiz-owner").value=t.owner||"",document.getElementById("quiz-schema-version").value=t.schemaVersion||"",document.getElementById("quiz-edit").querySelector(".header-title").textContent=t.title,document.getElementById("quiz-title").value=t.title,document.getElementById("quiz-description").value=t.description||"";const i=document.getElementById("quiz-edit").querySelector(".header-quiz");i&&a(i),e.innerHTML="",t.rounds.forEach((t=>{o();const i=e.lastElementChild;i.querySelector(".header-title").textContent=t.title||"",i.querySelector(".round-title").value=t.title||"",i.querySelector(".round-description").value=t.description||"",i.querySelector(".round-id").value=t._id||"",i.querySelector(".round-owner").value=t.owner||"",i.querySelector('[data-field="round-timer"]'),i.querySelector('[data-field="round-timer"]').value=t.roundTimer,i.querySelector('[data-field="show-answer"]').value=t.showAnswer,i.querySelector('[data-field="update-scores"]').value=t.updateScores;const n=i.querySelector(".questions-container");t.questions.forEach((e=>{r(n);const t=n.lastElementChild;if(t.querySelector('[data-field="question-text"]').value=e.text,t.querySelector(".header-title").textContent=e.text,t.querySelector(".question-id").value=e._id||"",t.querySelector(".question-owner").value=e.owner||"",e.image&&m(t,e.image),e.audio){t.querySelector('[data-field="question-audio"]').value=e.audio}const i=t.querySelector(".question-type");i.value=e.type,i.dispatchEvent(new Event("change"));const s=t.querySelector(".question-specific-content");switch(e.type){case"multiple-choice":e.options.forEach(((e,t)=>{s.querySelector(`[data-field="option-${t+1}"]`).value=e||""}));break;case"true-false":case"text":case"number-exact":case"number-closest":case"number-average":s.querySelector('[data-field="answer"]').value=String(e.answer)||"";break;case"matching":e.pairs.forEach(((e,t)=>{s.querySelector(`[data-field="left-${t+1}"]`).value=e.left||"",s.querySelector(`[data-field="right-${t+1}"]`).value=e.right||""}));break;case"ordering":console.log("Ordering:",e),s.querySelector('[data-field="order-start"]').value=e.extra.startLabel||"",s.querySelector('[data-field="order-end"]').value=e.extra.endLabel||"",e.items.forEach(((e,t)=>{s.querySelectorAll('[data-field="order-item"]')[t].value=e||""}));break;case"hotspot":if(e.image){const t=s.querySelector(".image-selector-preview");t&&(t.setAttribute("src",e.image||""),console.log("createQuizFromJSON.setAttribute:answer:",e.answer),t.setAttribute("answer",JSON.stringify(e.answer)))}s.querySelector('[data-field="hotspot-x"]').value=e.answer.x||"",s.querySelector('[data-field="hotspot-y"]').value=e.answer.y||"";break;case"point-it-out":if(e.image){const t=s.querySelector(".image-selector-preview");t&&(t.setAttribute("src",e.image||""),t.setAttribute("answer",JSON.stringify(e.answer)))}s.querySelector('[data-field="point-it-out-startx"]').value=e.answer.start.x||"",s.querySelector('[data-field="point-it-out-starty"]').value=e.answer.start.y||"",s.querySelector('[data-field="point-it-out-endx"]').value=e.answer.end.x||"",s.querySelector('[data-field="point-it-out-endy"]').value=e.answer.end.y||"";break;case"draw":s.querySelector('[data-field="answer"]').value=e.answer||""}}))})),document.querySelectorAll(".round, .question").forEach((e=>{e.removeAttribute("open")})),d(),document.getElementById("button-panel").style.display="none",document.getElementById("quiz-list").style.display="none",document.getElementById("quiz-edit").style.display="block",y(t.validation),document.removeEventListener("change",w),document.removeEventListener("click",S),document.addEventListener("change",w),document.addEventListener("click",S),n=!1,_()}function w(e){console.log("handleFormChanges:",e.target),e.target.matches("input, textarea, select")&&b()}function S(e){e.target.matches(".add-round-btn, .add-question-btn, .delete-btn")&&b()}function b(){console.log("markAsChanged called..."),n=!0,_()}function _(){const e=document.getElementById("save-quiz");n?e.classList.add("unsaved-changes"):e.classList.remove("unsaved-changes")}document.getElementById("back-to-quiz-list").addEventListener("click",(function(){s()})),document.addEventListener("click",(async e=>{if(e.target.matches(".select-image-btn")){const t=e.target.closest(".question");new i({onSelect:e=>{const i=t.querySelector('[data-field="question-image"]'),n=t.querySelector('[data-field="question-image-url"]');i.src=e.url,i.style.display="block",n.value=e.url,t.querySelector(".clear-image-btn").style.display="inline-block",t.querySelector(".add-from-library").style.display="none",m(t,e.url)}}).show()}if(e.target.matches(".clear-image-btn")){const t=e.target.closest(".question"),i=t.querySelector('[data-field="question-image"]'),n=t.querySelector('[data-field="question-image-url"]');i.src="",i.style.display="none",n.value="",e.target.style.display="none",t.querySelector(".add-from-library").style.display="inline-block"}if(e.target.classList.contains("delete-btn")){const t=e.target.closest(".round, .question");if(console.log("delete-btn:",t,t.classList[0]),"round"==t.classList[0]){const e=t.querySelector(".round-id").value,i=document.getElementById("quiz-id").value;if(console.log("DELETE:",i,e),i&&e)try{if(!(await fetch(`/api/quiz/${i}/${e}`,{method:"DELETE",headers:{"Content-Type":"application/json"}})).ok)throw new Error("Network response was not ok")}catch(e){console.error("Error deleting round:",e)}}t.remove(),d()}})),new Sortable(e,{animation:150,handle:"summary",onSort:e=>{d()}}),s(),document.addEventListener("click",(e=>{if(e.target.closest(".error-indicator")){const t=e.target.closest(".error-indicator").closest(".round, .question");t&&!t.hasAttribute("open")&&t.setAttribute("open","true"),t.querySelectorAll(".error-message").forEach((e=>{e.style.transition="background-color 0.5s",e.style.backgroundColor="rgba(240, 173, 78, 0.3)",setTimeout((()=>{e.style.backgroundColor="rgba(217, 83, 79, 0.1)"}),500)}))}}))}))}();
//# sourceMappingURL=quizbuilder.min.js.map
