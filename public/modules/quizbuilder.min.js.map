{"version":3,"file":"quizbuilder.min.js","sources":["../../src/ImageSelector.js","../../src/host/FileDropzone.js","../../src/host/ImageLibrary.js","../../src/host/quizbuilder.js"],"sourcesContent":["// ImageSelector.js\r\nexport class ImageSelector extends HTMLElement {\r\n    constructor() {\r\n        super();\r\n        // this.attachShadow({ mode: 'open' });\r\n        this._image = null;\r\n        this._canvas = null;\r\n        this._ctx = null;\r\n        this._isDrawing = false;\r\n        this._isMoving = false; // if panning then we don't want to register a click at the end\r\n        this._startX = 0;\r\n        this._startY = 0;\r\n        this._mode = 'hotspot'; // 'hotspot', 'rectangle' or 'disabled'\r\n        this._answer = null; // holds the normalized coords of an answer if provided\r\n        this._src = false;   // cache the image src ready for when element is connected to DOM\r\n        this._connected = false; // flag to check if element is connected to DOM\r\n        this._resizeObserver = new ResizeObserver(this._handleResize.bind(this));\r\n\r\n        // Add new properties for zoom\r\n        this._scale = 1;\r\n        this._offsetX = 0;\r\n        this._offsetY = 0;\r\n    }\r\n\r\n    static get observedAttributes() {\r\n        return ['src', 'mode', 'answer'];\r\n    }\r\n\r\n    connectedCallback() {\r\n        console.log('image-selector: connected:', this.isConnected);\r\n        this._connected = true;\r\n        this.render();\r\n        this.setupCanvas();\r\n        this._resizeObserver.observe(this);\r\n        this.setupEventListeners();\r\n        // Set a default size if not specified by the parent\r\n        // if (!this.style.width) {\r\n        //     console.log('connectedCallback - no style.width:');\r\n        //     this.style.width = '100%';\r\n        // }\r\n        // if (!this.style.height) this.style.height = '100vh'; // You can adjust this default\r\n    }\r\n\r\n    disconnectedCallback() {\r\n        this._resizeObserver.unobserve(this);\r\n        this._connected = false;\r\n    }\r\n\r\n    attributeChangedCallback(name, oldValue, newValue) {\r\n        if (oldValue === newValue) return;\r\n\r\n        switch (name) {\r\n            case 'src':\r\n                this.setImage(newValue);\r\n                break;\r\n            case 'mode':\r\n                this._mode = newValue;\r\n                break;\r\n            case 'answer':\r\n                // this._answer stores the normalized coords since we might not have the image size \r\n                console.log('attributeChangedCallback:: answer:', JSON.parse(newValue));\r\n                this._answer = JSON.parse(newValue);\r\n                this._redrawCanvas();\r\n                break;\r\n        }\r\n    }\r\n\r\n    render() {\r\n        this.innerHTML = `\r\n            <style>\r\n                .container {\r\n                    position: relative;\r\n                    min-width: 100%;\r\n                    min-height: 100%; /* Full height of the parent container */\r\n                    overflow: hidden;\r\n                }\r\n                #image-selector-image {\r\n                    position: absolute; /* Position the image absolutely */\r\n                    top: 0;\r\n                    left: 0;\r\n                    width: 100%; /* Full width of the parent container */\r\n                    display: block; /* Remove inline spacing */\r\n                }\r\n                canvas {\r\n                    position: absolute;\r\n                    top: 0;\r\n                    left: 0;\r\n                    // border:1px solid yellow;\r\n                    pointer-events: none;\r\n                }\r\n                img.hotspot { cursor: crosshair; }\r\n                img.rectangle { cursor: crosshair; }\r\n                img.disabled { cursor: default; }\r\n\r\n            </style>\r\n            <div class=\"container\">\r\n                <img id=\"image-selector-image\" src=\"${this.getAttribute('src')}\" draggable=\"false\">\r\n                <canvas></canvas>\r\n            </div>\r\n        `;\r\n    }\r\n\r\n    setupCanvas() {\r\n        this._image = this.querySelector('img');\r\n        this._canvas = this.querySelector('canvas');\r\n        this._ctx = this._canvas.getContext('2d');\r\n\r\n        // Redraw the canvas and image when the image loads\r\n        this._image.onload = () => {\r\n            // Calculate the aspect ratio\r\n            const imageAspectRatio = this._image.naturalWidth / this._image.naturalHeight;\r\n            const containerWidth = this._image.parentElement.clientWidth;\r\n            const containerHeight = this._image.parentElement.clientHeight;\r\n\r\n            // Calculate the dimensions of the image based on the container size\r\n            let imageWidth, imageHeight;\r\n\r\n            if (containerWidth / containerHeight > imageAspectRatio) {\r\n                // Container is wider than the image aspect ratio\r\n                imageWidth = containerHeight * imageAspectRatio;\r\n                imageHeight = containerHeight;\r\n            } else {\r\n                // Container is taller than the image aspect ratio\r\n                imageWidth = containerWidth;\r\n                imageHeight = containerWidth / imageAspectRatio;\r\n            }\r\n\r\n            // Set the image size and position\r\n            this._image.width = imageWidth;\r\n            this._image.height = imageHeight;\r\n            this._image.style.left = `${(containerWidth - imageWidth) / 2}px`;\r\n            this._image.style.top = `${(containerHeight - imageHeight) / 2}px`;\r\n\r\n            // Set the canvas size to match the image size\r\n            this._canvas.width = imageWidth;\r\n            this._canvas.height = imageHeight;\r\n            this._adjustCanvasSize();\r\n\r\n            // Center the canvas in the container\r\n            this._canvas.style.left = `${(containerWidth - imageWidth) / 2}px`;\r\n            this._canvas.style.top = `${(containerHeight - imageHeight) / 2}px`;\r\n        };\r\n    }\r\n\r\n    setupEventListeners() {\r\n        if (this._mode === 'disabled') return;\r\n        this._image.addEventListener('pointerdown', this.handlePointerDown.bind(this));\r\n        this._image.addEventListener('pointermove', this.handlePointerMove.bind(this));\r\n        this._image.addEventListener('pointerup', this.handlePointerUp.bind(this));\r\n        this._image.addEventListener('pointerleave', this.handlePointerUp.bind(this));\r\n        this._image.addEventListener('dragstart', (e) => e.preventDefault());\r\n\r\n        this._image.addEventListener('touchstart', this.handleTouchStart.bind(this));\r\n        // this._image.addEventListener('touchmove', this.handleTouchMove.bind(this));\r\n        this._image.addEventListener('touchend', this.handleTouchEnd.bind(this));\r\n\r\n        // Add wheel event listener\r\n        if (this._mode === 'hotspot') {\r\n            this._image.addEventListener('wheel', this.handleWheel.bind(this));    \r\n        }\r\n    }\r\n\r\n    handlePointerDown(event) {\r\n        event.preventDefault();\r\n        this._isDrawing = true;\r\n        this._isMoving = false;\r\n        const { x, y } = this.clientToCanvas(event.clientX, event.clientY);\r\n        // console.log('Pointer down', x, y, this._offsetX, this._offsetY );\r\n        this._startX = x;\r\n        this._startY = y;\r\n    }\r\n    handlePointerMove(event) {\r\n        if (this._touchStart) return;\r\n        if (!this._isDrawing) return;\r\n        this._isMoving = true;\r\n        event.preventDefault();\r\n\r\n        const { x, y } = this.clientToCanvas(event.clientX, event.clientY);\r\n\r\n        // Diff with startX and Y to see how far we've moved\r\n        const diffX = x - this._startX;\r\n        const diffY = y - this._startY;\r\n\r\n        // If question type is hotspot then we pan the image\r\n        // If question type is rectangle then we instead draw a rectangle\r\n        if (this._mode === 'hotspot') {\r\n            this._offsetX += diffX;\r\n            this._offsetY += diffY;\r\n            this.updateTransform();\r\n        } else {\r\n            this.drawRect(this._startX, this._startY, x - this._startX, y - this._startY);\r\n        }\r\n\r\n    }\r\n    handlePointerUp(event) {\r\n        if (!this._isDrawing) return;\r\n        this._isDrawing = false;\r\n        if (this._mode === 'hotspot' && this._isMoving) return;\r\n\r\n        event.preventDefault();\r\n        \r\n        const canvasPos = this.clientToCanvas(event.clientX, event.clientY);\r\n        const imagePos = this.clientToImage(event.clientX, event.clientY);\r\n        const containerPos = this.clientToContainer(event.clientX, event.clientY);\r\n\r\n        console.log('Pointer up:: canvasX, canvasY:', canvasPos.x, canvasPos.y);\r\n        console.log('Pointer up:: imageX, imageY:', imagePos.x, imagePos.y);\r\n        console.log('Pointer up:: containerX, containerY:', containerPos.x, containerPos.y);\r\n        console.log('Pointer up:: canvas width, height:', this._canvas.width, this._canvas.height);\r\n        // Updated code to handle additional scale/offset properties\r\n        // const x = (event.clientX - rect.left - this._offsetX) / this._scale;\r\n        // const y = (event.clientY - rect.top - this._offsetY) / this._scale;\r\n        // const x = (event.clientX - rect.left) - this._offsetX / this._scale;\r\n        // const y = (event.clientY - rect.top) - this._offsetY / this._scale;\r\n\r\n        // Set x and y to the correct values\r\n        const x = canvasPos.x;\r\n        const y = canvasPos.y;\r\n\r\n        if (this._mode === 'hotspot') {\r\n            this.drawCross(x, y);\r\n        }\r\n\r\n        // Dispatch event with the selection\r\n        let selection = this.canvasToNormalized( x, y );\r\n        if (this._mode === 'rectangle') {\r\n            const leftX = Math.min( this._startX, x );\r\n            const rightX = Math.max( this._startX, x );\r\n            const topY = Math.min( this._startY, y );\r\n            const bottomY = Math.max( this._startY, y );\r\n            selection = { start: this.canvasToNormalized( leftX, topY ), end: this.canvasToNormalized( rightX, bottomY ) }\r\n        } \r\n        this.dispatchEvent(new CustomEvent('selection', { detail: selection }));\r\n        console.log('event dispatched: selection:', selection);\r\n    }\r\n\r\n\r\n    handleTouchStart(event) {\r\n        event.preventDefault();\r\n        this._isDrawing = true;\r\n        if (event.touches.length === 2) {\r\n            this._touchStart = true;\r\n            this._lastTouchDistance = this.getTouchDistance(event.touches);\r\n            this._isMoving = false;\r\n            this._isDrawing = false;\r\n            this._isZooming = true;\r\n        } else if (event.touches.length === 1) {\r\n            this._isDrawing = true;\r\n            const touch = event.touches[0];\r\n            const { x, y } = this.clientToCanvas(touch.clientX, touch.clientY);\r\n            this._startX = x;\r\n            this._startY = y;\r\n        }\r\n    }\r\n    \r\n\r\n    handleTouchMove(event) {\r\n        if (!this._isDrawing) return;\r\n        event.preventDefault();\r\n    \r\n        if (event.touches.length === 2) {\r\n            // Zooming in creator mode\r\n            const currentDistance = this.getTouchDistance(event.touches);\r\n            const scaleDiff = currentDistance / this._lastTouchDistance;\r\n\r\n            // Get the midpoint of the two touches\r\n            const midX = (event.touches[0].clientX + event.touches[1].clientX) / 2;\r\n            const midY = (event.touches[0].clientY + event.touches[1].clientY) / 2;\r\n\r\n            // Get mouse position in image coordinates\r\n            const { x: mouseX, y: mouseY } = this.clientToCanvas(midX, midY);\r\n            const { x: containerX, y: containerY } = this.clientToContainer(midX, midY);\r\n    \r\n            // Calculate the new scale\r\n            const newScale = Math.max(1, Math.min(this._scale * scaleDiff, 4));\r\n\r\n            // Update scale\r\n            this._scale = 1;\r\n    \r\n            // Calculate the new offsets\r\n            this._offsetX = containerX - mouseX * newScale;\r\n            this._offsetY = containerY - mouseY * newScale;\r\n    \r\n            this.updateTransform();\r\n    \r\n            this._lastTouchDistance = currentDistance;\r\n\r\n        } else if (event.touches.length === 1) {\r\n\r\n            if (!this._isDrawing) return;\r\n\r\n            // Panning\r\n            const touch = event.touches[0];\r\n            const { x, y } = this.clientToCanvas(touch.clientX, touch.clientY);\r\n\r\n            // Diff with startX and Y to see how far we've moved\r\n            const diffX = x - this._startX;\r\n            const diffY = y - this._startY;\r\n\r\n            // If question type is hotspot then we pan the image\r\n            // If question type is rectangle then we instead draw a rectangle\r\n            if (this._mode === 'hotspot') {\r\n                this._offsetX += diffX;\r\n                this._offsetY += diffY;\r\n                this.updateTransform();\r\n            } else {\r\n                this.drawRect(this._startX, this._startY, x - this._startX, y - this._startY);\r\n            }\r\n        }\r\n    }\r\n    \r\n    handleTouchEnd(event) {\r\n        if (!this._isDrawing) return;\r\n        if (!this._isZooming) return;\r\n        event.preventDefault();\r\n        this._lastTouchDistance = null;\r\n        this._isDrawing = false;\r\n        if (event.touches.length === 1) {\r\n            this.handlePointerUp(event.touches[0]);\r\n        }\r\n    }\r\n\r\n    getTouchDistance(touches) {\r\n        return Math.hypot(\r\n            touches[0].clientX - touches[1].clientX,\r\n            touches[0].clientY - touches[1].clientY\r\n        );\r\n    }\r\n\r\n\r\n    drawRect(x1, y1, x2, y2) {\r\n        this._ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';\r\n        this._ctx.clearRect(0, 0, this._canvas.width, this._canvas.height);\r\n        this._ctx.fillRect(x1, y1, x2, y2);\r\n    }\r\n\r\n    drawCross(x, y) {\r\n        const crossSize = 10;\r\n        const lineWidth = 3;\r\n\r\n        console.log('drawCross:: x,y:', x, y, x-crossSize, y-crossSize, x+crossSize, y+crossSize);\r\n\r\n        this._ctx.clearRect(0, 0, this._canvas.width, this._canvas.height);\r\n        // Draw white background cross\r\n        this._ctx.strokeStyle = 'white';\r\n        this._ctx.lineWidth = lineWidth + 2;\r\n        this._ctx.beginPath();\r\n        this._ctx.moveTo(x - crossSize, y - crossSize);\r\n        this._ctx.lineTo(x + crossSize, y + crossSize);\r\n        this._ctx.moveTo(x - crossSize, y + crossSize);\r\n        this._ctx.lineTo(x + crossSize, y - crossSize);\r\n        this._ctx.stroke();\r\n        // Draw red foreground cross\r\n        this._ctx.strokeStyle = 'red';\r\n        this._ctx.lineWidth = lineWidth;\r\n        this._ctx.beginPath();\r\n        this._ctx.moveTo(x - crossSize, y - crossSize);\r\n        this._ctx.lineTo(x + crossSize, y + crossSize);\r\n        this._ctx.moveTo(x - crossSize, y + crossSize);\r\n        this._ctx.lineTo(x + crossSize, y - crossSize);\r\n        this._ctx.stroke();\r\n    }\r\n\r\n    handleWheel(event) {\r\n        event.preventDefault();\r\n        \r\n        // Get mouse position in image coordinates\r\n        const { x: mouseX, y: mouseY } = this.clientToCanvas(event.clientX, event.clientY);\r\n        const { x:containerX, y:containerY } = this.clientToContainer(event.clientX, event.clientY);\r\n\r\n        // console.log('handleWheel:: mouse x,y:', mouseX, mouseY);\r\n        // console.log('handleWheel:: container x,y:', containerX, containerY);\r\n        const zoomFactor = event.deltaY > 0 ? -0.5 : 0.5;\r\n        const newScale = Math.max(1, Math.min(this._scale + zoomFactor, 4));\r\n\r\n        // Update scale\r\n        this._scale = newScale;\r\n\r\n        // Calculate the new offsets - that took a while... :(\r\n        this._offsetX = containerX - mouseX * newScale;\r\n        this._offsetY = containerY - mouseY * newScale;\r\n\r\n        this.updateTransform();\r\n    }\r\n\r\n    updateTransform() {\r\n        const transform = `translate(${this._offsetX}px, ${this._offsetY}px) scale(${this._scale})`;\r\n        this._image.style.transform = transform;\r\n        this._canvas.style.transform = transform;\r\n    }\r\n\r\n\r\n    setImage(src) {\r\n        console.log('setImage:: src:', src);\r\n        this._src = src;\r\n        if (this._connected) {\r\n            console.log('this._connected - calling renderImage');\r\n            this.renderImage();\r\n        }\r\n    }\r\n    renderImage() {\r\n        this._image.src = this._src;\r\n        this._image.onload = () => {\r\n            this._adjustCanvasSize();\r\n        };\r\n        this.setCursorType();\r\n        this._adjustCanvasSize();\r\n    }\r\n\r\n    // This function is only called after the image has loaded\r\n    setCursorType() {\r\n        console.log('setCursorType:: this._mode:', this._mode);\r\n        this._image.classList.remove('hotspot', 'rectangle', 'disabled');\r\n        this._image.classList.add(this._mode);\r\n    }\r\n\r\n    _handleResize() {\r\n        if (this._image.complete) {\r\n            this._adjustCanvasSize();\r\n        }\r\n    }\r\n\r\n    _adjustCanvasSize() {\r\n        const rect = this._image.getBoundingClientRect();\r\n        const windowScale = 1;\r\n        console.log('_adjustCanvasSize:', rect, window.innerWidth/1920);\r\n        if (rect.width == 0 | rect.height == 0) {\r\n            return;\r\n        }\r\n        this._canvas.width = rect.width / windowScale;\r\n        this._canvas.height = rect.height / windowScale;\r\n        this._canvas.style.width = `${rect.width / windowScale}px`;\r\n        this._canvas.style.height = `${rect.height / windowScale }px`;\r\n        this._redrawCanvas();\r\n    }\r\n\r\n    _redrawCanvas() {\r\n        // Implement redrawing logic here\r\n        console.log('_redrawCanvas: width, height:', this._canvas.width, this._canvas.height, this._answer);\r\n        if (this._answer) {\r\n            if (this._mode === 'hotspot') {\r\n                const canvasPos = this.normalizedToCanvas(this._answer.x, this._answer.y);\r\n                this.drawCross(canvasPos.x, canvasPos.y);\r\n            }\r\n            if (this._mode === 'rectangle') {\r\n                const startCanvasPos = this.normalizedToCanvas(this._answer.start.x, this._answer.start.y);\r\n                const endCanvasPos = this.normalizedToCanvas(this._answer.end.x, this._answer.end.y);\r\n                this.drawRect(startCanvasPos.x, startCanvasPos.y, endCanvasPos.x - startCanvasPos.x, endCanvasPos.y - startCanvasPos.y);\r\n            }\r\n        }\r\n    }\r\n\r\n    // Conversion functions\r\n\r\n    // Verified\r\n    clientToImage(x, y) {\r\n        const rect = this._image.getBoundingClientRect();\r\n        const windowScale = 1;\r\n        return {\r\n            x: (x - rect.left) / windowScale,\r\n            y: (y - rect.top) / windowScale\r\n        };\r\n    }\r\n    clientToCanvas(x, y) {\r\n        const { x: imageX, y: imageY } = this.clientToImage(x, y);\r\n        return this.imageToCanvas(imageX, imageY);\r\n    }\r\n    // Verified\r\n    clientToContainer(clientX, clientY) {\r\n        const image = this.clientToImage(clientX, clientY);\r\n        return this.imageToContainer(image.x, image.y);\r\n    }\r\n    // To convert from image to canvas we just need to consider the scale\r\n    // Offset is already built into the translation of the image/canvas\r\n    imageToCanvas(x, y) {\r\n        return {\r\n            x: (x ) / this._scale,\r\n            y: (y ) / this._scale\r\n        };\r\n    }\r\n   // Verified\r\n   // And to convert from image to container we just need to add the offset\r\n   // Scale is already considered since the image coords are based on displayed size which is scaled\r\n    imageToContainer(x, y) {\r\n        return {\r\n            x: (x + this._offsetX),\r\n            y: (y + this._offsetY)\r\n        };\r\n    }\r\n    // Verified\r\n        \r\n    canvasToNormalized(x, y) {\r\n        const scaleX = 1000 / this._image.width;\r\n        const scaleY = 1000 / this._image.height;\r\n        return {\r\n            x: Math.round( x * scaleX ),\r\n            y: Math.round( y * scaleY )\r\n        };\r\n    }\r\n    normalizedToCanvas(x, y) {\r\n        const scaleX = this._image.width / 1000;\r\n        const scaleY = this._image.height / 1000;\r\n        return {\r\n            x: x * scaleX,\r\n            y: y * scaleY\r\n        };\r\n    }\r\n\r\n\r\n\r\n}\r\n\r\ncustomElements.define('image-selector', ImageSelector);\r\n","// FileDropzone.js\r\nexport class FileDropzone {\r\n  constructor(options) {\r\n    this.options = {\r\n      element: null,              // DOM element or selector\r\n      accept: '*/*',              // File types to accept\r\n      multiple: false,            // Allow multiple files\r\n      maxSize: 10 * 1024 * 1024,  // Default max size (10MB)\r\n      onDrop: null,               // Callback when files are dropped\r\n      onError: null,              // Callback when an error occurs\r\n      hoverClass: 'dropzone-hover',\r\n      ...options\r\n    };\r\n    \r\n    this.element = typeof this.options.element === 'string' \r\n      ? document.querySelector(this.options.element)\r\n      : this.options.element;\r\n      \r\n    if (!this.element) {\r\n      console.error('Dropzone element not found');\r\n      return;\r\n    }\r\n    \r\n    this.fileInput = this.element.querySelector('input[type=\"file\"]');\r\n    if (!this.fileInput) {\r\n      this.fileInput = document.createElement('input');\r\n      this.fileInput.type = 'file';\r\n      this.fileInput.style.display = 'none';\r\n      this.element.appendChild(this.fileInput);\r\n    }\r\n    \r\n    this.fileInput.accept = this.options.accept;\r\n    this.fileInput.multiple = this.options.multiple;\r\n    \r\n    this.init();\r\n  }\r\n  \r\n  init() {\r\n    // Add click handler to open file picker\r\n    this.element.addEventListener('click', (e) => {\r\n      if (e.target !== this.fileInput) {\r\n        this.fileInput.click();\r\n      }\r\n    });\r\n    \r\n    // Handle file selection via input\r\n    this.fileInput.addEventListener('change', (e) => {\r\n      this.handleFiles(this.fileInput.files);\r\n    });\r\n    \r\n    // Handle drag events\r\n    this.element.addEventListener('dragover', (e) => {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n      this.element.classList.add(this.options.hoverClass);\r\n    });\r\n    \r\n    this.element.addEventListener('dragleave', (e) => {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n      this.element.classList.remove(this.options.hoverClass);\r\n    });\r\n    \r\n    this.element.addEventListener('drop', (e) => {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n      this.element.classList.remove(this.options.hoverClass);\r\n      \r\n      if (e.dataTransfer.files.length > 0) {\r\n        this.handleFiles(e.dataTransfer.files);\r\n      }\r\n    });\r\n  }\r\n  \r\n  handleFiles(files) {\r\n    if (files.length === 0) return;\r\n    \r\n    // Validate files\r\n    const validFiles = Array.from(files).filter(file => {\r\n      // Check file size\r\n      if (file.size > this.options.maxSize) {\r\n        this.triggerError(`File too large: ${file.name}`);\r\n        return false;\r\n      }\r\n      \r\n      // Check file type if accept is specified\r\n      if (this.options.accept !== '*/*') {\r\n        const acceptTypes = this.options.accept.split(',').map(type => type.trim());\r\n        const fileType = file.type;\r\n        const fileExtension = '.' + file.name.split('.').pop();\r\n        \r\n        // Check if file type or extension matches accept types\r\n        const isValid = acceptTypes.some(type => {\r\n          if (type.startsWith('.')) {\r\n            return fileExtension.toLowerCase() === type.toLowerCase();\r\n          } else if (type.endsWith('/*')) {\r\n            const typeGroup = type.split('/')[0];\r\n            return fileType.startsWith(typeGroup + '/');\r\n          } else {\r\n            return fileType === type;\r\n          }\r\n        });\r\n        \r\n        if (!isValid) {\r\n          this.triggerError(`File type not accepted: ${file.name}`);\r\n          return false;\r\n        }\r\n      }\r\n      \r\n      return true;\r\n    });\r\n    \r\n    if (validFiles.length > 0) {\r\n      if (this.options.onDrop) {\r\n        this.options.onDrop(validFiles, this.element);\r\n      }\r\n    }\r\n    \r\n    // Reset file input\r\n    this.fileInput.value = '';\r\n  }\r\n  \r\n  triggerError(message) {\r\n    if (this.options.onError) {\r\n      this.options.onError(message);\r\n    } else {\r\n      console.error(message);\r\n    }\r\n  }\r\n}","import { FileDropzone } from \"./FileDropzone\";\r\n\r\nexport class ImageLibrary {\r\n  constructor(options = {}) {\r\n    this.options = {\r\n      onSelect: null,  // Callback when image is selected\r\n      modalTitle: 'Image Library',\r\n      ...options\r\n    };\r\n\r\n    this.selectedImage = null;\r\n    \r\n    // Create modal element (initially hidden)\r\n    this.createModal();\r\n  }\r\n\r\n  createModal() {\r\n    // Create modal structure\r\n    this.modal = document.createElement('div');\r\n    this.modal.className = 'image-selector-modal';\r\n    this.modal.innerHTML = `\r\n      <div class=\"modal-content\">\r\n        <div class=\"modal-header\">\r\n          <h2>${this.options.modalTitle}</h2>\r\n          <button class=\"close-modal\">&times;</button>\r\n        </div>\r\n        <div class=\"modal-body\">\r\n          <div class=\"image-library-container\">\r\n            <div class=\"images-grid\">\r\n              <!-- Images will be loaded here -->\r\n              <p class=\"loading-message\">Loading images...</p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n        <div class=\"modal-footer\">\r\n            <div class=\"upload-container\">\r\n              <h3>Add a new image</h3>\r\n              <div class=\"dropzone\" id=\"modal-dropzone\">\r\n                <p>Drop image here or click to select</p>\r\n                <input type=\"file\" style=\"display: none;\" accept=\"image/*\">\r\n              </div>\r\n            </div>\r\n        </div>\r\n      </div>\r\n    `;\r\n\r\n    document.body.appendChild(this.modal);\r\n\r\n    // Initialize event listeners\r\n    this.initEventListeners();\r\n\r\n    // Initialize dropzone\r\n    this.initDropzone();\r\n  }\r\n\r\n\r\n  initEventListeners() {\r\n    // Close button\r\n    this.modal.querySelector('.close-modal').addEventListener('click', () => this.close());\r\n\r\n    // Image selection - clicking an image automatically selects and closes\r\n    this.modal.querySelector('.images-grid').addEventListener('click', (e) => {\r\n      const imageItem = e.target.closest('.image-item');\r\n      if (imageItem) {\r\n        // Store selected image data\r\n        this.selectedImage = {\r\n          id: imageItem.dataset.id,\r\n          url: imageItem.dataset.url\r\n        };\r\n\r\n        // Call the onSelect callback with the image data\r\n        if (this.options.onSelect) {\r\n          this.options.onSelect(this.selectedImage);\r\n        }\r\n        \r\n        // Close the modal\r\n        this.close();\r\n      }\r\n    });\r\n  }\r\n\r\n  initDropzone() {\r\n    // Initialize dropzone using your FileDropzone component\r\n    new FileDropzone({\r\n      element: this.modal.querySelector('#modal-dropzone'),\r\n      accept: 'image/*',\r\n      onDrop: (files) => {\r\n        if (files.length > 0) {\r\n          this.uploadImage(files[0]);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  show() {\r\n    // Make modal visible\r\n    this.modal.style.display = 'flex';\r\n\r\n    // Load images\r\n    this.loadImages();\r\n  }\r\n\r\n  close() {\r\n    this.modal.style.display = 'none';\r\n    this.selectedImage = null;\r\n  }\r\n\r\n  async loadImages() {\r\n    try {\r\n      const grid = this.modal.querySelector('.images-grid');\r\n      grid.innerHTML = '<p class=\"loading-message\">Loading images...</p>';\r\n      \r\n      const response = await fetch('/api/image/library');\r\n      const result = await response.json();\r\n\r\n      if (result.success) {\r\n        this.renderImages(result.data);\r\n      } else {\r\n        console.error('Error loading images:', result.message);\r\n        grid.innerHTML = '<p class=\"no-images\">Error loading images</p>';\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading images:', error);\r\n      this.modal.querySelector('.images-grid').innerHTML = \r\n        '<p class=\"no-images\">Error loading images</p>';\r\n    }\r\n  }\r\n\r\n  // Add this to the renderImages method\r\nrenderImages(images) {\r\n  const grid = this.modal.querySelector('.images-grid');\r\n  grid.innerHTML = '';\r\n\r\n  if (images.length === 0) {\r\n    grid.innerHTML = '<p class=\"no-images\">No images found. Add your first image below.</p>';\r\n    return;\r\n  }\r\n\r\n  images.forEach(image => {\r\n    const item = document.createElement('div');\r\n    item.className = 'image-item';\r\n    item.dataset.id = image._id;\r\n    item.dataset.url = image.url;\r\n\r\n    item.innerHTML = `\r\n      <div class=\"image-preview\">\r\n        <img src=\"${image.url}\" alt=\"${image.originalName || 'Image'}\">\r\n        <button class=\"delete-image-btn\" title=\"Delete image\">&times;</button>\r\n      </div>\r\n      <div class=\"image-info\">\r\n        <span class=\"image-name\">${image.originalName || 'Image'}</span>\r\n      </div>\r\n    `;\r\n\r\n    grid.appendChild(item);\r\n  });\r\n\r\n  // Add event listeners for delete buttons\r\n  grid.querySelectorAll('.delete-image-btn').forEach(btn => {\r\n    btn.addEventListener('click', (e) => {\r\n      e.stopPropagation(); // Prevent image selection when clicking delete\r\n      this.handleImageDelete(e.target.closest('.image-item').dataset.id);\r\n    });\r\n  });\r\n}\r\n\r\n// Add this new method to handle image deletion\r\nasync handleImageDelete(imageId) {\r\n  if (!confirm('Delete this image?')) {\r\n    return;\r\n  }\r\n  \r\n  try {\r\n    const response = await fetch(`/api/images/${imageId}`, {\r\n      method: 'DELETE'\r\n    });\r\n    \r\n    const result = await response.json();\r\n    \r\n    if (result.success) {\r\n      // Reload images to update the view\r\n      this.loadImages();\r\n    } else {\r\n      alert('Error deleting image: ' + result.message);\r\n    }\r\n  } catch (error) {\r\n    console.error('Error deleting image:', error);\r\n    alert('Error deleting image. Please try again.');\r\n  }\r\n}\r\n\r\n  async uploadImage(file) {\r\n    const formData = new FormData();\r\n    formData.append('image', file);\r\n    \r\n    try {\r\n      const grid = this.modal.querySelector('.images-grid');\r\n      const currentContent = grid.innerHTML;\r\n      grid.innerHTML = '<p class=\"loading-message\">Uploading image...</p>';\r\n      \r\n      const response = await fetch('/api/image/upload', {\r\n        method: 'POST',\r\n        body: formData\r\n      });\r\n\r\n      const result = await response.json();\r\n\r\n      if (result.success) {\r\n        // Reload images to show the new one\r\n        this.loadImages();\r\n      } else {\r\n        alert('Error uploading image: ' + result.message);\r\n        grid.innerHTML = currentContent; // Restore previous content\r\n      }\r\n    } catch (error) {\r\n      console.error('Error uploading image:', error);\r\n      alert('Error uploading image');\r\n      this.loadImages(); // Reload images to reset the view\r\n    }\r\n  }\r\n}","import { ImageSelector } from '../ImageSelector';\r\nimport { FileDropzone } from './FileDropzone.js';\r\nimport { ImageLibrary } from './ImageLibrary.js';\r\n\r\nlet hasUnsavedChanges = false;\r\n\r\ndocument.addEventListener('DOMContentLoaded', () => {\r\n\r\n\t// Add beforeunload event listener to warn about unsaved changes\r\n\twindow.addEventListener('beforeunload', (e) => {\r\n\t\tif (hasUnsavedChanges) {\r\n\t\t\t// Standard message (browser will usually show its own message)\r\n\t\t\tconst message = 'You have unsaved changes. Are you sure you want to leave?';\r\n\t\t\te.returnValue = message;\r\n\t\t\treturn message;\r\n\t\t}\r\n\t});\r\n\r\n\tconst roundsContainer = document.getElementById('rounds-container');\r\n\r\n\tconst createQuizButton = document.getElementById('create-quiz');\r\n\tcreateQuizButton.addEventListener('click', createQuiz);\r\n\r\n\tconst hostQuizButton = document.getElementById('host-quiz');\r\n\thostQuizButton.addEventListener('click', hostQuiz);\r\n\r\n\tconst addRoundButton = document.getElementById('add-round');\r\n\taddRoundButton.addEventListener('click', addRoundToDOM);\r\n\r\n\tconst quizTitle = document.getElementById('quiz-title');\r\n\tquizTitle.addEventListener('blur', updateHeaderWithTitle);\r\n\r\n\tconst exportQuizButton = document.getElementById('export-quiz');\r\n\t// exportQuizButton.addEventListener('click', exportQuiz);\r\n\r\n\t// Initialize import quiz dropzone\r\n\tconst importQuizDropzone = new FileDropzone({\r\n\t\telement: '#import-quiz-dropzone',\r\n\t\taccept: '.json,application/json',\r\n\t\tonDrop: (files) => {\r\n\t\t\tif (files.length > 0) {\r\n\t\t\t\timportQuizFromFile(files[0]);\r\n\t\t\t}\r\n\t\t},\r\n\t\tonError: (error) => {\r\n\t\t\talert(error); // Or display in a nicer way\r\n\t\t}\r\n\t});\r\n\r\n\tconst saveQuizButton = document.getElementById('save-quiz');\r\n\tsaveQuizButton.addEventListener('click', saveQuiz);\r\n\r\n\tconst backToQuizListButton = document.getElementById('back-to-quiz-list');\r\n\tbackToQuizListButton.addEventListener('click', backToQuizList);\r\n\r\n\t// Event delegation for delete buttons, image selection...\r\n\tdocument.addEventListener('click', async (event) => {\r\n\r\n\t\t// Image selection modal\r\n\t\tif (event.target.matches('.select-image-btn')) {\r\n\t\t\tconst questionElement = event.target.closest('.question');\r\n\r\n\t\t\t// Create and show image selector\r\n\t\t\tconst imageSelector = new ImageLibrary({\r\n\t\t\t\tonSelect: (image) => {\r\n\t\t\t\t\t// Update the question with selected image\r\n\t\t\t\t\tconst imagePreview = questionElement.querySelector('[data-field=\"question-image\"]');\r\n\t\t\t\t\tconst imageUrlField = questionElement.querySelector('[data-field=\"question-image-url\"]');\r\n\r\n\t\t\t\t\timagePreview.src = image.url;\r\n\t\t\t\t\timagePreview.style.display = 'block';\r\n\t\t\t\t\timageUrlField.value = image.url;\r\n\r\n\t\t\t\t\t// Show clear button / hide add button\r\n\t\t\t\t\tquestionElement.querySelector('.clear-image-btn').style.display = 'inline-block';\r\n\t\t\t\t\tquestionElement.querySelector('.add-from-library').style.display = 'none';\r\n\r\n\t\t\t\t\t// In the event that we are on a Hotspot or Point-it-out question, update the image selector src too\r\n\t\t\t\t\tsetImageSelectorSrc(questionElement, image.url);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\timageSelector.show();\r\n\t\t}\r\n\t\t// Remove image from question (needed?)\r\n\t\tif (event.target.matches('.clear-image-btn')) {\r\n\t\t\tconst questionElement = event.target.closest('.question');\r\n\r\n\t\t\t// Clear image\r\n\t\t\tconst imagePreview = questionElement.querySelector('[data-field=\"question-image\"]');\r\n\t\t\tconst imageUrlField = questionElement.querySelector('[data-field=\"question-image-url\"]');\r\n\r\n\t\t\timagePreview.src = '';\r\n\t\t\timagePreview.style.display = 'none';\r\n\t\t\timageUrlField.value = '';\r\n\r\n\t\t\t// Hide clear button / Show add button\r\n\t\t\tevent.target.style.display = 'none';\r\n\t\t\tquestionElement.querySelector('.add-from-library').style.display = \"inline-block\";\r\n\t\t}\r\n\r\n\t\tif (event.target.classList.contains('delete-btn')) {\r\n\t\t\tconst elementToRemove = event.target.closest('.round, .question');\r\n\t\t\tconsole.log('delete-btn:', elementToRemove, elementToRemove.classList[0]);\r\n\r\n\t\t\t// If deleteing a round then must send message to server to delete round\r\n\t\t\t// Otherwise quiz will be submitted and merged with existing quiz data - no delete\r\n\t\t\tif (elementToRemove.classList[0] == \"round\") {\r\n\t\t\t\tconst roundId = elementToRemove.querySelector('.round-id').value;\r\n\t\t\t\tconst quizId = document.getElementById('quiz-id').value;\r\n\t\t\t\tconsole.log('DELETE:', quizId, roundId);\r\n\t\t\t\t// We might not have sent these to DB yet, so only DELETE if we have an _id\r\n\t\t\t\tif (quizId && roundId) {\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tconst response = await fetch(`/api/quiz/${quizId}/${roundId}`, {\r\n\t\t\t\t\t\t\tmethod: 'DELETE',\r\n\t\t\t\t\t\t\theaders: {\r\n\t\t\t\t\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t\t\t\t\t\t// Include any necessary authentication headers here\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tif (!response.ok) {\r\n\t\t\t\t\t\t\tthrow new Error('Network response was not ok');\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t// No need to check the response\r\n\t\t\t\t\t} catch (error) {\r\n\t\t\t\t\t\tconsole.error('Error deleting round:', error);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t// Finally, remove the DOM element\r\n\t\t\telementToRemove.remove();\r\n\t\t\taddRoundQuestionNumbers();\r\n\t\t}\r\n\t});\r\n\r\n\tnew Sortable(roundsContainer, {\r\n\t\tanimation: 150,\r\n\t\thandle: 'summary',\r\n\t\tonSort: (evt) => {\r\n\t\t\taddRoundQuestionNumbers();\r\n\t\t},\r\n\t});\r\n\r\n\t// Quill is loaded via the HTML page\r\n\t// const quill = new Quill('#quiz-description', {\r\n\t// \ttheme: 'snow',\r\n\t// \tmodules: {\r\n\t// \t\ttoolbar: [\r\n\t// \t\t\t['bold', 'italic', 'underline', 'strike'],\r\n\t// \t\t\t[{ 'header': 1 }, { 'header': 2 }],\r\n\t// \t\t\t[{ 'list': 'ordered' }, { 'list': 'bullet' }]\r\n\t// \t\t]\r\n\t// \t},\r\n\t// \tplaceholder: 'Enter quiz description',\r\n\t// \tbounds: '#quiz-description',\r\n\t// \tmaxHeight: '300px'\r\n\t// });\r\n\r\n\r\n\t// importQuizFromURL('quiz-new.json');\r\n\tfetchQuizzes();\r\n\r\n\t// Initialize error indicator handlers\r\n\tinitErrorIndicatorHandlers();\r\n\r\n\t// Function to fetch quizzes from the API\r\n\tasync function fetchQuizzes() {\r\n\t\ttry {\r\n\t\t\tconst response = await fetch('/api/quiz', {\r\n\t\t\t\tmethod: 'GET',\r\n\t\t\t\theaders: {\r\n\t\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t\t\t// Include any necessary authentication headers here\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tconst result = await response.json();\r\n\r\n\t\t\tif (!result.success) {\r\n\t\t\t\tthrow new Error(result);\r\n\t\t\t}\r\n\r\n\r\n\t\t\t// Make the quiz-list div and button panel visible and hide the quiz (edit) div\r\n\t\t\tdocument.getElementById('quiz-list').style.display = 'block';\r\n\t\t\tdocument.getElementById('button-panel').style.display = 'flex';\r\n\t\t\tdocument.getElementById('quiz-edit').style.display = 'none';\r\n\t\t\tcreateQuizList(result.data);\r\n\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error('Error fetching quizzes:', error);\r\n\t\t\t// Optionally, display an error message to the user\r\n\t\t}\r\n\t}\r\n\r\n\tfunction createQuizList(quizzes) {\r\n\t\tconst quizItemTemplate = document.getElementById('quiz-item-template');\r\n\t\tconst quizList = document.getElementById('quiz-items');\r\n\t\tquizList.innerHTML = '';\r\n\t\tquizzes.forEach(quiz => {\r\n\t\t\tconst quizItemElement = quizItemTemplate.content.cloneNode(true);\r\n\t\t\tquizItemElement.querySelector('.quiz-item-title').textContent = quiz.title;\r\n\t\t\tquizItemElement.querySelector('.delete-quiz-item').addEventListener('click', () => { const confirmed = confirm('Confirm Delete'); console.log(confirmed); if (confirmed) { deleteQuiz(quiz._id); } });\r\n\t\t\tquizItemElement.querySelector('.edit-quiz-item').addEventListener('click', () => createQuizFromJSON(quiz));\r\n\t\t\tquizItemElement.querySelector('.error-indicator').style.display = (quiz.validation && quiz.validation.length > 0) ? 'inline-flex' : 'none';\r\n\t\t\tquizList.appendChild(quizItemElement);\r\n\t\t});\r\n\t}\r\n\r\n\t// Function to create a new quiz - a bit hacky for now, but will do for testing\r\n\tfunction createQuiz() {\r\n\t\tcreateQuizFromJSON({ title: 'New Quiz', description: 'Add additional info here - prizes, rounds...', rounds: [] });\r\n\t}\r\n\r\n\tasync function deleteQuiz(quizId) {\r\n\r\n\t\tconst response = await fetch(`/api/quiz/${quizId}`, {\r\n\t\t\tmethod: 'DELETE',\r\n\t\t\theaders: {\r\n\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t\t// Include any necessary authentication headers here\r\n\t\t\t}\r\n\t\t});\r\n\t\tconst result = await response.json();\r\n\r\n\t\tif (!result.success) {\r\n\t\t\tthrow new Error(result);\r\n\t\t}\r\n\r\n\t\tfetchQuizzes();\r\n\r\n\t}\r\n\r\n\tfunction hostQuiz() {\r\n\t\tconst quizID = document.getElementById('quiz-id').value;\r\n\t\tif (quizID) {\r\n\t\t\twindow.location.href = `/host/lobby?host=1&q=${quizID}`;\r\n\t\t} else {\r\n\t\t\talert('Please save the quiz before hosting it');\r\n\t\t}\r\n\t}\r\n\r\n\t// saveQuiz\r\n\t// First validates the quiz and, if valid, sends to server to save\r\n\tasync function saveQuiz(event) {\r\n\t\tevent.preventDefault(); // Prevent the default form submission\r\n\r\n\t\t// Collect quiz data from the form\r\n\t\tconst quizJSON = createJSONfromQuiz();\r\n\r\n\t\t// Update the full JSON object into the HTML page for debugging\r\n\t\tdocument.getElementById('quiz-json').textContent = JSON.stringify(quizJSON, null, 2);\r\n\t\t\r\n\t\t// Re-validate the quiz before saving\r\n\t\tconst validation = await validateQuizSchema(quizJSON);\r\n\t\tif (!validation.valid) {\r\n\t\t\tconsole.log('Quiz validation failed:', validation);\r\n\t\t\talert('Errors found: please correct before saving)');\r\n\t\t\t// Update the error indicators\r\n\t\t\tdisplayValidationErrors(validation.errors);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Get the button id to replace with saving/saved message\r\n\t\tconst saveQuizElement = document.getElementById('save-quiz');\r\n\t\tsaveQuizElement.textContent = 'Saving...';\r\n\r\n\r\n\t\ttry {\r\n\t\t\tconst response = await fetch('/api/quiz/save', {\r\n\t\t\t\tmethod: 'POST',\r\n\t\t\t\theaders: {\r\n\t\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t\t\t// Include any necessary authentication headers here\r\n\t\t\t\t},\r\n\t\t\t\tbody: JSON.stringify(quizJSON) // Convert the quiz data to JSON\r\n\t\t\t});\r\n\t\t\tconst result = await response.json();\r\n\r\n\t\t\tif (!result.success) {\r\n\t\t\t\tconsole.log('Error saving quiz: please correct any errors and try again');\r\n\t\t\t\tsaveQuizElement.textContent = 'Save Quiz';\r\n\t\t\t\talert('Error saving quiz: ' + (result.message || 'Unknown error'));\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\t// Parse the response as JSON - note it could have validation errors\r\n\t\t\tconsole.log('Quiz saved successfully:', result);\r\n\t\t\tsaveQuizElement.textContent = 'Saved';\r\n\t\t\tconst saveQuizTimeout = setTimeout(() => {\r\n\t\t\t\tsaveQuizElement.textContent = 'Save Quiz';\r\n\t\t\t\tclearTimeout(saveQuizTimeout);\r\n\t\t\t}, 3000);\r\n\r\n\t\t\tcreateQuizFromJSON(result.data);\r\n\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error('Error saving quiz:', error);\r\n\t\t\t// Optionally, display an error message to the user\r\n\t\t}\r\n\t}\r\n\r\n\tfunction addCollapseAll(summaryElement) {\r\n\t\tsummaryElement.addEventListener('click', (event) => {\r\n\t\t\t// The click event is fired BEFORE the details element is opened/closed\r\n\t\t\tconst details = summaryElement.parentNode;\r\n\t\t\tconsole.log('summaryElement:', event.target, details.hasAttribute('open'));\r\n\t\t\tif (details.hasAttribute('open')) {\r\n\t\t\t\tconst allDetails = details.querySelectorAll('details');\r\n\t\t\t\tallDetails.forEach(detail => {\r\n\t\t\t\t\tdetail.removeAttribute('open');\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tfunction addRoundToDOM() {\r\n\t\tconsole.log('addRoundToDOM');\r\n\t\tconst roundTemplate = document.getElementById('round-template');\r\n\t\tconst roundElement = roundTemplate.content.cloneNode(true);\r\n\t\tconst questionsContainer = roundElement.querySelector('.questions-container');\r\n\t\tconst addQuestionButton = roundElement.querySelector('.question-btn');\r\n\t\tconst summaryElement = roundElement.querySelector('.header-round');\r\n\r\n\t\t// Add event handlers for round elements\r\n\t\taddQuestionButton.addEventListener('click', () => addQuestionToDOM(questionsContainer));\r\n\t\troundElement.querySelector('.round-title').addEventListener('blur', updateHeaderWithTitle);\r\n\t\tif (summaryElement) {\r\n\t\t\taddCollapseAll(summaryElement);\r\n\t\t}\r\n\r\n\t\troundsContainer.appendChild(roundElement);\r\n\r\n\t\tconst roundSorttable = new Sortable(questionsContainer, {\r\n\t\t\tanimation: 150,\r\n\t\t\thandle: 'summary',\r\n\t\t\tgroup: 'questions',\r\n\t\t\tscroll: true, // enables auto-scrolling while dragging\r\n\t\t\tscrollSensitivity: 60,\r\n\t\t\tonSort: (evt) => {\r\n\t\t\t\tconsole.log('roundSorttable onSort:', evt);\r\n\t\t\t\taddRoundQuestionNumbers();\r\n\t\t\t},\r\n\t\t});\r\n\r\n\t\taddRoundQuestionNumbers();\r\n\r\n\t}\r\n\r\n\tfunction addQuestionToDOM(container) {\r\n\t\tconst questionTemplate = document.getElementById('question-template');\r\n\t\tconst questionElement = questionTemplate.content.cloneNode(true);\r\n\r\n\t\tconst questionNumber = container.children.length + 1;\r\n\t\tquestionElement.querySelector('.header-question-number').textContent = questionNumber;\r\n\r\n\t\t// Add event listener for question text changes (update header)\r\n\t\tconst questionText = questionElement.querySelector('[data-field=\"question-text\"]');\r\n\t\tquestionText.addEventListener('blur', updateHeaderWithTitle);\r\n\r\n\t\t// Add event listener for question type changes\r\n\t\tconst typeSelector = questionElement.querySelector('.question-type');\r\n\t\ttypeSelector.addEventListener('change', questionTypeChangeListener);\r\n\t\t// ...and call the question type change handler immediately to initialise with the default question type (text)\r\n\t\thandleQuestionTypeChange(questionElement);\r\n\r\n\t\t// Add event listener for question-image-url changes\r\n\t\tconst questionImage = questionElement.querySelector('[data-field=\"question-image-url\"]');\r\n\t\tquestionImage.addEventListener('blur', handleExternalImageURL);\r\n\r\n\t\t// Add the question to the DOM (container)\r\n\t\tcontainer.appendChild(questionElement);\r\n\r\n\t\taddRoundQuestionNumbers();\r\n\t}\r\n\r\n\tfunction questionTypeChangeListener(event) {\r\n\t\tconst questionElement = event.target.closest('.question');\r\n\t\thandleQuestionTypeChange(questionElement);\r\n\t}\r\n\tfunction handleQuestionTypeChange(questionElement) {\r\n\r\n\t\t// Set up some constants for use in the switch statement\r\n\t\tconst contentContainer = questionElement.querySelector('.question-specific-content');\r\n\t\tconst questionType = questionElement.querySelector('.question-type').value;\r\n\t\tconst questionHint = questionElement.querySelector('.question-type-hint');\r\n\t\tconst questionImage = questionElement.querySelector('[data-field=\"question-image\"]');\r\n\t\tconsole.log('handleQuestionTypeChange:', questionType);\r\n\r\n\t\t// Clear existing content\r\n\t\tcontentContainer.innerHTML = '';\r\n\r\n\t\tswitch (questionType) {\r\n\t\t\tcase 'text':\r\n\t\t\t\tcontentContainer.innerHTML = `\r\n                    <label>Answer:</label><input type=\"text\" data-field=\"answer\" placeholder=\"Enter answer\">\r\n                `;\r\n\t\t\t\tquestionHint.textContent = 'Basic question - players type the answer via an on-screen keyboard';\r\n\t\t\t\tbreak;\r\n\t\t\tcase 'number-exact':\r\n\t\t\t\tquestionHint.textContent = 'Answer is numeric - players must get the answer exactly right to score the points';\r\n\t\t\t\tcontentContainer.innerHTML = `\r\n                    <label>Answer:</label><input type=\"number\" data-field=\"answer\" placeholder=\"Enter answer\">\r\n                `;\r\n\t\t\t\tbreak\r\n\r\n\t\t\tcase 'number-closest':\r\n\t\t\t\tquestionHint.textContent = 'Answer is numeric - players who get closest to the answer score the points';\r\n\t\t\t\tcontentContainer.innerHTML = `\r\n                    <label>Answer:</label><input type=\"number\" data-field=\"answer\" placeholder=\"Enter answer\">\r\n                `;\r\n\t\t\t\tbreak\r\n\r\n\t\t\tcase 'number-average':\r\n\t\t\t\tquestionHint.textContent = 'Answer is numeric - players who get closest to the average of all player guesses score the points. Question may have an answer, or could be totally subjective.';\r\n\t\t\t\tcontentContainer.innerHTML = `\r\n                    <label>Answer:</label><input type=\"number\" data-field=\"answer\" placeholder=\"Optional answer - if there is one\">\r\n                `;\r\n\t\t\t\tbreak\r\n\r\n\t\t\t\tcase 'multiple-choice':\r\n\t\t\t\tquestionHint.textContent = 'Players select an answer from the provided options';\r\n\t\t\t\tcontentContainer.innerHTML = `\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"option-1\" placeholder=\"This is the correct answer\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"option-2\" placeholder=\"Enter option\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"option-3\" placeholder=\"Enter option\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"option-4\" placeholder=\"Enter option\">\r\n                        <p>Optionally add up to 4 more answers</p>\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"option-5\" placeholder=\"...\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"option-6\" placeholder=\"...\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"option-7\" placeholder=\"...\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"option-8\" placeholder=\"...\">\r\n                    </div>\r\n                `;\r\n\t\t\t\tbreak;\r\n\t\t\tcase 'true-false':\r\n\t\t\t\tquestionHint.textContent = 'Only two possible answers here...';\r\n\t\t\t\tcontentContainer.innerHTML = `\r\n                    <label>Answer:</label><select data-field=\"answer\">\r\n                        <option value=\"true\">True</option>\r\n                        <option value=\"false\">False</option>\r\n                    </select></p>\r\n                `;\r\n\t\t\t\tbreak;\r\n\t\t\tcase 'matching':\r\n\t\t\t\tquestionHint.textContent = 'Players drag items from the left to the matching option on the right (max 5 pairs, can be less just leave empty if not needed)';\r\n\t\t\t\tcontentContainer.innerHTML = `\r\n                    <div class=\"question-row\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"left-1\" placeholder=\"Left item 1\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"right-1\" placeholder=\"Right item 1\">\r\n                    </div>\r\n                    <div class=\"question-row\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"left-2\" placeholder=\"Left item 2\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"right-2\" placeholder=\"Right item 2\">\r\n                    </div>\r\n                    <div class=\"question-row\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"left-3\" placeholder=\"Left item 3\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"right-3\" placeholder=\"Right item 3\">\r\n                    </div>\r\n                    <div class=\"question-row\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"left-4\" placeholder=\"Left item 4\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"right-4\" placeholder=\"Right item 4\">\r\n                    </div>\r\n                    <div class=\"question-row\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"left-5\" placeholder=\"Left item 5\">\r\n                        <input class=\"question-field\" type=\"text\" data-field=\"right-5\" placeholder=\"Right item 5\">\r\n                    </div>\r\n                `;\r\n\t\t\t\tbreak;\r\n\t\t\tcase 'ordering':\r\n\t\t\t\tquestionHint.textContent = 'Players drag items into the correct order';\r\n\t\t\t\tcontentContainer.innerHTML = `\r\n                        <label>Start label:</label><input type=\"text\" data-field=\"order-start\" placeholder=\"eg Earliest\">\r\n                        <label>End label:</label><input type=\"text\" data-field=\"order-end\" placeholder=\"eg Latest\">\r\n                        <label>Items to Order (enter in correct order):</label>\r\n                        <div class=\"ordering-items\">\r\n                            <input type=\"text\" data-field=\"order-item\" placeholder=\"Item 1\">\r\n                            <input type=\"text\" data-field=\"order-item\" placeholder=\"Item 2\">\r\n                            <input type=\"text\" data-field=\"order-item\" placeholder=\"Item 3\">\r\n                            <input type=\"text\" data-field=\"order-item\" placeholder=\"Item 4\">\r\n                            <input type=\"text\" data-field=\"order-item\" placeholder=\"Item 5\">\r\n                            <input type=\"text\" data-field=\"order-item\" placeholder=\"Item 6\">\r\n                        </div>\r\n                `;\r\n\t\t\t\tbreak;\r\n\t\t\tcase 'hotspot':\r\n\t\t\t\tquestionHint.textContent = 'Players select a point on the picture - closest players score the points (select picture on the left column then mark a X at the correct point)';\r\n\t\t\t\tcontentContainer.innerHTML = `\r\n                    <image-selector data-field=\"image-selector-preview\" class=\"image-selector-preview\" mode=\"hotspot\"></image-selector>\r\n                    <input type=\"hidden\" data-field=\"hotspot-x\">\r\n                    <input type=\"hidden\" data-field=\"hotspot-y\">\r\n                `;\r\n\t\t\t\tconst hotspotPreview = contentContainer.querySelector('.image-selector-preview');\r\n\t\t\t\thotspotPreview.addEventListener('selection', (event) => imageSelectorSelection(questionElement, event.detail, 'hotspot'));\r\n\t\t\t\tif (questionImage.getAttribute('src')) {\r\n\t\t\t\t\tsetImageSelectorSrc(questionElement, questionImage.getAttribute('src'));\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase 'point-it-out':\r\n\t\t\t\tquestionHint.textContent = 'Similar to hotspot, except players score if they are within the selected rectangular area (select picture on the left column then drag a rectangle on the picture)';\r\n\t\t\t\tcontentContainer.innerHTML = `\r\n                    <image-selector data-field=\"image-selector-preview\" class=\"image-selector-preview\" mode=\"rectangle\"></image-selector>\r\n                    <input type=\"hidden\" data-field=\"point-it-out-startx\">\r\n                    <input type=\"hidden\" data-field=\"point-it-out-starty\">\r\n                    <input type=\"hidden\" data-field=\"point-it-out-endx\">\r\n                    <input type=\"hidden\" data-field=\"point-it-out-endy\">\r\n                `;\r\n\t\t\t\tconst pointItOutPreview = contentContainer.querySelector('[data-field=\"image-selector-preview\"]');\r\n\t\t\t\tpointItOutPreview.addEventListener('selection', (event) => imageSelectorSelection(questionElement, event.detail, 'point-it-out'));\r\n\t\t\t\tif (questionImage.getAttribute('src')) {\r\n\t\t\t\t\tsetImageSelectorSrc(questionElement, questionImage.getAttribute('src'));\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase 'draw':\r\n\t\t\t\tquestionHint.textContent = 'Players draw or write the answer on their screen - teams mark each others answers';\r\n\t\t\t\tcontentContainer.innerHTML = `\r\n                    <label>Answer</label><input type=\"text\" data-field=\"answer\" placeholder=\"Enter answer\">\r\n                `;\r\n\t\t\t\tbreak;\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tfunction createCompositeQuestion() {\r\n\t\tconst container = document.createElement('div');\r\n\t\tcontainer.className = 'question-content composite';\r\n\r\n\t\t// Add the question text field\r\n\t\tcontainer.appendChild(createLabelledInput(\"Question\", \"Enter your question\"));\r\n\r\n\t\t// Add a label for the top of the answer list\r\n\t\tcontainer.appendChild(createUnlabelledInput('Top Label'));\r\n\r\n\t\t// Add four text fields for possible answers\r\n\t\tcontainer.appendChild(createMultipleAnswerFields(4));\r\n\r\n\t\t// Add a label for the bottom of the answer list\r\n\t\tcontainer.appendChild(createUnlabelledInput('Bottom Label'));\r\n\r\n\t\treturn container;\r\n\t}\r\n\tfunction createQuestionTextField(label, placeholder) {\r\n\t\tconst questionField = document.createElement('div');\r\n\t\tquestionField.className = 'question-row';\r\n\t\tquestionField.innerHTML = `\r\n            <div class=\"question-field full-width\">\r\n                <label>${label}</label><input type=\"text\" class=\"question-text\" placeholder=\"${placeholder}\">\r\n            </div>\r\n        `;\r\n\t\treturn questionField;\r\n\t}\r\n\tfunction createUnlabelledInput(placeholder) {\r\n\t\tconst unlabelField = document.createElement('div');\r\n\t\tunlabelField.className = 'question-field';\r\n\t\tunlabelField.innerHTML = `\r\n            <input type=\"text\" class=\"label-text\" placeholder=\"${placeholder}\">\r\n        `;\r\n\t\treturn unlabelField;\r\n\t}\r\n\tfunction createUnLabelledInput(label, placeholder) {\r\n\t\tconst labelField = document.createElement('div');\r\n\t\tlabelField.className = 'question-field';\r\n\t\tlabelField.innerHTML = `\r\n            <label>${label}</label><input type=\"text\" class=\"label-text\" placeholder=\"${placeholder}\">\r\n        `;\r\n\t\treturn labelField;\r\n\t}\r\n\tfunction createQuestionRow(content) {\r\n\t\tconst questionRow = document.createElement('div');\r\n\t\tquestionRow.className = 'question-row';\r\n\t\tquestionRow.innerHTML = content;\r\n\t\treturn questionRow;\r\n\t}\r\n\tfunction createMultipleAnswerFields(count) {\r\n\t\tconst answersContainer = document.createElement('div');\r\n\t\tanswersContainer.className = 'question-row';\r\n\r\n\t\tfor (let i = 1; i <= count; i++) {\r\n\t\t\tconst answerField = createUnlabelledInput(\"Answer ${i}\");\r\n\t\t\tanswersContainer.appendChild(answerField);\r\n\t\t}\r\n\t\treturn answersContainer;\r\n\t}\r\n\r\n\r\n\tfunction addRoundQuestionNumbers() {\r\n\t\tconst roundElements = document.querySelectorAll('.round');\r\n\t\troundElements.forEach((roundElement, index) => {\r\n\t\t\troundElement.querySelector('.header-round-number').textContent = index + 1;\r\n\t\t\tconst questionElements = roundElement.querySelectorAll('.question');\r\n\t\t\tquestionElements.forEach((questionElement, questionIndex) => {\r\n\t\t\t\tquestionElement.querySelector('.header-question-number').textContent = questionIndex + 1;\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\tfunction updateHeaderWithTitle(event) {\r\n\t\tconsole.log('updateHeaderWithTitle:', event.target.value);\r\n\t\tconst headerToUpdate = event.target.closest('.quiz, .round, .question');\r\n\t\theaderToUpdate.querySelector('.header-title').textContent = event.target.value;\r\n\t}\r\n\r\n\t// Image Upload functions\r\n\t// There are three entry point for image uploads:\r\n\t// 1. handleDropFiles - called when files are dropped into the dropzone\r\n\t// 2. handleFilesUpload - called when (multiple) files are selected from the file input\r\n\t// 3. readImageDataFromFiles - the actual file reader\r\n\t// 1 and 2 call 3 to carry out the file reading\r\n\tfunction handleDropFiles(event) {\r\n\t\tconsole.log('handleDropFiles:', event.target.closest('.question'));\r\n\t\tconst dt = event.dataTransfer;\r\n\t\tconst files = dt.files;\r\n\t\tif (files.length > 0) {\r\n\t\t\treadImageDataFromFiles(files[0], event.target.closest('.question'));\r\n\t\t}\r\n\t}\r\n\tfunction handleQuestionImageUpload(file, questionElement) {\r\n\t\tconst reader = new FileReader();\r\n\t\treader.onload = (e) => {\r\n\t\t\tconst imagePreview = questionElement.querySelector('[data-field=\"question-image\"]');\r\n\t\t\timagePreview.src = e.target.result;\r\n\t\t\timagePreview.style.display = 'block';\r\n\r\n\t\t\t// Store the data URL in the URL field or in a hidden field\r\n\t\t\tconst imageUrlField = questionElement.querySelector('[data-field=\"question-image-url\"]');\r\n\t\t\timageUrlField.value = ''; // Clear URL field since we're using a local file\r\n\r\n\t\t\t// Store the image data for later use (when saving)\r\n\t\t\tquestionElement.dataset.imageData = e.target.result;\r\n\t\t};\r\n\t\treader.readAsDataURL(file);\r\n\t}\r\n\tfunction handleImageUpload(event) {\r\n\t\tconsole.log('handleImageUpload:', event.target.closest('.question'));\r\n\t\tconst files = event.target.files;\r\n\t\tif (files.length > 0) {\r\n\t\t\treadImageDataFromFiles(files[0], event.target.closest('.question'));\r\n\t\t}\r\n\t}\r\n\tfunction readImageDataFromFiles(file, questionElement) {\r\n\t\tconsole.log('readImageDataFromFiles:', file, questionElement.querySelector('[data-field=\"question-image\"]'));\r\n\t\tconst reader = new FileReader();\r\n\t\treader.onload = function (e) {\r\n\t\t\tconsole.log('readImageDataFromFiles onload:', e.target.result);\r\n\t\t\t// questionElement.dataset.imageData = e.target.result;\r\n\t\t\t// const previewDiv = questionElement.querySelector('.image-preview');\r\n\t\t\t// previewDiv.innerHTML = `<img src=\"${e.target.result}\" style=\"max-width:200px; max-height:200px;\">`;\r\n\t\t\tconst imageSelectorPreviews = questionElement.querySelectorAll('[data-field=\"question-image\"]');\r\n\t\t\tif (imageSelectorPreviews) {\r\n\t\t\t\tconsole.log('setImageSelectorSrc:');\r\n\t\t\t\timageSelectorPreviews.forEach(imageSelectorPreview => {\r\n\t\t\t\t\tsetImageSelectorSrc(questionElement, e.target.result);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t\treader.readAsDataURL(file);\r\n\t}\r\n\t// Handle external image url - no need to load the file simply access from the URL\r\n\t// Called when question-image element loses focus - update the src attribute of selectors\r\n\tfunction handleExternalImageURL(event) {\r\n\t\tconsole.log('handleExternalImageURL:', event.target.value);\r\n\t\t// Just in case user focuses and then blurs without entering a URL\r\n\t\tif (event.target.value) {\r\n\t\t\tconst questionElement = event.target.closest('.question');\r\n\t\t\tsetImageSelectorSrc(questionElement, event.target.value);\r\n\r\n\t\t\t// Similar to if selecting image from library - we show the remove button and hide the add button\r\n\t\t\tquestionElement.querySelector('.clear-image-btn').style.display = 'inline-block';\r\n\t\t\tquestionElement.querySelector('.add-from-library').style.display = 'none';\r\n\r\n\t\t}\r\n\t}\r\n\r\n\t// setImageSelectorSrc\r\n\t// When a new image is selected we update the image-selector-preview elements\r\n\t// There can be 2 of these: the first is the question image, the second is the answer image (in the case of hotspot/point-it-out)\r\n\tfunction setImageSelectorSrc(questionElement, src) {\r\n\t\tconsole.log('setImageSelectorSrc:', src);\r\n\t\tconst questionImage = questionElement.querySelector('[data-field=\"question-image-url\"]');\r\n\t\tif (questionImage) {\r\n\t\t\tquestionImage.value = src;\r\n\t\t}\r\n\t\tconst imageSelectorPreviews = questionElement.querySelectorAll('.image-selector-preview');\r\n\t\tif (imageSelectorPreviews) {\r\n\t\t\tconsole.log('setImageSelectorSrc: imageSelectorPreview:', imageSelectorPreviews);\r\n\t\t\timageSelectorPreviews.forEach(imageSelectorPreview => {\r\n\t\t\t\timageSelectorPreview.setAttribute('src', src);\r\n\t\t\t\timageSelectorPreview.style.display = 'block';\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\tfunction imageSelectorSelection(questionElement, details, type) {\r\n\t\tconsole.log('imageSelectorSelection:', questionElement, details, type);\r\n\t\tif (type === 'hotspot') {\r\n\t\t\tquestionElement.querySelector('[data-field=\"hotspot-x\"]').value = details.x;\r\n\t\t\tquestionElement.querySelector('[data-field=\"hotspot-y\"]').value = details.y;\r\n\t\t} else if (type === 'point-it-out') {\r\n\t\t\tconsole.log('update point-it-out:', details);\r\n\t\t\tquestionElement.querySelector('[data-field=\"point-it-out-startx\"]').value = details.start.x;\r\n\t\t\tquestionElement.querySelector('[data-field=\"point-it-out-starty\"]').value = details.start.y;\r\n\t\t\tquestionElement.querySelector('[data-field=\"point-it-out-endx\"]').value = details.end.x;\r\n\t\t\tquestionElement.querySelector('[data-field=\"point-it-out-endy\"]').value = details.end.y;\r\n\t\t}\r\n\t}\r\n\r\n\tfunction createJSONfromQuiz() {\r\n\r\n\t\tconst quizJSON = {\r\n\t\t\t_id: document.getElementById('quiz-id').value,\r\n\t\t\tschemaVersion: document.getElementById('quiz-schema-version').value,\r\n\t\t\towner: document.getElementById('quiz-owner').value,\r\n\t\t\ttitle: document.getElementById('quiz-title').value,\r\n\t\t\tdescription: document.getElementById('quiz-description').value,\r\n\t\t\t// description: document.querySelector('#quiz-description .ql-editor').innerHTML,\r\n\t\t\t// description: quill.root.innerHTML,\r\n\t\t\trounds: Array.from(roundsContainer.querySelectorAll('details.round')).map(roundElement => ({\r\n\t\t\t\t_id: roundElement.querySelector('.round-id').value,\r\n\t\t\t\towner: roundElement.querySelector('.round-owner').value,\r\n\t\t\t\ttitle: roundElement.querySelector('.round-title').value,\r\n\t\t\t\tdescription: roundElement.querySelector('.round-description').value,\r\n\t\t\t\troundTimer: roundElement.querySelector('[data-field=\"round-timer\"]').value,\r\n\t\t\t\tshowAnswer: roundElement.querySelector('[data-field=\"show-answer\"]').value,\r\n\t\t\t\tupdateScores: roundElement.querySelector('[data-field=\"update-scores\"]').value,\r\n\t\t\t\tquestions: Array.from(roundElement.querySelectorAll('details.question')).map(questionElement => gatherQuestionData(questionElement))\r\n\t\t\t}))\r\n\t\t}\r\n\t\tconsole.log('createJSONfromQuiz:', quizJSON);\r\n\t\treturn quizJSON;\r\n\t}\r\n\r\n\tfunction exportQuiz() {\r\n\r\n\t\tconst quizJSON = createJSONfromQuiz();\r\n\t\tconst blob = new Blob([JSON.stringify(quizJSON, null, 2)], { type: 'application/json' });\r\n\t\tconst url = URL.createObjectURL(blob);\r\n\t\tconst a = document.createElement('a');\r\n\t\ta.href = url;\r\n\t\ta.download = 'quiz.json';\r\n\t\ta.click();\r\n\t\tURL.revokeObjectURL(url);\r\n\t\tdocument.getElementById('quiz-json').value = JSON.stringify(quizJSON, null, 2);\r\n\t}\r\n\r\n\t// Client-side JavaScript\r\n\tasync function uploadQuiz(quizFile) {\r\n\t\ttry {\r\n\t\t\t// Read the file\r\n\t\t\tconst fileContent = await quizFile.text();\r\n\t\t\tconst quizData = JSON.parse(fileContent);\r\n\r\n\t\t\t// Send to server\r\n\t\t\tconst response = await fetch('/api/quiz/upload', {\r\n\t\t\t\tmethod: 'POST',\r\n\t\t\t\theaders: {\r\n\t\t\t\t\t'Content-Type': 'application/json'\r\n\t\t\t\t},\r\n\t\t\t\tbody: JSON.stringify(quizData)\r\n\t\t\t});\r\n\t\t\tconst result = await response.json();\r\n\r\n\t\t\tif (!result.success) {\r\n\t\t\t\t// Handle validation errors\r\n\t\t\t\tdisplayValidationErrors(result.errors);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\t// Quiz is valid, show success message\r\n\t\t\tshowSuccessMessage(result.message);\r\n\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error('Error uploading quiz:', error);\r\n\t\t\tshowErrorMessage('Failed to upload quiz. Please try again.');\r\n\t\t}\r\n\t}\r\n\r\n\t// Add this function to improve validation error messages\r\n\tfunction improveValidationErrorMessage(error) {\r\n\t\t// The original error message\r\n\t\tconst originalMessage = error.message;\r\n\t\t// The path where the error occurred\r\n\t\tconst path = error.instancePath;\r\n\r\n\t\t// Common error translations\r\n\t\tif (originalMessage === 'must match \"then\" schema') {\r\n\t\t\t// Extract the question type from the data\r\n\t\t\tconst pathParts = path.split('/');\r\n\r\n\t\t\t// For questions, check what type it is\r\n\t\t\tif (path.includes('questions')) {\r\n\t\t\t\t// Find the round and question index\r\n\t\t\t\tconst roundIndex = parseInt(pathParts[pathParts.indexOf('rounds') + 1]);\r\n\t\t\t\tconst questionIndex = parseInt(pathParts[pathParts.indexOf('questions') + 1]);\r\n\r\n\t\t\t\t// Get the question data\r\n\t\t\t\tconst questionData = document.querySelectorAll('.round')[roundIndex]\r\n\t\t\t\t\t?.querySelectorAll('.question')[questionIndex]\r\n\t\t\t\t\t?.dataset.questionData;\r\n\r\n\t\t\t\tif (questionData) {\r\n\t\t\t\t\tconst question = JSON.parse(questionData);\r\n\r\n\t\t\t\t\t// Provide specific messages based on question type\r\n\t\t\t\t\tswitch (question.type) {\r\n\r\n\t\t\t\t\t\tcase 'multiple-choice':\r\n\t\t\t\t\t\t\treturn \"This question requires at least 2 options and a correct answer\";\r\n\r\n\t\t\t\t\t\tcase 'true-false':\r\n\t\t\t\t\t\t\treturn \"This question requires a True or False answer\";\r\n\r\n\t\t\t\t\t\tcase 'text':\r\n\t\t\t\t\t\tcase 'number-exact':\r\n\t\t\t\t\t\tcase 'number-closest':\r\n\t\t\t\t\t\t\treturn \"This question requires an answer\";\r\n\r\n\t\t\t\t\t\tcase 'number-average':\r\n\t\t\t\t\t\t\treturn \"This question does not require an answer\";\r\n\r\n\t\t\t\t\t\tcase 'hotspot':\r\n\t\t\t\t\t\t\treturn \"This question requires hotspot coordinates\";\r\n\r\n\t\t\t\t\t\tcase 'point-it-out':\r\n\t\t\t\t\t\t\treturn \"This question requires coordinates of two opposite corners of the rectangle\";\r\n\r\n\t\t\t\t\t\tcase 'ordering':\r\n\t\t\t\t\t\t\treturn \"This question requires 2-6 items to order plus optional start/end labels\";\r\n\r\n\t\t\t\t\t\tcase 'matching':\r\n\t\t\t\t\t\t\treturn \"This question requires at least 2 matching pairs\";\r\n\r\n\t\t\t\t\t\tcase 'draw':\r\n\t\t\t\t\t\t\treturn \"This drawing question is missing required settings\";\r\n\r\n\t\t\t\t\t\tdefault:\r\n\t\t\t\t\t\t\treturn `This ${question.type} question is missing required fields`;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// Generic fallback message\r\n\t\t\treturn \"This item is missing required fields based on its type\";\r\n\t\t}\r\n\r\n\t\t// Other common error messages\r\n\t\tif (originalMessage.includes(\"required property\")) {\r\n\t\t\tconst property = originalMessage.match(/'([^']+)'/)?.[1];\r\n\r\n\t\t\t// Map property names to user-friendly terms\r\n\t\t\tconst propertyMap = {\r\n\t\t\t\t'title': 'Title',\r\n\t\t\t\t'text': 'Question text',\r\n\t\t\t\t'answer': 'Answer',\r\n\t\t\t\t'options': 'Answer options',\r\n\t\t\t\t'correctOption': 'Correct option',\r\n\t\t\t\t'items': 'Items to order',\r\n\t\t\t\t'pairs': 'Matching pairs',\r\n\t\t\t\t'startLabel': 'Start label',\r\n\t\t\t\t'endLabel': 'End label'\r\n\t\t\t};\r\n\r\n\t\t\treturn `Missing required field: ${propertyMap[property] || property}`;\r\n\t\t}\r\n\r\n\t\t// Return the original message if we don't have a specific improvement\r\n\t\treturn originalMessage;\r\n\t}\r\n\r\n\r\n\t// Display validation errors and add warning icons\r\n\tfunction displayValidationErrors(validationResults) {\r\n\r\n\t\t// First, clear any existing error indicators\r\n\t\tclearValidationErrors();\r\n\r\n\t\tif (!validationResults || validationResults.length === 0) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Create error tracking objects\r\n\t\tconst roundErrors = {};  // Store errors by round index\r\n\t\tconst questionErrors = {}; // Store errors by round and question indices\r\n\r\n\t\t// Display summary of errors at the top\r\n\t\tconst errorCount = validationResults.length;\r\n\t\tconst errorSummary = document.getElementById('validation-summary');\r\n\t\terrorSummary.textContent = `Found ${errorCount} error${errorCount > 1 ? 's' : ''}. Please fix before saving.`;\r\n\t\terrorSummary.style.display = 'block';\r\n\r\n\t\t// Process each error\r\n\t\tvalidationResults.forEach(error => {\r\n\t\t\t// Parse the error path to determine where to display the error\r\n\t\t\tconst path = error.instancePath.split('/');\r\n\r\n\t\t\t// Skip the first empty element from the split\r\n\t\t\tpath.shift();\r\n\r\n\t\t\tif (path.length === 0) {\r\n\t\t\t\t// Quiz-level error\r\n\t\t\t\tdisplayQuizError(error);\r\n\t\t\t} else if (path[0] === 'rounds') {\r\n\t\t\t\tconst roundIndex = parseInt(path[1]);\r\n\r\n\t\t\t\t// Track round errors\r\n\t\t\t\tif (!roundErrors[roundIndex]) {\r\n\t\t\t\t\troundErrors[roundIndex] = [];\r\n\t\t\t\t}\r\n\t\t\t\troundErrors[roundIndex].push(error.message);\r\n\r\n\t\t\t\tif (path.length === 2 || path.length === 3) {\r\n\t\t\t\t\t// Error on the round itself\r\n\t\t\t\t\tdisplayRoundError(roundIndex, error);\r\n\t\t\t\t} else if (path[2] === 'questions') {\r\n\t\t\t\t\tconst questionIndex = parseInt(path[3]);\r\n\r\n\t\t\t\t\t// Track question errors\r\n\t\t\t\t\tif (!questionErrors[roundIndex]) {\r\n\t\t\t\t\t\tquestionErrors[roundIndex] = {};\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (!questionErrors[roundIndex][questionIndex]) {\r\n\t\t\t\t\t\tquestionErrors[roundIndex][questionIndex] = [];\r\n\t\t\t\t\t}\r\n\t\t\t\t\tquestionErrors[roundIndex][questionIndex].push(error.message);\r\n\r\n\t\t\t\t\t// Display error in the question\r\n\t\t\t\t\tconst field = path.length > 4 ? path[4] : null;\r\n\t\t\t\t\tdisplayQuestionError(roundIndex, questionIndex, field, error);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t// Add warning icons to rounds with errors\r\n\t\tObject.keys(roundErrors).forEach(roundIndex => {\r\n\t\t\taddRoundErrorIndicator(parseInt(roundIndex), roundErrors[roundIndex].length);\r\n\t\t});\r\n\r\n\t\t// Add warning icons to questions with errors\r\n\t\tObject.keys(questionErrors).forEach(roundIndex => {\r\n\t\t\tObject.keys(questionErrors[roundIndex]).forEach(questionIndex => {\r\n\t\t\t\taddQuestionErrorIndicator(\r\n\t\t\t\t\tparseInt(roundIndex),\r\n\t\t\t\t\tparseInt(questionIndex),\r\n\t\t\t\t\tquestionErrors[roundIndex][questionIndex].length\r\n\t\t\t\t);\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\t// Update clearValidationErrors to hide indicators instead of removing them\r\n\tfunction clearValidationErrors() {\r\n\t\t// Clear summary\r\n\t\tconst errorSummary = document.getElementById('validation-summary');\r\n\t\tif (errorSummary) {\r\n\t\t\terrorSummary.textContent = '';\r\n\t\t\terrorSummary.style.display = 'none';\r\n\t\t}\r\n\r\n\t\t// Clear quiz errors\r\n\t\tdocument.querySelectorAll('.error-message').forEach(el => el.remove());\r\n\r\n\t\t// Clear field errors\r\n\t\tdocument.querySelectorAll('.error-field').forEach(el => {\r\n\t\t\tel.classList.remove('error-field');\r\n\t\t\tel.title = '';\r\n\t\t});\r\n\r\n\t\t// Hide error indicators instead of removing them\r\n\t\tdocument.querySelectorAll('.error-indicator').forEach(el => {\r\n\t\t\tel.style.display = 'none';\r\n\t\t\tel.classList.remove('animate');\r\n\t\t\tdelete el.dataset.count;\r\n\t\t});\r\n\t}\r\n\r\n\t// Modify the addRoundErrorIndicator function to toggle visibility\r\n\tfunction addRoundErrorIndicator(roundIndex, errorCount) {\r\n\t\tconst rounds = document.querySelectorAll('.round');\r\n\t\tif (roundIndex >= 0 && roundIndex < rounds.length) {\r\n\t\t\tconst roundElement = rounds[roundIndex];\r\n\t\t\tconst indicator = roundElement.querySelector('.error-indicator');\r\n\r\n\t\t\tif (indicator) {\r\n\t\t\t\t// Make it visible\r\n\t\t\t\tindicator.style.display = 'inline-flex';\r\n\t\t\t\tindicator.title = `This round has ${errorCount} error${errorCount > 1 ? 's' : ''}`;\r\n\r\n\t\t\t\t// Add error count if more than 1\r\n\t\t\t\tif (errorCount > 1) {\r\n\t\t\t\t\tindicator.dataset.count = errorCount;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tdelete indicator.dataset.count;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Add animation to draw attention\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tindicator.classList.add('animate');\r\n\t\t\t\t}, 100);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t// Modify the addQuestionErrorIndicator function to toggle visibility\r\n\tfunction addQuestionErrorIndicator(roundIndex, questionIndex, errorCount) {\r\n\t\tconst rounds = document.querySelectorAll('.round');\r\n\t\tif (roundIndex >= 0 && roundIndex < rounds.length) {\r\n\t\t\tconst roundElement = rounds[roundIndex];\r\n\t\t\tconst questions = roundElement.querySelectorAll('.question');\r\n\r\n\t\t\tif (questionIndex >= 0 && questionIndex < questions.length) {\r\n\t\t\t\tconst questionElement = questions[questionIndex];\r\n\t\t\t\tconst indicator = questionElement.querySelector('.error-indicator');\r\n\r\n\t\t\t\tif (indicator) {\r\n\t\t\t\t\t// Make it visible\r\n\t\t\t\t\tindicator.style.display = 'inline-flex';\r\n\t\t\t\t\tindicator.title = `This question has ${errorCount} error${errorCount > 1 ? 's' : ''}`;\r\n\r\n\t\t\t\t\t// Add error count if more than 1\r\n\t\t\t\t\tif (errorCount > 1) {\r\n\t\t\t\t\t\tindicator.dataset.count = errorCount;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tdelete indicator.dataset.count;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// Add animation to draw attention\r\n\t\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\t\tindicator.classList.add('animate');\r\n\t\t\t\t\t}, 100);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t// Initialize event listeners for error indicators\r\n\tfunction initErrorIndicatorHandlers() {\r\n\t\tdocument.addEventListener('click', (event) => {\r\n\t\t\tif (event.target.closest('.error-indicator')) {\r\n\t\t\t\tconst indicator = event.target.closest('.error-indicator');\r\n\r\n\t\t\t\t// Find the closest round or question\r\n\t\t\t\tconst container = indicator.closest('.round, .question');\r\n\r\n\t\t\t\t// Ensure it's expanded to show the errors\r\n\t\t\t\tif (container && !container.hasAttribute('open')) {\r\n\t\t\t\t\tcontainer.setAttribute('open', 'true');\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Animate the error messages to draw attention\r\n\t\t\t\tconst errorMessages = container.querySelectorAll('.error-message');\r\n\t\t\t\terrorMessages.forEach(msg => {\r\n\t\t\t\t\tmsg.style.transition = 'background-color 0.5s';\r\n\t\t\t\t\tmsg.style.backgroundColor = 'rgba(240, 173, 78, 0.3)';\r\n\t\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\t\tmsg.style.backgroundColor = 'rgba(217, 83, 79, 0.1)';\r\n\t\t\t\t\t}, 500);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\r\n\t// Display quiz-level error\r\n\tfunction displayQuizError(error) {\r\n\t\tconst quizElement = document.querySelector('.quiz');\r\n\t\tconst errorElement = document.createElement('div');\r\n\t\terrorElement.className = 'error-message';\r\n\t\terrorElement.textContent = improveValidationErrorMessage(error);\r\n\r\n\t\t// Insert after the header\r\n\t\tconst header = quizElement.querySelector('header');\r\n\t\theader.parentNode.insertBefore(errorElement, header.nextSibling);\r\n\r\n\t\t// Also highlight the quiz title if it's empty\r\n\t\tif (message.includes('title')) {\r\n\t\t\tconst titleInput = document.getElementById('quiz-title');\r\n\t\t\ttitleInput.classList.add('error-field');\r\n\t\t\ttitleInput.title = error.message;\r\n\t\t}\r\n\t}\r\n\r\n\t// Display round-level error\r\n\tfunction displayRoundError(roundIndex, error) {\r\n\t\tconst rounds = document.querySelectorAll('.round');\r\n\t\tif (roundIndex >= 0 && roundIndex < rounds.length) {\r\n\t\t\tconst roundElement = rounds[roundIndex];\r\n\r\n\t\t\t// Create error message\r\n\t\t\tconst errorElement = document.createElement('div');\r\n\t\t\terrorElement.className = 'error-message';\r\n\t\t\terrorElement.textContent = improveValidationErrorMessage(error);\r\n\r\n\t\t\t// Insert after the summary\r\n\t\t\tconst summary = roundElement.querySelector('summary');\r\n\t\t\tsummary.parentNode.insertBefore(errorElement, summary.nextSibling);\r\n\r\n\t\t\t// Highlight specific fields based on the error message\r\n\t\t\tlet titleInput = null;\r\n\t\t\tif (error.message.includes('title')) {\r\n\t\t\t\ttitleInput = roundElement.querySelector('.round-title');\r\n\t\t\t}\r\n\t\t\tif (error.instancePath.includes('updateScores')) {\r\n\t\t\t\ttitleInput = roundElement.querySelector('[data-field=\"update-scores\"]');\r\n\t\t\t}\r\n\t\t\tif (error.instancePath.includes('showAnswer')) {\r\n\t\t\t\ttitleInput = roundElement.querySelector('[data-field=\"show-answer\"]');\r\n\t\t\t}\r\n\t\t\tif (titleInput) {\r\n\t\t\t\ttitleInput.classList.add('error-field');\r\n\t\t\t\ttitleInput.title = error.message;\r\n\t\t\t}\r\n\r\n\t\t\t// Make sure the round is expanded\r\n\t\t\troundElement.setAttribute('open', 'true');\r\n\t\t}\r\n\t}\r\n\r\n\t// Display question-level error\r\n\tfunction displayQuestionError(roundIndex, questionIndex, field, error) {\r\n\t\tconst rounds = document.querySelectorAll('.round');\r\n\t\tif (roundIndex >= 0 && roundIndex < rounds.length) {\r\n\t\t\tconst roundElement = rounds[roundIndex];\r\n\t\t\tconst questions = roundElement.querySelectorAll('.question');\r\n\r\n\t\t\tif (questionIndex >= 0 && questionIndex < questions.length) {\r\n\t\t\t\tconst questionElement = questions[questionIndex];\r\n\r\n\t\t\t\t// Create error message\r\n\t\t\t\tconst errorElement = document.createElement('div');\r\n\t\t\t\terrorElement.className = 'error-message';\r\n\t\t\t\terrorElement.textContent = improveValidationErrorMessage(error);\r\n\r\n\t\t\t\t// Insert after the summary\r\n\t\t\t\tconst summary = questionElement.querySelector('summary');\r\n\t\t\t\tsummary.parentNode.insertBefore(errorElement, summary.nextSibling);\r\n\r\n\t\t\t\t// Highlight specific field based on the error\r\n\t\t\t\tif (field) {\r\n\t\t\t\t\tconst fieldElement = questionElement.querySelector(`[data-field=\"${field}\"]`);\r\n\t\t\t\t\tif (fieldElement) {\r\n\t\t\t\t\t\tfieldElement.classList.add('error-field');\r\n\t\t\t\t\t\tfieldElement.title = error.message;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (error.message.includes('text')) {\r\n\t\t\t\t\tconst textInput = questionElement.querySelector('[data-field=\"question-text\"]');\r\n\t\t\t\t\ttextInput.classList.add('error-field');\r\n\t\t\t\t\ttextInput.title = error.message;\r\n\t\t\t\t} else if (error.message.includes('answer')) {\r\n\t\t\t\t\tconst answerInput = questionElement.querySelector('[data-field=\"answer\"]');\r\n\t\t\t\t\tif (answerInput) {\r\n\t\t\t\t\t\tanswerInput.classList.add('error-field');\r\n\t\t\t\t\t\tanswerInput.title = error.message;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfunction displayValidationErrorsOrig(errors) {\r\n\t\tconst errorContainer = document.getElementById('validation-errors');\r\n\t\terrorContainer.innerHTML = '';\r\n\r\n\t\tconst heading = document.createElement('h3');\r\n\t\theading.textContent = 'Quiz Validation Errors:';\r\n\t\terrorContainer.appendChild(heading);\r\n\r\n\t\tconst list = document.createElement('ul');\r\n\t\terrors.forEach(error => {\r\n\t\t\tconst item = document.createElement('li');\r\n\t\t\t// Format error message to be user-friendly\r\n\t\t\titem.textContent = `${error.instancePath} ${error.message}`;\r\n\t\t\tlist.appendChild(item);\r\n\t\t});\r\n\r\n\t\terrorContainer.appendChild(list);\r\n\t\terrorContainer.style.display = 'block';\r\n\r\n\r\n\t}\r\n\r\n\tfunction gatherQuestionData(questionElement) {\r\n\t\tconst type = questionElement.querySelector('.question-type').value;\r\n\t\tconst baseData = {\r\n\t\t\ttype: type,\r\n\t\t\t_id: questionElement.querySelector('.question-id').value,\r\n\t\t\towner: questionElement.querySelector('.question-owner').value,\r\n\t\t\ttext: questionElement.querySelector('[data-field=\"question-text\"]').value,\r\n\t\t\timage: questionElement.querySelector('[data-field=\"question-image\"]').getAttribute('src'),\r\n\t\t\taudio: questionElement.querySelector('[data-field=\"question-audio\"]').value,\r\n\t\t\tanswer: null,\r\n\t\t\toptions: [],\r\n\t\t\tpairs: [],\r\n\t\t\titems: [],\r\n\t\t\textra: {}\r\n\t\t};\r\n\r\n\t\tconsole.log('gatherQuestionData:', type, baseData);\r\n\r\n\t\tswitch (type) {\r\n\r\n\t\t\tcase 'multiple-choice':\r\n\t\t\t\tlet options = [\r\n\t\t\t\t\tquestionElement.querySelector('[data-field=\"option-1\"]').value,\r\n\t\t\t\t\tquestionElement.querySelector('[data-field=\"option-2\"]').value,\r\n\t\t\t\t\tquestionElement.querySelector('[data-field=\"option-3\"]').value,\r\n\t\t\t\t\tquestionElement.querySelector('[data-field=\"option-4\"]').value,\r\n\t\t\t\t\tquestionElement.querySelector('[data-field=\"option-5\"]').value,\r\n\t\t\t\t\tquestionElement.querySelector('[data-field=\"option-6\"]').value,\r\n\t\t\t\t\tquestionElement.querySelector('[data-field=\"option-7\"]').value,\r\n\t\t\t\t\tquestionElement.querySelector('[data-field=\"option-8\"]').value\r\n\t\t\t\t];\r\n\t\t\t\tbaseData.options = options.filter((option) => { return option != \"\"; });\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase 'true-false':\r\n\t\t\t\tbaseData.answer = questionElement.querySelector('[data-field=\"answer\"]').value;\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase 'text':\r\n\t\t\t\tbaseData.answer = questionElement.querySelector('[data-field=\"answer\"]').value;\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase 'number-exact':\r\n\t\t\tcase 'number-closest':\r\n\t\t\tcase 'number-average':\r\n\t\t\t\tconst numValue = questionElement.querySelector('[data-field=\"answer\"]').value;\r\n\t\t\t\tbaseData.answer = numValue !== '' ? Number(numValue) : null;\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase 'matching':\r\n\t\t\t\tconst pairs = Array.from([1, 2, 3, 4, 5]).map(index => ({\r\n\t\t\t\t\tleft: questionElement.querySelector(`[data-field=\"left-${index}\"]`).value,\r\n\t\t\t\t\tright: questionElement.querySelector(`[data-field=\"right-${index}\"]`).value\r\n\t\t\t\t}));\r\n\t\t\t\tbaseData.pairs = pairs.filter((pair) => { return pair.left != \"\"; });\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase 'ordering':\r\n\t\t\t\tbaseData.extra = {};\r\n\t\t\t\tbaseData.extra.startLabel = questionElement.querySelector('[data-field=\"order-start\"]').value;\r\n\t\t\t\tbaseData.extra.endLabel = questionElement.querySelector('[data-field=\"order-end\"]').value;\r\n\t\t\t\tconst items = Array.from(questionElement.querySelectorAll('[data-field=\"order-item\"]')).map(input => input.value);\r\n\t\t\t\tbaseData.items = items.filter((item) => { return item != \"\"; });\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase 'hotspot':\r\n\t\t\t\t// Convert the values to numbers using '+' - send null if x not set\r\n\t\t\t\tconsole.log('gatherQuestionData: hotspot:', questionElement.querySelector('[data-field=\"hotspot-x\"]').value);\r\n\t\t\t\tbaseData.answer = questionElement.querySelector('[data-field=\"hotspot-x\"]').value ? {\r\n\t\t\t\t\tx: +questionElement.querySelector('[data-field=\"hotspot-x\"]').value,\r\n\t\t\t\t\ty: +questionElement.querySelector('[data-field=\"hotspot-y\"]').value\r\n\t\t\t\t} : null;\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase 'point-it-out':\r\n\t\t\t\tbaseData.answer = {\r\n\t\t\t\t\tstart: {\r\n\t\t\t\t\t\tx: +questionElement.querySelector('[data-field=\"point-it-out-startx\"]').value,\r\n\t\t\t\t\t\ty: +questionElement.querySelector('[data-field=\"point-it-out-starty\"]').value\r\n\t\t\t\t\t},\r\n\t\t\t\t\tend: {\r\n\t\t\t\t\t\tx: +questionElement.querySelector('[data-field=\"point-it-out-endx\"]').value,\r\n\t\t\t\t\t\ty: +questionElement.querySelector('[data-field=\"point-it-out-endy\"]').value\r\n\t\t\t\t\t}\r\n\t\t\t\t};\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase 'draw':\r\n\t\t\t\tbaseData.answer = questionElement.querySelector('[data-field=\"answer\"]').value;\r\n\t\t\t\tbreak;\r\n\r\n\t\t}\r\n\r\n\t\treturn baseData;\r\n\t}\r\n\r\n\t// Top-level function to import quiz - must be thoroughly validated before it can be used\r\n\tasync function importQuizFromFile(file) {\r\n\r\n\t\t// Step 1: Validate file type\r\n\t\tif (!file.name.endsWith('.json') && file.type !== 'application/json') {\r\n\t\t\talert('Please select a JSON file.');\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Step 2: Read file content\r\n\t\tlet text;\r\n\t\ttry {\r\n\t\t\ttext = await file.text();\r\n\t\t\tconsole.log(`Successfully loaded file: ${file.name}`);\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error('Error loading quiz file:', error);\r\n\t\t\talert(`Failed to load quiz file: ${error.message}`);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Step 3: Parse JSON\r\n\t\tlet quizJSON;\r\n\t\ttry {\r\n\t\t\tquizJSON = JSON.parse(text);\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error('Error parsing quiz JSON:', error);\r\n\t\t\talert(`Failed to parse quiz JSON: ${error.message}`);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Step 4: Create quiz from JSON - this will also perform validation and show errors\r\n\t\ttry {\r\n\t\t\tcreateQuizFromJSON(quizJSON);\r\n\t\t\talert(`Quiz \"${quizJSON.title || 'Untitled'}\" imported - please correct any errors and then save`);\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error('Error creating quiz from JSON:', error);\r\n\t\t\talert(`Failed to create quiz: ${error.message}`);\r\n\t\t\treturn;\r\n\t\t}\r\n\t}\r\n\r\n\t// Function to validate quiz against schema via API\r\n\tasync function validateQuizSchema(quizJSON) {\r\n\t\ttry {\r\n\t\t\tconst response = await fetch('/api/quiz/validate', {\r\n\t\t\t\tmethod: 'POST',\r\n\t\t\t\theaders: {\r\n\t\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t\t\t// Add any authentication headers needed\r\n\t\t\t\t},\r\n\t\t\t\tbody: JSON.stringify(quizJSON)\r\n\t\t\t});\r\n\r\n\t\t\tif (!response.ok) {\r\n\t\t\t\tthrow new Error(`Server returned ${response.status}: ${response.statusText}`);\r\n\t\t\t}\r\n\r\n\t\t\tconst result = await response.json();\r\n\t\t\treturn result.data; // Access the data property of your apiResponse\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(\"Validation request failed:\", error);\r\n\t\t\tthrow error;\r\n\t\t}\r\n\t}\r\n\r\n\t// Function to display schema validation errors in a user-friendly way\r\n\tfunction displaySchemaErrors(errors, quizJSON) {\r\n\t\t// Create modal or popup for errors\r\n\t\tconst errorDiv = document.createElement('div');\r\n\t\terrorDiv.className = 'validation-errors';\r\n\r\n\t\t// Create header\r\n\t\tconst header = document.createElement('h3');\r\n\t\theader.textContent = 'Quiz Validation Errors';\r\n\t\terrorDiv.appendChild(header);\r\n\r\n\t\t// Create error list\r\n\t\tconst errorList = document.createElement('ul');\r\n\r\n\t\t// Process and group errors\r\n\t\terrors.forEach(error => {\r\n\t\t\tconst errorItem = document.createElement('li');\r\n\t\t\terrorItem.className = 'error-item';\r\n\r\n\t\t\t// Format the error message based on error type\r\n\t\t\tlet message = '';\r\n\t\t\tlet path = error.instancePath || '';\r\n\r\n\t\t\t// Remove leading slash from path\r\n\t\t\tif (path.startsWith('/')) {\r\n\t\t\t\tpath = path.substring(1);\r\n\t\t\t}\r\n\r\n\t\t\t// Convert JSON path to readable location\r\n\t\t\tconst pathParts = path.split('/');\r\n\t\t\tlet humanPath = '';\r\n\r\n\t\t\tif (pathParts.length > 0 && pathParts[0] !== '') {\r\n\t\t\t\tif (pathParts[0] === 'rounds') {\r\n\t\t\t\t\t// For round errors, show round title if available\r\n\t\t\t\t\tconst roundIndex = parseInt(pathParts[1], 10);\r\n\t\t\t\t\tconst roundTitle = quizJSON.rounds?.[roundIndex]?.title || `Round ${roundIndex + 1}`;\r\n\t\t\t\t\thumanPath = `Round: \"${roundTitle}\"`;\r\n\r\n\t\t\t\t\t// For question errors, add question info\r\n\t\t\t\t\tif (pathParts[2] === 'questions') {\r\n\t\t\t\t\t\tconst questionIndex = parseInt(pathParts[3], 10);\r\n\t\t\t\t\t\tconst questionText = quizJSON.rounds?.[roundIndex]?.questions?.[questionIndex]?.text ||\r\n\t\t\t\t\t\t\t`Question ${questionIndex + 1}`;\r\n\t\t\t\t\t\thumanPath += `  Question: \"${questionText.substring(0, 30)}${questionText.length > 30 ? '...' : ''}\"`;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\thumanPath = pathParts.join('  ');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// Format by error keyword\r\n\t\t\tswitch (error.keyword) {\r\n\t\t\t\tcase 'required':\r\n\t\t\t\t\tmessage = `Missing required field: ${error.params.missingProperty}`;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 'enum':\r\n\t\t\t\t\tmessage = `Invalid value. Must be one of: ${error.params.allowedValues.join(', ')}`;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 'type':\r\n\t\t\t\t\tmessage = `Expected type ${error.params.type} but got ${typeof error.data}`;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tmessage = error.message;\r\n\t\t\t}\r\n\r\n\t\t\t// Construct the full error message\r\n\t\t\terrorItem.innerHTML = humanPath ?\r\n\t\t\t\t`<strong>${humanPath}:</strong> ${message}` : message;\r\n\r\n\t\t\terrorList.appendChild(errorItem);\r\n\t\t});\r\n\r\n\t\terrorDiv.appendChild(errorList);\r\n\r\n\t\t// Add to page as modal or replace any existing error display\r\n\t\tconst existingErrors = document.querySelector('.validation-errors');\r\n\t\tif (existingErrors) {\r\n\t\t\texistingErrors.remove();\r\n\t\t}\r\n\r\n\t\t// Create a simple modal wrapper\r\n\t\tconst modalWrapper = document.createElement('div');\r\n\t\tmodalWrapper.className = 'error-modal-wrapper';\r\n\t\tmodalWrapper.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; display:flex; justify-content:center; align-items:center;';\r\n\r\n\t\t// Style the error div as a modal\r\n\t\terrorDiv.style.cssText = 'background:white; border-radius:8px; padding:20px; max-width:80%; max-height:80%; overflow-y:auto; box-shadow:0 4px 8px rgba(0,0,0,0.2);';\r\n\r\n\t\t// Add close button\r\n\t\tconst closeBtn = document.createElement('button');\r\n\t\tcloseBtn.textContent = 'Close';\r\n\t\tcloseBtn.style.cssText = 'padding:8px 16px; background:#f44336; color:white; border:none; border-radius:4px; margin-top:15px; cursor:pointer;';\r\n\t\tcloseBtn.onclick = () => modalWrapper.remove();\r\n\t\terrorDiv.appendChild(closeBtn);\r\n\r\n\t\t// Add modal to page\r\n\t\tmodalWrapper.appendChild(errorDiv);\r\n\t\tdocument.body.appendChild(modalWrapper);\r\n\t}\r\n\r\n\tasync function importQuizFromURL(url) {\r\n\r\n\t\tfetch(url)\r\n\t\t\t.then(response => {\r\n\t\t\t\tif (!response.ok) {\r\n\t\t\t\t\tthrow new Error('Network response was not ok');\r\n\t\t\t\t}\r\n\t\t\t\treturn response.json();\r\n\t\t\t})\r\n\t\t\t.then(data => {\r\n\t\t\t\tcreateQuizFromJSON(data);\r\n\t\t\t})\r\n\t\t\t.catch(error => {\r\n\t\t\t\tconsole.error('Error:', error);\r\n\t\t\t\talert('Failed to load quiz from URL. Please check the console for more details.');\r\n\t\t\t});\r\n\t}\r\n\r\n\tasync function createQuizFromJSON(quizJSON) {\r\n\t\tconsole.log('createQuizFromJSON:', quizJSON);\r\n\r\n\t\ttry {\r\n\t\t\t// Several steps here when parsing and building a quiz from JSON data\r\n\t\t\tquizJSON = normalizeQuizData(quizJSON);\r\n\r\n\t\t\t// Validate the basic structure of the quiz - this ensures it will still render in the editor\r\n\t\t\tquizJSON = validateQuizStructure(quizJSON);\r\n\r\n\t\t\tconsole.table(quizJSON);\r\n\r\n\t\t\t// Validate the quiz JSON against the schema via API\r\n\t\t\tconst validation = await validateQuizSchema(quizJSON);\r\n\t\t\tconsole.log('Validation result:', validation);\r\n\t\t\tquizJSON.validation = validation.errors || [];\r\n\r\n\t\t\t// if (!validation.valid) {\r\n\t\t\t// \t// Display validation errors in a user-friendly way\r\n\t\t\t// \tdisplaySchemaErrors(validation.errors, quizJSON);\r\n\t\t\t// }\r\n\r\n\t\t\t// Ragardless of the validation result we still want to show the quiz in the editor\r\n\t\t\t// The user can then fix any issues highlighted by the validation\r\n\t\t\tpopulateQuizWithData(quizJSON);\r\n\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error('Error during validation:', error);\r\n\t\t\talert('An error occurred during quiz validation. Please check the console for details.');\r\n\t\t\t// Still show the HTML quiz even though validation failed\r\n\t\t\tpopulateQuizWithData(quizJSON);\r\n\t\t}\r\n\t}\r\n\r\n\t// Normalize data types in the quiz JSON to ensure consistency\r\n\t// This is like another layer of validation\r\n\tfunction normalizeQuizData(quizJSON) {\r\n\t\tif (quizJSON.rounds && Array.isArray(quizJSON.rounds)) {\r\n\t\t\tquizJSON.rounds.forEach(round => {\r\n\t\t\t\tif (round.questions && Array.isArray(round.questions)) {\r\n\t\t\t\t\tround.questions.forEach(question => {\r\n\t\t\t\t\t\tconsole.log('Normalizing question:', question);\r\n\t\t\t\t\t\t// Convert true-false from boolean to string if needed\r\n\t\t\t\t\t\tif (question.type === 'true-false' && typeof question.answer === 'boolean') {\r\n\t\t\t\t\t\t\tquestion.answer = question.answer ? 'true' : 'false';\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t// Add this debug code\r\n\t\t\t\t\t\tif (question.type === 'true-false') {\r\n\t\t\t\t\t\t\tconsole.log('True-false question answer:',\r\n\t\t\t\t\t\t\t\tquestion.answer,\r\n\t\t\t\t\t\t\t\t'Type:', typeof question.answer);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t// Convert number types from string to number if needed\r\n\t\t\t\t\t\tif ((question.type === 'number-exact' || question.type === 'number-closest' || question.type === 'number-average') &&\r\n\t\t\t\t\t\t\ttypeof question.answer === 'string' && question.answer !== '') {\r\n\t\t\t\t\t\t\tquestion.answer = Number(question.answer);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\treturn quizJSON;\r\n\t}\r\n\r\n\tfunction validateQuizStructure(quizJSON) {\r\n\r\n\t\t// Ensure top-level arrays exist (but don't add content)\r\n\t\tquizJSON.rounds = quizJSON.rounds || [];\r\n\r\n\t\t// Process each round to ensure structure\r\n\t\tquizJSON.rounds.forEach(round => {\r\n\t\t\t// Ensure questions array exists\r\n\t\t\tround.questions = round.questions || [];\r\n\r\n\t\t\t// Ensure each question has the basic structure needed to render\r\n\t\t\tround.questions.forEach(question => {\r\n\t\t\t\t// Only ensure properties needed for UI rendering\r\n\t\t\t\t// Don't add default values that would hide validation issues\r\n\r\n\t\t\t\t// For example, ensure multiple-choice has options array\r\n\t\t\t\t// but don't populate it with defaults\r\n\t\t\t\tif (question.type === 'multiple-choice') {\r\n\t\t\t\t\tquestion.options = question.options || [];\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Ensure matching has pairs array\r\n\t\t\t\tif (question.type === 'matching') {\r\n\t\t\t\t\tquestion.pairs = question.pairs || [];\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Ensure ordering has items array and extra object\r\n\t\t\t\tif (question.type === 'ordering') {\r\n\t\t\t\t\tquestion.items = question.items || [];\r\n\t\t\t\t\tquestion.extra = question.extra || {};\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Ensure point-it-out has answer structure\r\n\t\t\t\tif (question.type === 'point-it-out' && question.answer) {\r\n\t\t\t\t\tquestion.answer.start = question.answer.start || {};\r\n\t\t\t\t\tquestion.answer.end = question.answer.end || {};\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\treturn quizJSON;\r\n\t}\r\n\r\n\tfunction populateQuizWithData(quizJSON) {\r\n\t\tconsole.log('populateQuizWithData:', quizJSON);\r\n\r\n\t\tdocument.getElementById('quiz-json').value = JSON.stringify(quizJSON, null, 2);\r\n\t\tdocument.getElementById('quiz-id').value = quizJSON._id || \"\";\r\n\t\tdocument.getElementById('quiz-owner').value = quizJSON.owner || \"\";\r\n\t\tdocument.getElementById('quiz-schema-version').value = quizJSON.schemaVersion || \"\";\r\n\t\tdocument.getElementById('quiz-edit').querySelector('.header-title').textContent = quizJSON.title;\r\n\t\tdocument.getElementById('quiz-title').value = quizJSON.title;\r\n\t\t// document.getElementById('validation-summary').innerHTML = JSON.stringify(quizJSON.validation);\r\n\t\t// quill.root.innerHTML = quizJSON.description;\r\n\t\tdocument.getElementById('quiz-description').value = quizJSON.description || \"\";\r\n\r\n\t\tconst summaryElement = document.getElementById('quiz-edit').querySelector('.header-quiz');\r\n\t\tif (summaryElement) {\r\n\t\t\taddCollapseAll(summaryElement);\r\n\t\t}\r\n\r\n\t\troundsContainer.innerHTML = '';\r\n\t\tquizJSON.rounds.forEach(roundJSON => {\r\n\t\t\taddRoundToDOM();\r\n\t\t\tconst roundElement = roundsContainer.lastElementChild;\r\n\t\t\troundElement.querySelector('.header-title').textContent = roundJSON.title || \"\";\r\n\t\t\troundElement.querySelector('.round-title').value = roundJSON.title || \"\";\r\n\t\t\troundElement.querySelector('.round-description').value = roundJSON.description || \"\";\r\n\t\t\troundElement.querySelector('.round-id').value = roundJSON._id || \"\";\r\n\t\t\troundElement.querySelector('.round-owner').value = roundJSON.owner || \"\";\r\n\t\t\tconst rt = roundElement.querySelector('[data-field=\"round-timer\"]');\r\n\t\t\troundElement.querySelector('[data-field=\"round-timer\"]').value = roundJSON.roundTimer;\r\n\t\t\troundElement.querySelector('[data-field=\"show-answer\"]').value = roundJSON.showAnswer;\r\n\t\t\troundElement.querySelector('[data-field=\"update-scores\"]').value = roundJSON.updateScores;\r\n\r\n\t\t\tconst questionsContainer = roundElement.querySelector('.questions-container');\r\n\t\t\troundJSON.questions.forEach(questionJSON => {\r\n\r\n\t\t\t\t// Add a basic question template to the DOM, which we will then populate with the question data\r\n\t\t\t\taddQuestionToDOM(questionsContainer);\r\n\t\t\t\tconst questionElement = questionsContainer.lastElementChild;\r\n\r\n\t\t\t\t// We always have a question text field, this is not question-specific\r\n\t\t\t\tquestionElement.querySelector('[data-field=\"question-text\"]').value = questionJSON.text;\r\n\t\t\t\tquestionElement.querySelector('.header-title').textContent = questionJSON.text;\r\n\r\n\t\t\t\t// We also always have an _id and owner (unless its a new question)\r\n\t\t\t\tquestionElement.querySelector('.question-id').value = questionJSON._id || \"\";\r\n\t\t\t\tquestionElement.querySelector('.question-owner').value = questionJSON.owner || \"\";\r\n\r\n\t\t\t\t// If we have imageData then we need to set the image selector src\r\n\t\t\t\tif (questionJSON.image) {\r\n\t\t\t\t\tsetImageSelectorSrc(questionElement, questionJSON.image);\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// What about audio?\r\n\t\t\t\tif (questionJSON.audio) {\r\n\t\t\t\t\tconst audioInput = questionElement.querySelector('[data-field=\"question-audio\"]');\r\n\t\t\t\t\taudioInput.value = questionJSON.audio;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Trigger the select chnage event which will insert the correct question type into the questionElement\r\n\t\t\t\tconst typeSelect = questionElement.querySelector('.question-type');\r\n\t\t\t\ttypeSelect.value = questionJSON.type;\r\n\t\t\t\ttypeSelect.dispatchEvent(new Event('change'));  // This will insert the correct question type into the questionElement\r\n\r\n\t\t\t\tconst contentContainer = questionElement.querySelector('.question-specific-content');\r\n\t\t\t\t// contentContainer.querySelector('[data-field=\"question-text\"]').value = question.text || '';\r\n\r\n\t\t\t\tswitch (questionJSON.type) {\r\n\r\n\t\t\t\t\tcase 'multiple-choice':\r\n\t\t\t\t\t\tquestionJSON.options.forEach((option, index) => {\r\n\t\t\t\t\t\t\tcontentContainer.querySelector(`[data-field=\"option-${index + 1}\"]`).value = option || '';\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\tcase 'true-false':\r\n\t\t\t\t\tcase 'text':\r\n\t\t\t\t\tcase 'number-exact':\r\n\t\t\t\t\tcase 'number-closest':\r\n\t\t\t\t\tcase 'number-average':\r\n\t\t\t\t\t\tcontentContainer.querySelector('[data-field=\"answer\"]').value = String(questionJSON.answer) || '';\r\n\t\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\tcase 'matching':\r\n\t\t\t\t\t\tquestionJSON.pairs.forEach((pair, index) => {\r\n\t\t\t\t\t\t\tcontentContainer.querySelector(`[data-field=\"left-${index + 1}\"]`).value = pair.left || '';\r\n\t\t\t\t\t\t\tcontentContainer.querySelector(`[data-field=\"right-${index + 1}\"]`).value = pair.right || '';\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\tcase 'ordering':\r\n\t\t\t\t\t\tconsole.log('Ordering:', questionJSON);\r\n\t\t\t\t\t\tcontentContainer.querySelector('[data-field=\"order-start\"]').value = questionJSON.extra.startLabel || '';\r\n\t\t\t\t\t\tcontentContainer.querySelector('[data-field=\"order-end\"]').value = questionJSON.extra.endLabel || '';\r\n\t\t\t\t\t\tquestionJSON.items.forEach((item, index) => {\r\n\t\t\t\t\t\t\tcontentContainer.querySelectorAll('[data-field=\"order-item\"]')[index].value = item || '';\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\tcase 'hotspot':\r\n\t\t\t\t\t\tif (questionJSON.image) {\r\n\t\t\t\t\t\t\tconst imageSelectorPreview = contentContainer.querySelector(\".image-selector-preview\");\r\n\t\t\t\t\t\t\tif (imageSelectorPreview) {\r\n\t\t\t\t\t\t\t\timageSelectorPreview.setAttribute('src', questionJSON.image || '');\r\n\t\t\t\t\t\t\t\tconsole.log('createQuizFromJSON.setAttribute:answer:', questionJSON.answer);\r\n\t\t\t\t\t\t\t\timageSelectorPreview.setAttribute('answer', JSON.stringify(questionJSON.answer));\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tcontentContainer.querySelector('[data-field=\"hotspot-x\"]').value = questionJSON.answer.x || '';\r\n\t\t\t\t\t\tcontentContainer.querySelector('[data-field=\"hotspot-y\"]').value = questionJSON.answer.y || '';\r\n\t\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\tcase 'point-it-out':\r\n\t\t\t\t\t\tif (questionJSON.image) {\r\n\t\t\t\t\t\t\tconst imageSelectorPreview = contentContainer.querySelector(\".image-selector-preview\");\r\n\t\t\t\t\t\t\tif (imageSelectorPreview) {\r\n\t\t\t\t\t\t\t\timageSelectorPreview.setAttribute('src', questionJSON.image || '');\r\n\t\t\t\t\t\t\t\timageSelectorPreview.setAttribute('answer', JSON.stringify(questionJSON.answer));\r\n\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tcontentContainer.querySelector('[data-field=\"point-it-out-startx\"]').value = questionJSON.answer.start.x || '';\r\n\t\t\t\t\t\tcontentContainer.querySelector('[data-field=\"point-it-out-starty\"]').value = questionJSON.answer.start.y || '';\r\n\t\t\t\t\t\tcontentContainer.querySelector('[data-field=\"point-it-out-endx\"]').value = questionJSON.answer.end.x || '';\r\n\t\t\t\t\t\tcontentContainer.querySelector('[data-field=\"point-it-out-endy\"]').value = questionJSON.answer.end.y || '';\r\n\t\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\tcase 'draw':\r\n\t\t\t\t\t\tcontentContainer.querySelector('[data-field=\"answer\"]').value = questionJSON.answer || '';\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\t// Start with all rounds and questions collapsed (all details children of main quiz summary element)\r\n\t\t// const allDetails = summaryElement.querySelectorAll('details');\r\n\t\t// allDetails.forEach(detail => {\r\n\t\t// \tdetail.removeAttribute('open');\r\n\t\t// });\r\n\t\t// Ensure all rounds and questions are collapsed when loading from JSON\r\n\t\tdocument.querySelectorAll('.round, .question').forEach(element => {\r\n\t\t\telement.removeAttribute('open');\r\n\t\t});\r\n\t\taddRoundQuestionNumbers();\r\n\r\n\t\t// Hide the quiz list and show the quiz\r\n\t\tdocument.getElementById('button-panel').style.display = 'none';\r\n\t\tdocument.getElementById('quiz-list').style.display = 'none';\r\n\t\tdocument.getElementById('quiz-edit').style.display = 'block';\r\n\r\n\t\t// Display any validation errors - including the summary at the top of the quiz\r\n\t\tdisplayValidationErrors(quizJSON.validation);\r\n\r\n\t\t// Set up change tracking after quiz is loaded\r\n\t\tsetupChangeTracking();\r\n\t\tresetSaveChanges();\r\n\t}\r\n\r\n\tfunction backToQuizList() {\r\n\r\n\t\t// We can just fetch the quiz list from the server and it will automatically switch to quiz list display\r\n\t\tfetchQuizzes();\r\n\t}\r\n\r\n\r\n\tfunction setupChangeTracking() {\r\n\r\n\t\t// Remove any existing listeners from the document\r\n\t\tdocument.removeEventListener('change', handleFormChanges);\r\n\t\tdocument.removeEventListener('click', handleButtonClicks);\r\n\r\n\t\t// Add single listeners using event delegation\r\n\t\tdocument.addEventListener('change', handleFormChanges);\r\n\t\tdocument.addEventListener('click', handleButtonClicks);\r\n\t}\r\n\r\n\tfunction handleFormChanges(event) {\r\n\t\t// Check if the event came from a form element we care about\r\n\t\tconsole.log('handleFormChanges:', event.target);\r\n\t\tif (event.target.matches('input, textarea, select')) {\r\n\t\t\tmarkAsChanged();\r\n\t\t}\r\n\t}\r\n\r\n\tfunction handleButtonClicks(event) {\r\n\t\t// Check if the event came from a button we care about\r\n\t\tif (event.target.matches('.add-round-btn, .add-question-btn, .delete-btn')) {\r\n\t\t\tmarkAsChanged();\r\n\t\t}\r\n\t}\r\n\r\n\r\n\t// Reset change tracking after save\r\n\tfunction resetSaveChanges() {\r\n\t\thasUnsavedChanges = false;\r\n\t\tupdateSaveButton();\r\n\t}\r\n\r\n\r\n\t// Mark quiz as changed\r\n\tfunction markAsChanged() {\r\n\t\tconsole.log('markAsChanged called...');\r\n\t\thasUnsavedChanges = true;\r\n\t\tupdateSaveButton();\r\n\t}\r\n\r\n\t// Update save button to indicate unsaved changes\r\n\tfunction updateSaveButton() {\r\n\t\tconst saveButton = document.getElementById('save-quiz');\r\n\t\tif (hasUnsavedChanges) {\r\n\t\t\tsaveButton.classList.add('unsaved-changes');\r\n\t\t} else {\r\n\t\t\tsaveButton.classList.remove('unsaved-changes');\r\n\t\t}\r\n\t}\r\n\r\n\r\n});\r\n\r\n"],"names":["ImageSelector","HTMLElement","constructor","super","this","_image","_canvas","_ctx","_isDrawing","_isMoving","_startX","_startY","_mode","_answer","_src","_connected","_resizeObserver","ResizeObserver","_handleResize","bind","_scale","_offsetX","_offsetY","observedAttributes","connectedCallback","console","log","isConnected","render","setupCanvas","observe","setupEventListeners","disconnectedCallback","unobserve","attributeChangedCallback","name","oldValue","newValue","setImage","JSON","parse","_redrawCanvas","innerHTML","getAttribute","querySelector","getContext","onload","imageAspectRatio","naturalWidth","naturalHeight","containerWidth","parentElement","clientWidth","containerHeight","clientHeight","imageWidth","imageHeight","width","height","style","left","top","_adjustCanvasSize","addEventListener","handlePointerDown","handlePointerMove","handlePointerUp","e","preventDefault","handleTouchStart","handleTouchEnd","handleWheel","event","x","y","clientToCanvas","clientX","clientY","_touchStart","diffX","diffY","updateTransform","drawRect","canvasPos","imagePos","clientToImage","containerPos","clientToContainer","drawCross","selection","canvasToNormalized","leftX","Math","min","rightX","max","topY","bottomY","start","end","dispatchEvent","CustomEvent","detail","touches","length","_lastTouchDistance","getTouchDistance","_isZooming","touch","handleTouchMove","currentDistance","scaleDiff","midX","midY","mouseX","mouseY","containerX","containerY","newScale","hypot","x1","y1","x2","y2","fillStyle","clearRect","fillRect","crossSize","strokeStyle","lineWidth","beginPath","moveTo","lineTo","stroke","zoomFactor","deltaY","transform","src","renderImage","setCursorType","classList","remove","add","complete","rect","getBoundingClientRect","window","innerWidth","normalizedToCanvas","startCanvasPos","endCanvasPos","imageX","imageY","imageToCanvas","image","imageToContainer","scaleX","scaleY","round","customElements","define","FileDropzone","options","element","accept","multiple","maxSize","onDrop","onError","hoverClass","document","fileInput","createElement","type","display","appendChild","init","error","target","click","handleFiles","files","stopPropagation","dataTransfer","validFiles","Array","from","filter","file","size","triggerError","acceptTypes","split","map","trim","fileType","fileExtension","pop","some","startsWith","toLowerCase","endsWith","typeGroup","value","message","ImageLibrary","onSelect","modalTitle","selectedImage","createModal","modal","className","body","initEventListeners","initDropzone","close","imageItem","closest","id","dataset","url","uploadImage","show","loadImages","grid","response","fetch","result","json","success","renderImages","data","images","forEach","item","_id","originalName","querySelectorAll","btn","handleImageDelete","imageId","confirm","method","alert","formData","FormData","append","currentContent","hasUnsavedChanges","returnValue","roundsContainer","getElementById","createQuizFromJSON","title","description","rounds","quizID","location","href","addRoundToDOM","updateHeaderWithTitle","async","text","quizJSON","importQuizFromFile","schemaVersion","owner","roundElement","roundTimer","showAnswer","updateScores","questions","questionElement","baseData","audio","answer","pairs","items","extra","option","numValue","Number","index","right","pair","startLabel","endLabel","input","gatherQuestionData","createJSONfromQuiz","textContent","stringify","validation","validateQuizSchema","valid","displayValidationErrors","errors","saveQuizElement","headers","saveQuizTimeout","setTimeout","clearTimeout","fetchQuizzes","Error","quizzes","quizItemTemplate","quizList","quiz","quizItemElement","content","cloneNode","confirmed","quizId","deleteQuiz","createQuizList","addCollapseAll","summaryElement","details","parentNode","hasAttribute","removeAttribute","questionsContainer","addQuestionButton","addQuestionToDOM","Sortable","animation","handle","group","scroll","scrollSensitivity","onSort","evt","addRoundQuestionNumbers","container","questionNumber","children","questionTypeChangeListener","handleQuestionTypeChange","handleExternalImageURL","contentContainer","questionType","questionHint","questionImage","imageSelectorSelection","setImageSelectorSrc","questionIndex","imageSelectorPreviews","imageSelectorPreview","setAttribute","improveValidationErrorMessage","originalMessage","path","instancePath","pathParts","includes","roundIndex","parseInt","indexOf","questionData","question","property","match","correctOption","validationResults","errorSummary","el","count","clearValidationErrors","roundErrors","questionErrors","errorCount","shift","quizElement","errorElement","header","insertBefore","nextSibling","titleInput","displayQuizError","push","summary","displayRoundError","field","fieldElement","textInput","answerInput","displayQuestionError","Object","keys","indicator","addRoundErrorIndicator","addQuestionErrorIndicator","ok","status","statusText","validateQuizStructure","isArray","normalizeQuizData","table","populateQuizWithData","roundJSON","lastElementChild","questionJSON","typeSelect","Event","String","removeEventListener","handleFormChanges","handleButtonClicks","updateSaveButton","matches","markAsChanged","saveButton","imagePreview","imageUrlField","contains","elementToRemove","roundId","msg","transition","backgroundColor"],"mappings":"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"}